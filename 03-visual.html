<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Visualization for Social Data Science - 3&nbsp; Visualization Fundamentals</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./04-explore.html" rel="next">
<link href="./02-data.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script src="site_libs/kePrint-0.0.1/kePrint.js"></script><link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./03-visual.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Visualization Fundamentals</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Visualization for Social Data Science</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/vis4sds/vis4sds/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data Fundamentals</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-visual.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Visualization Fundamentals</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-explore.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Exploratory Data Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-network.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Geographic Networks</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-model.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-uncertainty.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Uncertainty</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-storytelling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Visual Storytelling</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./a1-tasks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Task Answers</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./a2-references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">3.1</span> Introduction</a></li>
  <li>
<a href="#concepts" id="toc-concepts" class="nav-link" data-scroll-target="#concepts"><span class="header-section-number">3.2</span> Concepts</a>
  <ul class="collapse">
<li><a href="#sec-effective" id="toc-sec-effective" class="nav-link" data-scroll-target="#sec-effective"><span class="header-section-number">3.2.1</span> Effective data graphics</a></li>
  <li><a href="#sec-grammar" id="toc-sec-grammar" class="nav-link" data-scroll-target="#sec-grammar"><span class="header-section-number">3.2.2</span> Grammar of Graphics</a></li>
  <li><a href="#marks-and-visual-channels" id="toc-marks-and-visual-channels" class="nav-link" data-scroll-target="#marks-and-visual-channels"><span class="header-section-number">3.2.3</span> Marks and visual channels</a></li>
  <li><a href="#evaluating-designs" id="toc-evaluating-designs" class="nav-link" data-scroll-target="#evaluating-designs"><span class="header-section-number">3.2.4</span> Evaluating designs</a></li>
  <li><a href="#symbolisation" id="toc-symbolisation" class="nav-link" data-scroll-target="#symbolisation"><span class="header-section-number">3.2.5</span> Symbolisation</a></li>
  <li><a href="#colour" id="toc-colour" class="nav-link" data-scroll-target="#colour"><span class="header-section-number">3.2.6</span> Colour</a></li>
  </ul>
</li>
  <li>
<a href="#sec-techniques" id="toc-sec-techniques" class="nav-link" data-scroll-target="#sec-techniques"><span class="header-section-number">3.3</span> Techniques</a>
  <ul class="collapse">
<li><a href="#import" id="toc-import" class="nav-link" data-scroll-target="#import"><span class="header-section-number">3.3.1</span> Import</a></li>
  <li><a href="#summarise" id="toc-summarise" class="nav-link" data-scroll-target="#summarise"><span class="header-section-number">3.3.2</span> Summarise</a></li>
  <li><a href="#plot-distributions" id="toc-plot-distributions" class="nav-link" data-scroll-target="#plot-distributions"><span class="header-section-number">3.3.3</span> Plot distributions</a></li>
  <li><a href="#plot-ranksmagnitudes" id="toc-plot-ranksmagnitudes" class="nav-link" data-scroll-target="#plot-ranksmagnitudes"><span class="header-section-number">3.3.4</span> Plot ranks/magnitudes</a></li>
  <li><a href="#plot-relationships" id="toc-plot-relationships" class="nav-link" data-scroll-target="#plot-relationships"><span class="header-section-number">3.3.5</span> Plot relationships</a></li>
  <li><a href="#plot-geography" id="toc-plot-geography" class="nav-link" data-scroll-target="#plot-geography"><span class="header-section-number">3.3.6</span> Plot geography</a></li>
  </ul>
</li>
  <li><a href="#conclusions" id="toc-conclusions" class="nav-link" data-scroll-target="#conclusions"><span class="header-section-number">3.4</span> Conclusions</a></li>
  <li><a href="#further-reading" id="toc-further-reading" class="nav-link" data-scroll-target="#further-reading"><span class="header-section-number">3.5</span> Further Reading</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title"><span id="sec-visual" class="quarto-section-identifier"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Visualization Fundamentals</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><script defer="" src="./fontawesome.min.js"></script><p>By the end of this chapter you should gain the following knowledge and practical skills.</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Knowledge outcomes
</div>
</div>
<div class="callout-body-container callout-body">
<ul class="task-list">
<li><label><input type="checkbox">Recognise the characteristics of effective data graphics.</label></li>
<li><label><input type="checkbox">Understand that there is a <em>grammar</em> of graphics, and that this grammar underpins modern visualization toolkits (ggplot2, vega-lite and Tableau).</label></li>
<li><label><input type="checkbox">Appreciate how visual channels and knowledge of their encoding effectiveness can be used to design and evaluate data graphics.</label></li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Skills outcomes
</div>
</div>
<div class="callout-body-container callout-body">
<ul class="task-list">
<li><label><input type="checkbox">Write ggplot2 code to generate statistical graphics (histograms, bar charts, scatterplots, choropleth maps).</label></li>
<li><label><input type="checkbox">Update that code to <em>layer</em> graphics with multiple variables.</label></li>
<li><label><input type="checkbox">Write code to manipulate the order and colour of data items in statistical graphics.</label></li>
<li><label><input type="checkbox">Advanced: create glyphmaps in ggplot2 by writing code that works on shape primitives.</label></li>
<li><label><input type="checkbox">(Very) Advanced: create dot-density maps in ggplot2 using re-sampling and functional programming.</label></li>
</ul>
</div>
</div>
<section id="introduction" class="level2" data-number="3.1"><h2 data-number="3.1" class="anchored" data-anchor-id="introduction">
<span class="header-section-number">3.1</span> Introduction</h2>
<p>This chapter outlines the fundamentals of visualization design. It offers a position on what effective data graphics should do, before discussing the processes that take place when creating data graphics. A framework – a vocabulary and grammar – for supporting this process is presented which, combined with established knowledge on visual perception, helps describe, evaluate and create effective data graphics. Talking about a vocabulary and grammar of data and graphics may sound somewhat abstract. However, through an analysis of 2019 General Election results data, the chapter will demonstrate how these concepts are fundamental to visual data analysis.</p>
<!-- ::: {.callout-tip icon=false}
## Task
Watch [Miriah Meyer's](https://www.cs.utah.edu/~miriah/) TEDx talk, *Information Visualization for Scientific Discovery*, which provides an introduction to many of the concepts covered in the chapter.
::: -->
</section><section id="concepts" class="level2" data-number="3.2"><h2 data-number="3.2" class="anchored" data-anchor-id="concepts">
<span class="header-section-number">3.2</span> Concepts</h2>
<section id="sec-effective" class="level3" data-number="3.2.1"><h3 data-number="3.2.1" class="anchored" data-anchor-id="sec-effective">
<span class="header-section-number">3.2.1</span> Effective data graphics</h3>
<p></p>
<p>Data graphics take numerous forms and are used in many different ways by scientists, journalists, designers and many more. While the intentions of those producing them may vary, data graphics that are effective generally have the following characteristics:</p>
<ul>
<li>Expose complex structure, connections and comparisons that could not be achieved easily via other means;</li>
<li>Are data rich, presenting many numbers in a small space;</li>
<li>Reveal patterns at several levels of detail, from broad overview to fine structure;</li>
<li>Are concise, emphasising dimensions of a dataset without extraneous details;</li>
<li>Generate an aesthetic response, encouraging people to engage with the data or question.</li>
</ul>
<!-- Given these characteristics  --><p> Consider the data graphic in <a href="#fig-wp-map" class="quarto-xref">Figure&nbsp;<span>3.1</span></a>, which presents an analysis of the 2016 US Presidential Election, or the <em>Peaks and Valleys of Trump and Clinton’s Support</em>. The map is reproduced from an article in The Washington Post <span class="citation" data-cites="gamio_how_2016">(<a href="a2-references.html#ref-gamio_how_2016" role="doc-biblioref">Gamio and Keating 2016</a>)</span>. Included in the bottom margin is a choropleth map coloured according to party majority, more standard practice for reporting county-level voting. Gamio and Keating’s <span class="citation" data-cites="gamio_how_2016">(<a href="a2-references.html#ref-gamio_how_2016" role="doc-biblioref">2016</a>)</span> graphic is clearly <em>data rich</em>, encoding many more data items than does the standard choropleth. It is not simply the data density that makes the graphic successful, however. There are careful design choices that help <em>support comparison</em> and emphasise <em>complex structure</em>. By varying the height of triangles according to the number of votes cast, the thickness according to whether or not the result for Trump/Clinton was a landslide and rotating the map 90 degrees, the very obvious differences between metropolitan, densely populated coastal counties that voted emphatically for Clinton and the vast number of suburban, provincial town and rural counties (everywhere else) that voted for Trump, are exposed.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-wp-map" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-wp-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/03/wp_long.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-wp-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.1: Map of 2016 US presidential election results. Note that for copyright reasons this is a re-implementation in ggplot2 of Gamio and Keating’s <span class="citation" data-cites="gamio_how_2016">(<a href="a2-references.html#ref-gamio_how_2016" role="doc-biblioref">2016</a>)</span> original, which appeared in The Washington Post.
</figcaption></figure>
</div>
</div>
</div>
<p> </p>
</section><section id="sec-grammar" class="level3" data-number="3.2.2"><h3 data-number="3.2.2" class="anchored" data-anchor-id="sec-grammar">
<span class="header-section-number">3.2.2</span> Grammar of Graphics</h3>
<p></p>
<blockquote class="blockquote">
<p><span><em>Data graphics visually display measured quantities by means of the combined use of points, lines, a coordinate system, numbers, symbols, words, shading, and color.</em></span> </p>
<p><span class="citation" data-cites="tufte_visual_1983">Tufte (<a href="a2-references.html#ref-tufte_visual_1983" role="doc-biblioref">1983</a>)</span></p>
</blockquote>
<p>So the Washington Post graphic demonstrates a judicious <em>mapping</em> of data to visuals, underpinned by a close appreciation of the analysis context. The act of carefully considering how best to leverage visual systems given the available data and analysis priorities is key to designing effective data graphics. Leland Wilkinson’s <em>Grammar of Graphics</em> <span class="citation" data-cites="wilkinson_grammar_1999">(<a href="a2-references.html#ref-wilkinson_grammar_1999" role="doc-biblioref">1999</a>)</span> captures this process of turning data into visuals. Wilkinson’s <span class="citation" data-cites="wilkinson_grammar_1999">(<a href="a2-references.html#ref-wilkinson_grammar_1999" role="doc-biblioref">1999</a>)</span> thesis is that graphics can be described in a consistent way according to their structure and composition. This has obvious benefits for building visualization toolkits. If different chart types and combinations can be reduced to a common vocabulary and grammar, then the process of designing and <em>generating</em> graphics of different types can be systematised.</p>
<p>Wilkinson’s <span class="citation" data-cites="wilkinson_grammar_1999">(<a href="a2-references.html#ref-wilkinson_grammar_1999" role="doc-biblioref">1999</a>)</span> grammar separates the construction of data graphics into a series of components. Below are the components of the <em>Layered Grammar of Graphics</em> on which ggplot2 is based <span class="citation" data-cites="wickham_layered_2010">(<a href="a2-references.html#ref-wickham_layered_2010" role="doc-biblioref">Wickham 2010</a>)</span>, adapted from Wilkinson’s <span class="citation" data-cites="wilkinson_grammar_1999">(<a href="a2-references.html#ref-wilkinson_grammar_1999" role="doc-biblioref">1999</a>)</span> original work. The components in <a href="#fig-gog" class="quarto-xref">Figure&nbsp;<span>3.2</span></a> are used to assemble ggplot2 specifications. Those to highlight at this stage are in <span><span style="color:#000000;">emphasis</span></span> : the <span><span style="color:#5A91CA;font-weight:bold">data</span></span> containing the variables of interest, the <span><span style="color:#E17637;font-weight:bold">marks</span></span> used to represent data and the visual <span><span style="color:#62B743;font-weight:bold">channels</span></span> through which variables are encoded.</p>
<p></p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-gog" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-gog-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/03/gog.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-gog-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.2: Components of Wickham’s <span class="citation" data-cites="wickham_layered_2010">(<a href="a2-references.html#ref-wickham_layered_2010" role="doc-biblioref">2010</a>)</span> Layered Grammar of Graphics.
</figcaption></figure>
</div>
</div>
</div>
<p> To demonstrate this, let’s generate some scatterplots based on the 2019 General Election data. Two variables worth exploring for association here are: <code>con_1719</code>, the change in Conservative vote share by constituency between 2017-2019, and <code>leave_hanretty</code>, the size of the Leave vote in the 2016 EU referendum, estimated at Parliamentary Constituency level <span class="citation" data-cites="hanretty_areal_2017">(via <a href="a2-references.html#ref-hanretty_areal_2017" role="doc-biblioref">Hanretty 2017</a>)</span>.</p>
<p>In <a href="#fig-gog-demo" class="quarto-xref">Figure&nbsp;<span>3.3</span></a> are three plots, accompanied by ggplot2 specifications used to generate them. Reading the graphics and the associated code, you should get a feel for how ggplot2 specifications are constructed:</p>
<ol type="1">
<li>Start with a data frame, in this case 2019 General Election results for UK Parliamentary Constituencies. The data are passed to ggplot2 (<code>ggplot()</code>) using the pipe operator (<code>|&gt;</code>). Also at this stage, we consider the variables to encode and their measurement <span><span style="color:#5A91CA;font-weight:bold">type</span></span> – both <code>con_1719</code> and <code>leave_hanretty</code> are <code>ratio</code> scale variables.</li>
<li>Next is the encoding (<code>mapping=aes()</code>), which determines how the data are to be mapped to visual <span><span style="color:#62B743;font-weight:bold">channels</span></span> . In a scatterplot, horizontal and vertical position varies in a meaningful way, in response to the values of a dataset. Here the values of <code>leave_hanretty</code> are mapped along the x-axis, and the values of <code>con_1719</code> are mapped along the y-axis.</li>
<li>Finally, we represent individual data items with <span><span style="color:#E17637;font-weight:bold">marks</span></span> using the <code>geom_point()</code> geometry.</li>
</ol>
<p>In the middle plot, the grammar is updated such that the points are coloured according to <code>winning_party</code>, a variable of type categorical <code>nominal</code>. In the bottom plot constituencies that flipped from Labour-to-Conservative between 2017-19 are emphasised by varying the <code>shape</code> (filled and not filled) and transparency (<code>alpha</code>) of points.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-gog-demo" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-gog-demo-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/03/gog_demo_redesign.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-gog-demo-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.3: Plots, grammars and underlying ggplot2 specifications for the scatterplot.
</figcaption></figure>
</div>
</div>
</div>
<!-- ![Plots, grammars and underlying ggplot2 specifications for the scatterplot.](figs/03/gog-demo.png){#fig-gog-demo width=100% fig-align="center"} -->
<!-- ::: {.callout-note}
## On ggplot2 'specifications'
It is understandable if at this stage the specifications in @fig-gog-demo still seem alien to you. We will be updating, expanding and refining ggplot2 specifications throughout the book to support all aspects of modern data analysis: from data cleaning and exploratory analysis through to model evaluation and communication.
::: -->
</section><section id="marks-and-visual-channels" class="level3" data-number="3.2.3"><h3 data-number="3.2.3" class="anchored" data-anchor-id="marks-and-visual-channels">
<span class="header-section-number">3.2.3</span> Marks and visual channels</h3>
<!-- >  Effective data visualization design is concerned with representing data through marks and visual channels in a way that best conveys the properties of the data that are to be depicted.
>
> via [Jo Wood](https://www.gicentre.net/jwo/index) -->
<p> In our descriptions <span><span style="color:#E17637;font-weight:bold">marks</span></span> was used as an alternative term for <em>geometry</em> and visual encoding <span><span style="color:#62B743;font-weight:bold">channels</span></span> as an alternative for <em>aesthetics</em>. We also paid special attention to the <span><span style="color:#5A91CA;font-weight:bold">data types</span></span> that were encoded. <em>Marks</em> are graphical elements such as <em>bars</em>, <em>lines</em>, <em>points</em> and <em>ellipses</em> that can be used to represent data items. In ggplot2 marks are accessed through the function layers prefaced with <code>geom_*()</code>. Visual <em>channels</em> are attributes such as <em>colour</em>, <em>size</em> and <em>position</em> that, when mapped to data, affect the appearance of marks in response to the values of a dataset. These attributes are controlled via the <code>aes()</code> (aesthetics) function in ggplot2.</p>
<p><em>Marks</em> and <em>channels</em> are terms used routinely in Information Visualization, an academic discipline devoted to the study of data graphics, and most notably by Tamara <span class="citation" data-cites="munzner_visualization_2014">Munzner (<a href="a2-references.html#ref-munzner_visualization_2014" role="doc-biblioref">2014</a>)</span> in her textbook <em>Visualization Analysis and Design</em>. Munzner’s <span class="citation" data-cites="munzner_visualization_2014">(<a href="a2-references.html#ref-munzner_visualization_2014" role="doc-biblioref">2014</a>)</span> work synthesises over foundational research in Information Visualization and Cognitive Science testing how effective different visual channels are at supporting specific tasks. <a href="#fig-munzner" class="quarto-xref">Figure&nbsp;<span>3.4</span></a> is adapted from <span class="citation" data-cites="munzner_visualization_2014">Munzner (<a href="a2-references.html#ref-munzner_visualization_2014" role="doc-biblioref">2014</a>)</span> and lists the main visual channels with which data might be encoded. The grouping and order of the figure is meaningful. Channels are grouped according to the tasks to which they are best suited and then ordered according to their effectiveness at supporting those tasks. The left grouping displays <em>magnitude:order</em> channels – those that are best suited to tasks aimed at quantifying data items. The right grouping displays <em>identity:category</em> channels – those that are most suited to supporting tasks that involve isolating and associating data items.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-munzner" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-munzner-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/03/munzner_effect_trans.png" class="img-fluid figure-img" style="width:65.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-munzner-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.4: Visual channels to which data items can be encoded, adapted from <span class="citation" data-cites="munzner_visualization_2014">Munzner (<a href="a2-references.html#ref-munzner_visualization_2014" role="doc-biblioref">2014</a>)</span>.
</figcaption></figure>
</div>
</div>
</div>
<p> </p>
</section><section id="evaluating-designs" class="level3" data-number="3.2.4"><h3 data-number="3.2.4" class="anchored" data-anchor-id="evaluating-designs">
<span class="header-section-number">3.2.4</span> Evaluating designs</h3>
<p></p>
<p>The effectiveness rankings of visual channels in <a href="#fig-munzner" class="quarto-xref">Figure&nbsp;<span>3.4</span></a> are not simply based on Munzner’s preference. They are informed by detailed experimental work by <span class="citation" data-cites="cleveland_graphical_1984">Cleveland and McGill (<a href="a2-references.html#ref-cleveland_graphical_1984" role="doc-biblioref">1984</a>)</span>, later replicated by <span class="citation" data-cites="heer_crowdsourcing_2010">Heer and Bostock (<a href="a2-references.html#ref-heer_crowdsourcing_2010" role="doc-biblioref">2010</a>)</span>, which involved conducting controlled experiments testing people’s ability to make judgements from graphical elements. We can use <a href="#fig-munzner" class="quarto-xref">Figure&nbsp;<span>3.4</span></a> to help make decisions around which data item to encode with which visual channel. This is particularly useful when designing data-rich graphics, where several data items are to be encoded simultaneously. <a href="#fig-munzner" class="quarto-xref">Figure&nbsp;<span>3.4</span></a> also offers a low cost way of <em>evaluating</em> different designs against their encoding effectiveness.</p>
<p> </p>
<p>To illustrate this, we can use Munzner’s ranking of channels to evaluate The Washington Post graphic discussed in <a href="#fig-wp-map" class="quarto-xref">Figure&nbsp;<span>3.1</span></a>. <span><a href="#tab:wp-eval-size">Table 3.2</a></span> provides a summary of the encodings used in the graphic. US counties are represented using a peak-shaped <em>mark</em>. The key purpose of the graphic is to depict the geography of voting outcomes. The most effective quantitative channel – position on an aligned scale – is used to order the county marks with a geographic arrangement. With the positional channels taken, the two quantitative measures are encoded with the next highest ranked channel, length or 1D size: height varies according to number of <em>total votes cast</em> and width according to <em>margin size</em>. The marks are additionally encoded with two categorical variables: whether the county-level result was a <em>landslide</em> and also the <em>winning party</em>. Since the intention is to give greater visual saliency to counties that resulted in a landslide, this is an <code>ordinal</code> variable encoded with a quantitative channel: area / 2D size. The <em>winning party</em>, a categorical <code>nominal</code> variable, is encoded using colour hue.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<caption>Encoding effectiveness for Gamio and Keating’s (2016) Washington Post graphic that emphasises <em>vote margin and size</em> of counties using triangle marks.</caption>
<thead><tr class="header">
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">Data item</th>
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">Type</th>
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">Channel</th>
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">Rank</th>
</tr></thead>
<tbody>
<tr class="odd" data-grouplength="4">
<td colspan="4" style="border-bottom: 0px solid">Magnitude:Order</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em; width: 40%;" data-indentlevel="1">County location</td>
<td style="text-align: left; width: 20%; font-family: Monospace;">interval</td>
<td style="text-align: left; width: 30%;">position in x,y</td>
<td style="text-align: left;">1. quant</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em; width: 40%;" data-indentlevel="1">Total votes cast</td>
<td style="text-align: left; width: 20%; font-family: Monospace;">ratio</td>
<td style="text-align: left; width: 30%;">length</td>
<td style="text-align: left;">3. quant</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em; width: 40%;" data-indentlevel="1">Margin size</td>
<td style="text-align: left; width: 20%; font-family: Monospace;">ratio</td>
<td style="text-align: left; width: 30%;">length</td>
<td style="text-align: left;">3. quant</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em; width: 40%;" data-indentlevel="1">Is landslide</td>
<td style="text-align: left; width: 20%; font-family: Monospace;">ordinal</td>
<td style="text-align: left; width: 30%;">area</td>
<td style="text-align: left;">5. quant</td>
</tr>
<tr class="even" data-grouplength="1">
<td colspan="4" style="border-bottom: 0px solid">Identity:Category</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em; width: 40%;" data-indentlevel="1">Winning party</td>
<td style="text-align: left; width: 20%; font-family: Monospace;">nominal</td>
<td style="text-align: left; width: 30%;">colour hue</td>
<td style="text-align: left;">2. cat</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Each of the encoding choices follow conventional wisdom in that data items are encoded using visual channels appropriate to their measurement level. Glancing down the “rank” column, the graphic has high effectiveness. While technically <em>spatial region</em> is the most effective channel for encoding <code>nominal</code> data, it is already in use as the marks are arranged by geographic position. Additionally, it makes sense to distinguish <span><span style="color:#DB534D;font-weight:bold">Republican</span></span> and <span><span style="color:#3879A1;font-weight:bold">Democrat</span></span> wins using the colours with which they are always represented. Given the fact that the positional channels represent geographic <em>location</em>, length to represent <em>votes cast</em> and <em>vote margin</em>, the only superior visual channel to 2D area that could be used to encode the <em>landslide</em> variable is <em>orientation</em>. There are very good reasons for not varying the orientation of the arrow marks. Most obvious is that this would undermine perception of length encodings used to represent the vote margin (width) and absolute vote size (height).</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Visualization design and trade-offs
</div>
</div>
<div class="callout-body-container callout-body">
<p> Data visualization design almost always involves trade-offs. A general principle is to identify and prioritise data and analysis tasks, then match the most effective encodings to the data and tasks that have the greatest priority. Less important data items and tasks therefore get less effective encodings. In practice, visualization design involves exercising more creative thinking – it is sometimes preferable to defy convensional wisdom in order to provoke some desired response. Either way, good visualization design is sensitive to this interplay between tasks, data and encoding.</p>
</div>
</div>
</section><section id="symbolisation" class="level3" data-number="3.2.5"><h3 data-number="3.2.5" class="anchored" data-anchor-id="symbolisation">
<span class="header-section-number">3.2.5</span> Symbolisation</h3>
<p></p>
<blockquote class="blockquote">
<p><span><em>Symbolization is the process of encoding something with meaning in order to represent something else. Effective symbol design requires that the relationship between a symbol and the information that symbol represents (the referent) be clear and easily interpreted.</em></span> </p>
<p><span class="citation" data-cites="white_symbolization_2017">White (<a href="a2-references.html#ref-white_symbolization_2017" role="doc-biblioref">2017</a>)</span></p>
</blockquote>
<p>Implicit in the discussion above, and when making design decisions, is the importance of <em>symbolisation</em>. From the original Washington Post article, the overall pattern that can be discerned is of population-dense coastal and metropolitan counties voting Democrat – densely-packed, tall, wide and blue <span><i style="color:#3879A1;font-weight:bold" class="fas fa-lg fa-angle-up"></i></span> marks – contrasted with population-sparse rural and small town areas voting Republican – short, wide and red <span><i style="color:#DB534D;font-weight:bold" class="fas fa-angle-up"></i></span> marks. The graphic evokes a distinctive landscape of voting behaviour, emphasised by its caption: “<em>The peaks and valleys of Trump and Clinton’s support</em>”.</p>
<p> <em>Symbolisation</em> is used equally well in a variant of the graphic emphasising two-party <em>Swing</em> between the 2012 and 2016 elections (<a href="#fig-wp-swing" class="quarto-xref">Figure&nbsp;<span>3.5</span></a>). Each county is represented as a <span><span style="font-weight:bolder">|</span></span> mark. The <em>Swing</em> variable is then encoded by continuously varying mark angles: counties swinging <span><span style="color:#DB534D;font-weight:bold">Republican</span></span> are angled to the right <span><span style="color:#DB534D;font-weight:bolder">/</span></span> ; counties swinging <span><span style="color:#3879A1;font-weight:bold">Democrat</span></span> are angled to the left <span><span style="color:#3879A1;font-weight:bolder">\</span></span> . Although <em>angle</em> is a less effective channel at encoding quantities than is <em>length</em>, there are obvious links to the political phenomena in the symbolisation – angled right for counties that moved to the right politically. There are further useful properties in this example. Since county voting is spatially auotocorrelated, we quickly assemble from the graphic dominant patterns of Swing to the Republicans (Great Lakes, rural East Coast), predictable Republican stasis (the Midwest) and more isolated, locally exceptional swings to the Democrats (rapidly urbanising counties in the deep South).</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-wp-swing" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-wp-swing-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/03/wp_spoke.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-wp-swing-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.5: Map of swing in 2016 US presidential election results. Note that for copyright reasons this is a re-implementation in ggplot2 of Gamio and Keating’s <span class="citation" data-cites="gamio_how_2016">(<a href="a2-references.html#ref-gamio_how_2016" role="doc-biblioref">2016</a>)</span> original, which appeared in The Washington Post.
</figcaption></figure>
</div>
</div>
</div>
<p> </p>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task 1
</div>
</div>
<div class="callout-body-container callout-body">
<p> </p>
<p>Complete the description table below to identify each <em>data item</em> encoded in <a href="#fig-wp-swing" class="quarto-xref">Figure&nbsp;<span>3.5</span></a> along with its <em>measurement level</em>, <em>visual mark</em> and <em>visual channel</em> and the effectiveness rank of this encoding, according to <span class="citation" data-cites="munzner_visualization_2014">Munzner (<a href="a2-references.html#ref-munzner_visualization_2014" role="doc-biblioref">2014</a>)</span>.</p>
<table class="table">
<colgroup>
<col style="width: 23%">
<col style="width: 23%">
<col style="width: 17%">
<col style="width: 19%">
<col style="width: 17%">
</colgroup>
<thead><tr class="header">
<th>Data item</th>
<th>Measurement level</th>
<th>Visual mark</th>
<th>Visual channel</th>
<th>Rank</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>County location</code></td>
<td><code>&lt;enter here&gt;</code></td>
<td><code>&lt;enter here&gt;</code></td>
<td><code>&lt;enter here&gt;</code></td>
<td><code>&lt;enter here&gt;</code></td>
</tr>
<tr class="even">
<td><code>...</code></td>
<td><code>...</code></td>
<td><code>...</code></td>
<td><code>...</code></td>
<td><code>...</code></td>
</tr>
<tr class="odd">
<td><code>...</code></td>
<td><code>...</code></td>
<td><code>...</code></td>
<td><code>...</code></td>
<td><code>...</code></td>
</tr>
<tr class="even">
<td><code>...</code></td>
<td><code>...</code></td>
<td><code>...</code></td>
<td><code>...</code></td>
<td><code>...</code></td>
</tr>
<tr class="odd">
<td><code>...</code></td>
<td><code>...</code></td>
<td><code>...</code></td>
<td><code>...</code></td>
<td><code>...</code></td>
</tr>
<tr class="even">
<td><code>...</code></td>
<td><code>...</code></td>
<td><code>...</code></td>
<td><code>...</code></td>
<td><code>...</code></td>
</tr>
</tbody>
</table>
</div>
</div>
</section><section id="colour" class="level3" data-number="3.2.6"><h3 data-number="3.2.6" class="anchored" data-anchor-id="colour">
<span class="header-section-number">3.2.6</span> Colour</h3>
<p></p>
<p>Colour is a very powerful visual channel. When considering how to encode data with colour, it is helpful to consider three properties:</p>
<ul>
<li>
<em>Hue</em>: what we generally refer to as “colour” in everyday life – red, blue, green.</li>
<li>
<em>Saturation</em>: how much of a colour there is.</li>
<li>
<em>Luminance/Brightness</em>: how dark or light a colour is.</li>
</ul>
<p>The ultimate rule is to use these properties of colour in a way that matches the properties of the data (<a href="#fig-brewer" class="quarto-xref">Figure&nbsp;<span>3.6</span></a>). Categorical <code>nominal</code> data – data that cannot be easily ordered – should be encoded using discrete colours with no obvious order; so colour hue. Categorical <code>ordinal</code> data – data whose categories can be ordered – should be encoded with colours that contain an intrinsic order; saturation or brightness (colour value) allocated into perceptually-spaced gradients. <code>Quantitative</code> data – data that can be ordered and contain values on a continuous scale – should also be encoded with saturation or brightness, expressed on a continuous scale. As we will discover shortly, these principles are applied by default in ggplot2, along with access to perceptually valid schemes <span class="citation" data-cites="harrower_colorbrewerorg_2003">(e.g. <a href="a2-references.html#ref-harrower_colorbrewerorg_2003" role="doc-biblioref">Harrower and Brewer 2003</a>)</span>.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-brewer" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-brewer-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/03/brewer_colour.png" class="img-fluid figure-img" style="width:70.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-brewer-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.6: Colour schemes matched to variable measurement level.
</figcaption></figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
On colour
</div>
</div>
<div class="callout-body-container callout-body">
<p>There are very many considerations when using colour to support visual data analysis and communication – more than we have space for in this chapter. Lisa Charotte-Muth’s <span class="citation" data-cites="muth_your_2018">(<a href="a2-references.html#ref-muth_your_2018" role="doc-biblioref">2018</a>)</span> <em>Guide to Colours in Data Visualization</em><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> is an excellent outline of the decision-space.</p>
</div>
</div>
<p></p>
</section></section><section id="sec-techniques" class="level2" data-number="3.3"><h2 data-number="3.3" class="anchored" data-anchor-id="sec-techniques">
<span class="header-section-number">3.3</span> Techniques</h2>
<p>The technical component to this chapter analyses data from the 2019 UK General Election, reported at Parliamentary Constituency level. After importing and describing the dataset, we will generate data graphics that expose patterns in voting behaviour.</p>
<ul>
<li>Download the <code>03-template.qmd</code><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> file for this chapter and save it to your <code>vis4sds</code> project.</li>
<li>Open your <code>vis4sds</code> project in RStudio and load the template file by clicking <code>File</code> &gt; <code>Open File ...</code> &gt; <code>03-template.qmd</code>.</li>
</ul>
<section id="import" class="level3" data-number="3.3.1"><h3 data-number="3.3.1" class="anchored" data-anchor-id="import">
<span class="header-section-number">3.3.1</span> Import</h3>
<p> </p>
<p>The template file lists the required packages – <code>tidyverse</code> and <code>sf</code> – and links to the 2019 UK General Election dataset, stored on the book’s accompanying data repository. These data were initially collected via the <code>parlitools</code> R package, which is no longer maintained.</p>
<p>The data frame of 2019 UK General Election data is called <code>bes_2019</code>. This stores results data released by the House of Commons Library <span class="citation" data-cites="uberoi_general_2020">(<a href="a2-references.html#ref-uberoi_general_2020" role="doc-biblioref">Uberoi, Baker, and Cracknell 2020</a>)</span>. We can get a quick overview with a call to <code>glimpse(&lt;dataset-name&gt;)</code>. <code>bes_2019</code> has 650 rows, one for each parliamentary constituency, and 118 columns. In the columns are variables reporting vote numbers and shares for the main political parties for the 2019 and 2017 General Elections, as well as names and codes (<code>ID</code>s) for each constituency and the local authority, region and country in which they are contained.</p>
<p> We will replicate some of the visual data analysis in <span class="citation" data-cites="beecham_using_2020">Beecham (<a href="a2-references.html#ref-beecham_using_2020" role="doc-biblioref">2020</a>)</span>. For this we need to calculate an additional variable, Butler Swing <span class="citation" data-cites="butler_why_1990">(<a href="a2-references.html#ref-butler_why_1990" role="doc-biblioref">Butler and Van Beek 1990</a>)</span>: the average change in share of the vote won by two parties contesting successive elections. Code for calculating this variable, named <code>swing_con_lab</code>, is in the <code>03-template.qmd</code>. The only other dataset to load is a <code>.geojson</code> file containing simplified geometries of constituencies, originally from ONS Open Geography Portal. This is a special class of data frame containing a Simple Features <span class="citation" data-cites="pebesma_simple_2018">(<a href="a2-references.html#ref-pebesma_simple_2018" role="doc-biblioref">Pebesma 2018</a>)</span> <code>geometry</code> column.</p>
</section><section id="summarise" class="level3" data-number="3.3.2"><h3 data-number="3.3.2" class="anchored" data-anchor-id="summarise">
<span class="header-section-number">3.3.2</span> Summarise</h3>
<p>You may be familiar with the result of the 2019 General Election, a landslide Conservative victory that confounded expectations. To start, we can quickly compute some summary statistics around the vote. In the code below, we count the number of seats won and overall vote share by party. For the vote share calculation, the code is a little more elaborate than we might wish at this stage. We need to reshape the data frame using <code>pivot_wider()</code> such that each row represents a vote for a party in a constituency. From here the vote share for each party can be easily computed. </p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Number of constituencies won by party.</span></span>
<span><span class="va">bes_2019</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">winner_19</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">summarise</span><span class="op">(</span>count<span class="op">=</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 11 x 2</span></span>
<span><span class="co">##    winner_19                        count</span></span>
<span><span class="co">##    &lt;chr&gt;                            &lt;int&gt;</span></span>
<span><span class="co">##  1 Conservative                       365</span></span>
<span><span class="co">##  2 Labour                             202</span></span>
<span><span class="co">##  3 Scottish National Party             48</span></span>
<span><span class="co">##  4 Liberal Democrat                    11</span></span>
<span><span class="co">##  5 Democratic Unionist Party            8</span></span>
<span><span class="co">##  6 Sinn Fein                            7</span></span>
<span><span class="co">##  7 Plaid Cymru                          4</span></span>
<span><span class="co">##  8 Social Democratic &amp; Labour Party     2</span></span>
<span><span class="co">##  9 Alliance                             1</span></span>
<span><span class="co">## 10 Green                                1</span></span>
<span><span class="co">## 11 Speaker                              1</span></span>
<span></span>
<span><span class="co"># Share of vote by party.</span></span>
<span><span class="va">bes_2019</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Select cols containing vote counts by party.</span></span>
<span>  <span class="fu">select</span><span class="op">(</span></span>
<span>    <span class="va">constituency_name</span>, <span class="va">total_vote_19</span>, </span>
<span>    <span class="va">con_vote_19</span><span class="op">:</span><span class="va">alliance_vote_19</span>, <span class="va">region</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Pivot to make each row a vote for a party in a constituency.</span></span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span></span>
<span>    cols<span class="op">=</span><span class="va">con_vote_19</span><span class="op">:</span><span class="va">alliance_vote_19</span>, </span>
<span>    names_to<span class="op">=</span><span class="st">"party"</span>, values_to<span class="op">=</span><span class="st">"votes"</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Use some regex to pull out party name.</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>party<span class="op">=</span><span class="fu">str_extract</span><span class="op">(</span><span class="va">party</span>, <span class="st">"[^_]+"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Summarise over parties.</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">party</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Calculate vote share for each party.</span></span>
<span>  <span class="fu">summarise</span><span class="op">(</span>vote_share<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">votes</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">total_vote_19</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Arrange parties descending on vote share.</span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">vote_share</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## # A tibble: 12 x 2</span></span>
<span><span class="co">##    party    vote_share</span></span>
<span><span class="co">##    &lt;chr&gt;         &lt;dbl&gt;</span></span>
<span><span class="co">##  1 con         0.436</span></span>
<span><span class="co">##  2 lab         0.321</span></span>
<span><span class="co">##  3 ld          0.115</span></span>
<span><span class="co">##  4 snp         0.0388</span></span>
<span><span class="co">##  5 green       0.0270</span></span>
<span><span class="co">##  6 brexit      0.0201</span></span>
<span><span class="co">##  7 dup         0.00763</span></span>
<span><span class="co">##  8 sf          0.00568</span></span>
<span><span class="co">##  9 pc          0.00479</span></span>
<span><span class="co">## 10 alliance    0.00419</span></span>
<span><span class="co">## 11 sdlp        0.00371</span></span>
<span><span class="co">## 12 uup         0.00291</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>While the Conservative party held 56% of constituencies in 2019 election, they won only 44% of the vote. The equivalent figures for Labour were 31% and 32% respectively. And although the Conservatives gained many more constituencies than they did in 2017 (when they won just 317, 49% of constituencies) their vote share hardly shifted between those elections – in 2017 the Conservative vote share was 43%. This fact is interesting as it may suggest some movement in where the Conservative party gained its majorities in 2019.</p>
<p>Below are some summary statistics computed over the newly created <code>swing_con_lab</code> variable. As the Conservative and Labour votes are negligible in Northern Ireland, it makes sense to focus on Great Britain for our analysis of Conservative-Labour Swing, and so the first step in the code is to create a new data frame filtering out Northern Ireland.</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_gb</span> <span class="op">&lt;-</span> <span class="va">bes_2019</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">region</span> <span class="op">!=</span> <span class="st">"Northern Ireland"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Also recode to 0 Chorley and Buckingham, incoming/outgoing speaker.</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    swing_con_lab<span class="op">=</span><span class="fu">if_else</span><span class="op">(</span></span>
<span>      <span class="va">constituency_name</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Chorley"</span>, <span class="st">"Buckingham"</span><span class="op">)</span>, <span class="fl">0</span>,</span>
<span>      <span class="fl">0.5</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">con_19</span><span class="op">-</span><span class="va">con_17</span><span class="op">)</span><span class="op">-</span><span class="op">(</span><span class="va">lab_19</span><span class="op">-</span><span class="va">lab_17</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">data_gb</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">summarise</span><span class="op">(</span></span>
<span>    min_swing<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">swing_con_lab</span><span class="op">)</span>,</span>
<span>    max_swing<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">swing_con_lab</span><span class="op">)</span>,</span>
<span>    median_swing<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">swing_con_lab</span><span class="op">)</span>,</span>
<span>    num_swing<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">swing_con_lab</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span>,</span>
<span>    num_landslide_con<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">con_19</span><span class="op">&gt;</span><span class="fl">50</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    num_landslide_lab<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">lab_19</span><span class="op">&gt;</span><span class="fl">50</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="co">## # A tibble: 1 x 6</span></span>
<span><span class="co">## min_swing max_swing median_swing num_swing num_land_con num_land_lab</span></span>
<span><span class="co">##     &lt;dbl&gt;    &lt;dbl&gt;        &lt;dbl&gt;     &lt;int&gt;        &lt;int&gt;        &lt;int&gt;</span></span>
<span><span class="co">## 1   -6.47     18.4        4.44       599          280          120</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="plot-distributions" class="level3" data-number="3.3.3"><h3 data-number="3.3.3" class="anchored" data-anchor-id="plot-distributions">
<span class="header-section-number">3.3.3</span> Plot distributions</h3>
<div class="cell">
<div class="cell-output-display">
<div id="fig-hist" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-hist-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/03/hist.png" class="img-fluid figure-img" style="width:90.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-hist-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.7: Histograms of Butler two-party Labour-Conservative Swing.
</figcaption></figure>
</div>
</div>
</div>
<p>Let’s start with ggplot2 specifications by plotting some of these variables. Below is the code for plotting a histogram of the Swing variable.</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_gb</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span>mapping<span class="op">=</span><span class="fu">aes</span><span class="op">(</span><span class="va">swing_con_lab</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A reminder of the general form of a ggplot2 specification:</p>
<ol type="1">
<li>Start with some <em>data</em>: <code>data_gb</code>.</li>
<li>Define the <em>encoding</em>: <code>mapping=aes()</code> into which we pass the <code>swing_con_lab</code> variable.</li>
<li>Specify the <em>marks</em> to be used: <code>geom_histogram()</code> in this case.</li>
</ol>
<p>Different from the scatterplot example, there is more happening in the internals of ggplot2 when creating a histogram. The Swing variable is partitioned into bins, and observations in each bin are counted. The x-axis (bins) and y-axis (counts by bin) are derived from the <code>swing_con_lab</code> variable.</p>
<p> By default the histogram’s bars are given a grey colour. To <em>set</em> them to a different colour, add a <code>fill=</code> argument to <code>geom_histogram()</code>. In the code block below, colour is set using hex codes. The term <em>set</em>, not <em>map</em> or <em>encode</em>, is used for principled reasons. Any part of a ggplot2 specification that involves encoding data – mapping a data item to a visual channel – should be specified through the <code>mapping=aes()</code> argument. Anything else, for example changing the default colour, thickness and transparency of marks, needs to be <em>set</em> outside of this argument.</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_gb</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span>mapping<span class="op">=</span><span class="fu">aes</span><span class="op">(</span><span class="va">swing_con_lab</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span>fill<span class="op">=</span><span class="st">"#003c8f"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x<span class="op">=</span><span class="st">"Swing"</span>, y<span class="op">=</span><span class="st">"count"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p> You will notice that different elements of a ggplot2 specification are added (<code>+</code>) as layers. In the example above, the additional layer of labels (<code>labs()</code>) is not intrinsic to the graphic. However, often you will add layers that do affect the graphic itself. For example, the scaling of encoded values (e.g.&nbsp;<code>scale_*_continuous()</code>) or whether the graphic is to be conditioned on another variable to generate small multiples for comparison (e.g.&nbsp;<code>facet_*()</code>). Adding a call to <code>facet_*()</code>, we can compare how Swing varies by region (<a href="#fig-hist-region" class="quarto-xref">Figure&nbsp;<span>3.8</span></a>). The plot is annotated with the <em>median</em> value for Swing (4.4) by adding a vertical line layer (<code>geom_vline()</code>) set with an x-intercept at this median value. From this, there is some evidence of a regional geography to the 2019 vote: London and Scotland are distinctive in containing relatively few constituencies swinging greater than the expected midpoint; North East, Yorkshire &amp; The Humber, and to a lesser extent West and East Midlands, appear to show the largest relative number of constituencies swinging greater than the midpoint.</p>
<!-- ::: {.callout-note}
## On histograms
This design exposition by [Lunzner and McNamara, 2020](http://tinlizzie.org/histograms/) is an excellent discussion of the analysis and design considerations when working with histograms. There are of course other *geoms* for summarising over 1D distributions: `geom_boxplot()`, `geom_dotplot()`, `geom_violin()`.
::: -->
<div class="cell">
<div class="cell-output-display">
<div id="fig-hist-region" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-hist-region-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/03/hist-region.png" class="img-fluid figure-img" style="width:90.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-hist-region-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.8: Histograms of Swing variable, grouped by region.
</figcaption></figure>
</div>
</div>
</div>
<p></p>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task 2
</div>
</div>
<div class="callout-body-container callout-body">
<p>Update the earlier ggplot2 specification to produce a set of histograms of the Swing variable faceted by region, similar to that in <a href="#fig-hist-region" class="quarto-xref">Figure&nbsp;<span>3.8</span></a>.</p>
</div>
</div>
</section><section id="plot-ranksmagnitudes" class="level3" data-number="3.3.4"><h3 data-number="3.3.4" class="anchored" data-anchor-id="plot-ranksmagnitudes">
<span class="header-section-number">3.3.4</span> Plot ranks/magnitudes</h3>
<div class="cell">
<div class="cell-output-display">
<div id="fig-bars-party" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-bars-party-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/03/bars.png" class="img-fluid figure-img" style="width:80.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-bars-party-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.9: Plots of vote shares by party.
</figcaption></figure>
</div>
</div>
</div>
<p>Previously we calculated overall vote shares by political party. We could continue the exploration of votes by region, re-using this code to generate plots displaying vote shares by region, using marks and encoding channels that are suitable for magnitudes.</p>
<p>To generate a bar chart similar to <a href="#fig-bars-party" class="quarto-xref">Figure&nbsp;<span>3.9</span></a> the ggplot2 specification would be:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>data_gb <span class="sc">|&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The code block summarising vote by party.</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="er">&lt;</span>some dplyr code<span class="sc">&gt;</span> <span class="er">|&gt;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ordinal x-axis (party, reordered), Ratio y-axis (vote_share).</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span><span class="fu">reorder</span>(party, <span class="sc">-</span>vote_share), <span class="at">y=</span>vote_share)) <span class="sc">+</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill=</span><span class="st">"#003c8f"</span>) <span class="sc">+</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A quick breakdown of the specification:</p>
<ol type="1">
<li>
<em>Data</em>: This is the summarised data frame in which each row is a political party, and the column describes the vote share recorded for that party.</li>
<li>
<em>Encoding</em>: We have dropped the call to <code>mapping=</code>. ggplot2 always looks for <code>aes()</code>, and so we can save on code clutter. In this case we are mapping <code>party</code> to the x-axis, a categorical variable made ordinal by the fact that we reorder the axis left-to-right descending on <code>vote_share</code>. <code>vote_share</code> is mapped to the y-axis – so encoded using bar length on an aligned scale, an effective channel for conveying magnitudes.</li>
<li>
<em>Marks</em>: <code>geom_col()</code> for generating the bars.</li>
<li>
<em>Setting</em>: Again, we’ve set bar colour to manually selected dark blue. Optionally we add a <code>coord_flip()</code> layer in order to display the bars horizontally. This makes the category axis labels easier to read and also seems more appropriate for the visual “ranking” of bars.</li>
</ol>
<!-- ::: {.callout-note}
## ggplot2 themes
ggplot2 themes control the appearance of all non-data items -- font sizes and types, gridlines, axis labels. Checkout the complete list of ggplot2's [default themes](https://ggplot2.tidyverse.org/reference/ggtheme.html). If you like the look of the BBC's in-house data graphics, explore their [Data Journalism cookbook](https://bbc.github.io/rcookbook/), a great resource for distilling many of the non-data-related decisions to be made when communicating graphically.
::: --><section id="faceting-by-region" class="level4 unnumbered"><h4 class="unnumbered anchored" data-anchor-id="faceting-by-region">Faceting by region</h4>
<div class="cell">
<div class="cell-output-display">
<div id="fig-bars-region" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-bars-region-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/03/bars-region.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-bars-region-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.10: Plots of vote shares by party and region.
</figcaption></figure>
</div>
</div>
</div>
<p>In <a href="#fig-bars-region" class="quarto-xref">Figure&nbsp;<span>3.10</span></a> the graphic is faceted by region. This requires an updated staged dataset grouping by <code>vote_share</code> <em>and</em> <code>region</code> and of course a faceting layer (<code>geom_facet(~region)</code>). The graphic is more data-rich, and additional cognitive effort is required in relating the political party bars between different graphical subsets. We can assist this associative task by encoding parties with an appropriate visual channel: <em>colour hue</em>. The ggplot2 specification for this is as you would expect; we add a mapping to <code>geom_col()</code> and pass the variable name <code>party</code> to the fill argument (<code>aes(fill=party)</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>data_gb <span class="sc">|&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The code block summarising vote by party and also now region.</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="er">&lt;</span>some dplyr code<span class="sc">&gt;</span> <span class="er">|&gt;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># To be piped to ggplot2.</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span><span class="fu">reorder</span>(party, vote_share), <span class="at">y=</span>vote_share)) <span class="sc">+</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="fu">aes</span>(<span class="at">fill=</span>party)) <span class="sc">+</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>region)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Trying this for yourself, you will observe that the ggplot2 internals do some thinking for us. Since <code>party</code> is a categorical variable, a categorical hue-based colour scheme is automatically applied. Try passing a quantitative variable (<code>fill=vote_share</code>) to <code>geom_col()</code> and see what happens; a quantitative colour gradient scheme is applied.</p>
<p>Clever as this is, when encoding political parties with colour, <em>symbolisation</em> is important. It makes sense to represent political parties using colours with which they are most commonly associated. We can override ggplot2’s default colour by adding a <code>scale_fill_manual()</code> layer into which a vector of hex codes describing the colour of each political party is passed (<code>party_colours</code>). We also need to tell ggplot2 which element of <code>party_colours</code> to apply to which value of the <code>party</code> variable. In the code below, a staging table is generated summarising <code>vote_share</code> by political party and region. In the final line the <code>party</code> variable is recoded as a <code>factor</code>. You might recall from the last chapter that factors are categorical variables of fixed and orderable values – <code>levels</code>. The call to <code>mutate()</code> recodes <code>party</code> as a factor variable and orders the levels according to overall vote share. </p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Generate staging data.</span></span>
<span><span class="va">temp_party_shares_region</span> <span class="op">&lt;-</span> <span class="va">data_gb</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span></span>
<span>    <span class="va">constituency_name</span>, <span class="va">region</span>, <span class="va">total_vote_19</span>, </span>
<span>    <span class="va">con_vote_19</span><span class="op">:</span><span class="va">alliance_vote_19</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span></span>
<span>    cols<span class="op">=</span><span class="va">con_vote_19</span><span class="op">:</span><span class="va">alliance_vote_19</span>, </span>
<span>    names_to<span class="op">=</span><span class="st">"party"</span>, values_to<span class="op">=</span><span class="st">"votes"</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>party<span class="op">=</span><span class="fu">str_extract</span><span class="op">(</span><span class="va">party</span>, <span class="st">"[^_]+"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">party</span>, <span class="va">region</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">summarise</span><span class="op">(</span>vote_share<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">votes</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">total_vote_19</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">party</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"con"</span>, <span class="st">"lab"</span>, <span class="st">"ld"</span>, <span class="st">"snp"</span>, <span class="st">"green"</span>, <span class="st">"brexit"</span>, <span class="st">"pc"</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>party<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">party</span>,</span>
<span>        levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"con"</span>, <span class="st">"lab"</span>, <span class="st">"ld"</span>, <span class="st">"snp"</span>, <span class="st">"green"</span>, <span class="st">"brexit"</span>, <span class="st">"pc"</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, a vector of objects is created containing the hex codes for the colours of political parties (<code>party_colours</code>).</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Define colours.</span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="st">"#0575c9"</span></span>
<span><span class="va">lab</span> <span class="op">&lt;-</span> <span class="st">"#ed1e0e"</span></span>
<span><span class="va">ld</span> <span class="op">&lt;-</span> <span class="st">"#fe8300"</span></span>
<span><span class="va">snp</span> <span class="op">&lt;-</span> <span class="st">"#ebc31c"</span></span>
<span><span class="va">green</span> <span class="op">&lt;-</span> <span class="st">"#78c31e"</span></span>
<span><span class="va">pc</span> <span class="op">&lt;-</span> <span class="st">"#4e9f2f"</span></span>
<span><span class="va">brexit</span> <span class="op">&lt;-</span> <span class="st">"#25b6ce"</span></span>
<span><span class="va">other</span> <span class="op">&lt;-</span> <span class="st">"#bdbdbd"</span></span>
<span></span>
<span><span class="va">party_colours</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">con</span>, <span class="va">lab</span>, <span class="va">ld</span>, <span class="va">snp</span>, <span class="va">green</span>, <span class="va">brexit</span>, <span class="va">pc</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The ggplot2 specification is then updated with the <code>scale_fill_manual()</code> layer:</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">temp_party_shares_region</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html">reorder</a></span><span class="op">(</span><span class="va">party</span>, <span class="va">vote_share</span><span class="op">)</span>, y<span class="op">=</span><span class="va">vote_share</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_col</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill<span class="op">=</span><span class="va">party</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">party_colours</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_flip</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">region</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Grammar of Graphics-backed visualization toolkits
</div>
</div>
<div class="callout-body-container callout-body">
<p></p>
<div class="line-block">The idea behind visualization toolkits such as ggplot2 is to insert visual approaches into a data scientist’s workflow. Rather than being overly concerned with low-level aspects of drawing, mapping data values to screen coordinates and scaling factors, you instead focus on aspects relevant to the analysis – the variables in a dataset and how they will be encoded and conditioned using visuals. Hadley Wickham talks about a grammar of <em>interactive</em> data analysis, whereby <code>dplyr</code> functions are used to rapidly prepare data for charting before being piped (<code>|&gt;</code>) to ggplot2.<br><br>
The process of searching for, defining and inserting manual colour schemes for creating <a href="#fig-bars-region" class="quarto-xref">Figure&nbsp;<span>3.10</span></a> might seem inimical to this. There is some reasonably involved <code>dplyr</code> and a little regular expression in the data preparation code that you should not be overly concerned with. Having control of these slightly more low-level properties is, though, sometimes necessary even for exploratory analysis, in this case for effecting <em>symbolisation</em> that supports comparison.</div>
</div>
</div>
</section></section><section id="plot-relationships" class="level3" data-number="3.3.5"><h3 data-number="3.3.5" class="anchored" data-anchor-id="plot-relationships">
<span class="header-section-number">3.3.5</span> Plot relationships</h3>
<p></p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-scatters-con" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-scatters-con-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/03/scatters-con.png" class="img-fluid figure-img" style="width:85.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-scatters-con-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.11: Plots of 2019 versus 2017 vote shares.
</figcaption></figure>
</div>
</div>
</div>
<p>To continue the investigation of change in votes for the major parties between 2017 and 2019, <a href="#fig-scatters-con" class="quarto-xref">Figure&nbsp;<span>3.11</span></a> contains a scatterplot of Conservative vote share in 2019 (y-axis) against vote share in 2017 (x-axis). The graphic is annotated with a diagonal line. If constituencies voted in 2019 in exactly the same way as 2017, the points would converge on the diagonal. Points above the diagonal indicate a larger Conservative vote share than 2017, those below the diagonal a smaller Conservative vote share than 2017. Points are coloured according to the winning party in 2019, and constituencies that flipped from Labour to Conservative are emphasised using transparency and shape.</p>
<p>The code for generating most of the scatterplot in <a href="#fig-scatters-con" class="quarto-xref">Figure&nbsp;<span>3.11</span></a> is below.</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_gb</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>winner_19<span class="op">=</span><span class="fu">case_when</span><span class="op">(</span></span>
<span>           <span class="va">winner_19</span> <span class="op">==</span> <span class="st">"Conservative"</span> <span class="op">~</span> <span class="st">"Conservative"</span>,</span>
<span>           <span class="va">winner_19</span> <span class="op">==</span> <span class="st">"Labour"</span> <span class="op">~</span> <span class="st">"Labour"</span>,</span>
<span>           <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"Other"</span></span>
<span>         <span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">con_17</span>, y<span class="op">=</span><span class="va">con_19</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>colour<span class="op">=</span><span class="va">winner_19</span><span class="op">)</span>, alpha<span class="op">=</span><span class="fl">.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_abline</span><span class="op">(</span>intercept <span class="op">=</span> <span class="fl">0</span>, slope <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_colour_manual</span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">con</span>,<span class="va">lab</span>,<span class="va">other</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There is little surprising here:</p>
<ol type="1">
<li>
<em>Data</em>: The <code>data_gb</code> data frame. Values of <code>winner_19</code> that are not <em>Conservative</em> or <em>Labour</em> are recoded to <em>Other</em> using a conditional statement. This is to ease and narrow the comparison to the two major parties.</li>
<li>
<em>Encoding</em>: Conservative vote shares in 2017 and 2019 are mapped to the x- and y- axes respectively and <code>winner_19</code> to colour. <code>scale_colour_manual()</code> is used for customising the colours.</li>
<li>
<em>Marks</em>: <code>geom_point()</code> for generating the points of the scatterplot; <code>geom_abline()</code> for drawing the reference diagonal.</li>
</ol>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task 3
</div>
</div>
<div class="callout-body-container callout-body">
<div class="line-block">The code block above doesn’t exactly reproduce the graphic in <a href="#fig-scatters-con" class="quarto-xref">Figure&nbsp;<span>3.11</span></a>. Try updating the ggplot2 specification to emphasise constituencies that flipped from Labour to Conservative.<br><br>
Hint: you may wish to generate a variable recording constituencies that flipped between 2017 and 2019 and encode some visual channel in the graphic on this.</div>
</div>
</div>
<p></p>
</section><section id="plot-geography" class="level3" data-number="3.3.6"><h3 data-number="3.3.6" class="anchored" data-anchor-id="plot-geography">
<span class="header-section-number">3.3.6</span> Plot geography</h3>
<p></p>
<p>The data graphics above suggest that the composition of Conservative and Labour voting may be shifting. Paying attention to the geography of voting, certainly to <em>changes</em> in voting between 2017 and 2019 elections (e.g. <a href="#fig-hist-region" class="quarto-xref">Figure&nbsp;<span>3.8</span></a>), may therefore be instructive. We end the technical component to the chapter by generating thematic maps of the results data.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-map-winners" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-map-winners-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/03/map-winners.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-map-winners-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.12: Choropleth of elected parties in 2019 General Election.
</figcaption></figure>
</div>
</div>
</div>
<p>To do this we need to generate a join on the boundary dataset loaded at the start of this technical section (<code>cons_outline</code>):</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Join constituency boundaries.</span></span>
<span><span class="va">data_gb</span> <span class="op">&lt;-</span> <span class="va">cons_outline</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">inner_join</span><span class="op">(</span><span class="va">data_gb</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pcon21cd"</span><span class="op">=</span><span class="st">"ons_const_id"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Check class.</span></span>
<span><span class="co">## [1] "sf"         "data.frame"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The code for generating the choropleth maps of winning party by constituency in <a href="#fig-map-winners" class="quarto-xref">Figure&nbsp;<span>3.12</span></a>:</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Recode winner_19 as a factor variable for assigning colours.</span></span>
<span><span class="va">data_gb</span> <span class="op">&lt;-</span> <span class="va">data_gb</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    winner_19<span class="op">=</span><span class="fu">if_else</span><span class="op">(</span><span class="va">winner_19</span><span class="op">==</span><span class="st">"Speaker"</span>, <span class="st">"Other"</span>, <span class="va">winner_19</span><span class="op">)</span>,</span>
<span>    winner_19<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">winner_19</span>, levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Conservative"</span>, <span class="st">"Labour"</span>, </span>
<span>    <span class="st">"Liberal Democrat"</span>, <span class="st">"Scottish National Party"</span>, <span class="st">"Green"</span>, </span>
<span>    <span class="st">"Plaid Cymru"</span>, <span class="st">"Other"</span><span class="op">)</span><span class="op">)</span></span>
<span>     <span class="op">)</span></span>
<span><span class="va">party_colours</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">con</span>, <span class="va">lab</span>, <span class="va">ld</span>, <span class="va">snp</span>, <span class="va">green</span>, <span class="va">pc</span>, <span class="va">other</span><span class="op">)</span></span>
<span><span class="co"># Plot map.</span></span>
<span><span class="va">data_gb</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill<span class="op">=</span><span class="va">winner_19</span><span class="op">)</span>, colour<span class="op">=</span><span class="st">"#eeeeee"</span>, linewidth<span class="op">=</span><span class="fl">0.01</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Optionally add a layer for regional boundaries.</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data<span class="op">=</span><span class="va">.</span> <span class="op">%&gt;%</span> <span class="fu">group_by</span><span class="op">(</span><span class="va">region</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">summarise</span><span class="op">(</span><span class="op">)</span>,</span>
<span>      colour<span class="op">=</span><span class="st">"#eeeeee"</span>, fill<span class="op">=</span><span class="st">"transparent"</span>, linewidth<span class="op">=</span><span class="fl">0.08</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span>crs<span class="op">=</span><span class="fl">27700</span>, datum<span class="op">=</span><span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">party_colours</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A breakdown of the ggplot2 spec:</p>
<ol type="1">
<li>
<em>Data</em>: Update <code>data_gb</code> by recoding <code>winner_19</code> as a factor and defining a named vector of colours to supply to <code>scale_fill_manual()</code>. Note that we also use the <code>party_colours</code> object created for the region bar chart.</li>
<li>
<em>Encoding</em>: No surprises here – <code>fill</code> according to <code>winner_19</code>.</li>
<li>
<em>Marks</em>: <code>geom_sf()</code> is a special class of geometry. It draws objects using the contents of a simple features data frame’s <span class="citation" data-cites="pebesma_simple_2018">(<a href="a2-references.html#ref-pebesma_simple_2018" role="doc-biblioref">Pebesma 2018</a>)</span> <code>geometry</code> column. In this case <code>MULTIPOLYGON</code>, so read this as a polygon shape primitive. </li>
<li>
<em>Coordinates</em>: <code>coord_sf</code> – we set the coordinate system (CRS) explicitly. In this case OS British National Grid. </li>
<li>
<em>Setting</em>: Constituency boundaries are subtly introduced by setting the <code>geom_sf()</code> mark to light grey (<code>colour="#eeeeee"</code>) with a thin outline (<code>linewidth=0.01</code>). On the map to the right, outlines for regions are added as another <code>geom_sf()</code> layer. Note how this is achieved in the second <code>geom_sf()</code>. The <code>data_gb</code> dataset initially passed to ggplot2 (identified by the <code>.</code> mark) is collapsed by region (with <code>group_by()</code> and <code>summarise()</code>) and in the background the boundaries in <code>geometry</code> are aggregated by region.</li>
</ol>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Preparing data for plotting
</div>
</div>
<div class="callout-body-container callout-body">
<p>A general point from the code blocks in this chapter is that proficiency in <code>dplyr</code> and <code>tidyr</code> is a necessity. Throughout the book you will find yourself needing to calculate new variables, recode variables and reorganise data frames before handing them over to ggplot2 for plotting.</p>
</div>
</div>
<p>In the third map of <a href="#fig-map-winners" class="quarto-xref">Figure&nbsp;<span>3.12</span></a> the transparency (<code>alpha</code>) of filled constituencies is varied according to the Swing variable. This demonstrates that constituencies swinging most dramatically for Conservative (darker colours) are in the midlands and North of England and not in London and the South East. The pattern is nevertheless a subtle one; transparency (colour luminance / saturation) is not a highly effective visual channel for encoding quantities.</p>
<p></p>
<p>It may be worth applying the same encoding to Butler two-party swing as that used in the Washington Post graphic when characterising Republican-Democrat swing in 2016 US Elections <span class="citation" data-cites="beecham_using_2020">(e.g. <a href="a2-references.html#ref-beecham_using_2020" role="doc-biblioref">Beecham 2020</a>)</span>. This can be achieved by simply adding another ggplot2 layer, though the code is a little more involved. ggplot2’s <code>geom_spoke()</code> primitive draws line segments parameterised by a location (x- y- position) and angle. With this we can encode constituencies with <span style="font-weight:bolder">|</span> marks that angle to the right <span style="color:#3879A1;font-weight:bold">/</span> where the constituency swings towards Conservative and to the left where it swings towards Labour <span style="color:#DB534D;font-weight:bolder">\</span>. This encoding better exposes the pattern of constituencies forming Labour’s “red wall” in the north of England, as well as parts of Wales and the Midlands flipping to Conservative.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-spoke-map" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-spoke-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/03/spoke-map.png" class="img-fluid figure-img" style="width:90.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-spoke-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.13: Map of Butler Con-Lab Swing in 2019 General Election.
</figcaption></figure>
</div>
</div>
</div>
<p>The ggplot2 specification:</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Find the maximum Swing values to pin the min and max angles to.</span></span>
<span><span class="va">max_shift</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">data_gb</span> <span class="op">|&gt;</span> <span class="fu">pull</span><span class="op">(</span><span class="va">swing_con_lab</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">min_shift</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="va">max_shift</span></span>
<span></span>
<span><span class="co"># Re-define party_colours to contain just three values: hex codes for</span></span>
<span><span class="co"># Conservative, Labour and Other.</span></span>
<span><span class="va">party_colours</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">con</span>, <span class="va">lab</span>, <span class="va">other</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">party_colours</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Conservative"</span>, <span class="st">"Labour"</span>, <span class="st">"Other"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot Swing map.</span></span>
<span><span class="va">data_gb</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    is_flipped<span class="op">=</span><span class="va">seat_change_1719</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span></span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Conservative gain from Labour"</span>,</span>
<span>       <span class="st">"Labour gain from Conservative"</span><span class="op">)</span>,</span>
<span>    elected<span class="op">=</span><span class="fu">if_else</span><span class="op">(</span><span class="op">!</span><span class="va">winner_19</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Conservative"</span>, <span class="st">"Labour"</span><span class="op">)</span>, <span class="st">"Other"</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">winner_19</span><span class="op">)</span><span class="op">)</span>,</span>
<span>       swing_angle<span class="op">=</span></span>
<span>        <span class="fu">get_radians</span><span class="op">(</span><span class="fu">map_scale</span><span class="op">(</span><span class="va">swing_con_lab</span>,<span class="va">min_shift</span>,<span class="va">max_shift</span>,<span class="fl">135</span>,<span class="fl">45</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>   <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill<span class="op">=</span><span class="va">elected</span><span class="op">)</span>, colour<span class="op">=</span><span class="st">"#636363"</span>, alpha<span class="op">=</span><span class="fl">.2</span>, linewidth<span class="op">=</span><span class="fl">.01</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_spoke</span><span class="op">(</span></span>
<span>    <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">bng_e</span>, y<span class="op">=</span><span class="va">bng_n</span>, angle<span class="op">=</span><span class="va">swing_angle</span>, colour<span class="op">=</span><span class="va">elected</span>, </span>
<span>      linewidth<span class="op">=</span><span class="va">is_flipped</span><span class="op">)</span>,</span>
<span>    radius<span class="op">=</span><span class="fl">7000</span>, position<span class="op">=</span><span class="st">"center_spoke"</span></span>
<span>    <span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span>crs<span class="op">=</span><span class="fl">27700</span>, datum<span class="op">=</span><span class="cn">NA</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">scale_linewidth_ordinal</span><span class="op">(</span>range<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.2</span>,<span class="fl">.5</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">scale_colour_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">party_colours</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">party_colours</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A breakdown:</p>
<ol type="1">
<li>
<em>Data</em>: <code>data_gb</code> is updated with a Boolean (<code>TRUE</code>/<code>FALSE</code>) variable identifying whether or not the constituency flipped between successive elections (<code>is_flipped</code>), and a variable simplifying the party elected to either Conservative, Labour or Other. <code>swing_angle</code> contains the angles used to orient the line marks. A convenience function (<code>map_scale()</code>) pins the maximum swing values to 45 degrees and 135 degrees – respectively max swing to the right, Conservative and max swing to the left, Labour.</li>
<li>
<em>Encoding</em>: <code>geom_sf()</code> is again filled by elected party. This encoding is made more subtle by adding transparency (<code>alpha=.2</code>). <code>geom_spoke()</code> is mapped to the geographic centroid of each Constituency (<code>bng_e</code> - easting, <code>bng_n</code> - northing), coloured on elected party, sized on whether the constituency flipped its vote and tilted or angled according to the <code>swing_angle</code> variable.</li>
<li>
<em>Marks</em>: <code>geom_sf()</code> for the constituency boundaries, <code>geom_spoke()</code> for the angled line primitives.</li>
<li>
<em>Scale</em>: <code>geom_spoke()</code> primitives are sized to emphasise whether constituencies have flipped. The size encoding is censored to two values with <code>scale_linewidth_ordinal()</code>. Passed to <code>scale_colour_manual()</code> and <code>scale_fill_manual()</code> is the vector of <code>party_colours</code>.</li>
<li>
<em>Coordinates</em>: <code>coord_sf</code> – the CRS is OS British National Grid, so we define constituency centroids using easting and northing planar coordinates.</li>
<li>
<em>Setting</em>: The <code>radius</code> of <code>geom_spoke()</code> lines is a sensible default arrived at through trial and error, its <code>position</code> set using a newly created <code>center_spoke</code> class.</li>
</ol>
<p>There are helper functions that must also be run to execute the ggplot2 code above correctly. In order to position lines using <code>geom_spoke()</code> centred on their x- y- location, we need to create a custom ggplot2 subclass. Details are in the <code>03-template.qmd</code> file. Again, this is somewhat involved for a chapter introducing ggplot2 for analysis. Nevertheless, hopefully you can see from the plot specification above that the principles of mapping data to visuals can be implemented straightforwardly in ggplot2: line marks for constituencies (<code>geom_spoke()</code>), positioned in <code>x</code> and <code>y</code> according to British National Grid easting and northings and oriented (<code>angle</code>) according to two-party Swing.</p>
<p></p>
<section id="dot-density-maps" class="level4 unnumbered"><h4 class="unnumbered anchored" data-anchor-id="dot-density-maps">Dot-density maps</h4>
<p></p>
<p>A common design challenge when presenting population data spatially is to accurately reflect <em>geography</em> at the same time as the <em>quantitative</em> outcome of interest – in this case, the location and shape of constituencies versus their associated vote sizes. You may be familiar with cartogram layouts used in electoral analysis. They are maps that distort geographic space in order to size constituencies according to the voting population rather than their physical area. Dot-density maps also convey absolute numbers of votes but in a way that preserves geography. In the example below, each dot represents 1,000 votes for a given party – Conservative, Labour, Other – and dots are positioned in the constituencies from which those votes were made. Dots therefore concentrate in population-dense areas of the country.</p>
<p>The difficulty in generating dot-density maps is not wrangling ggplot2, but in preparing data to be plotted. We need to create a randomly located point within a constituency’s boundary for every thousand votes that are made there. R packages specialised to dot-density maps provide functions for doing this, but it is quite easy to achieve using the sorts of functional and <code>tidyverse</code>-style code introduced throughout this book. We include the code for <a href="#fig-dot-density" class="quarto-xref">Figure&nbsp;<span>3.14</span></a> directly below the plot. While compact, there are some quite advanced functional programming concepts (in the use of <code><a href="https://purrr.tidyverse.org/reference/map.html">purrr::map()</a></code>) that we do not explain. These concepts are in fact covered in some detail and with proper description in later chapters of the book.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-dot-density" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-dot-density-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/03/dot_density.png" class="img-fluid figure-img" style="width:80.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-dot-density-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.14: Dot density map of 2019 General Election result.
</figcaption></figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Collect 2019 GE data from which dots are approximated.</span></span>
<span><span class="va">vote_data</span> <span class="op">&lt;-</span> <span class="va">bes_2019</span> <span class="op">|&gt;</span>   </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">ons_const_id</span><span class="op">!=</span><span class="st">"S14000051"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    other_vote_19<span class="op">=</span><span class="va">total_vote_19</span><span class="op">-</span><span class="op">(</span><span class="va">con_vote_19</span> <span class="op">+</span> <span class="va">lab_vote_19</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span></span>
<span>    <span class="va">ons_const_id</span>, <span class="va">constituency_name</span>, <span class="va">region</span>, <span class="va">con_vote_19</span>, </span>
<span>    <span class="va">lab_vote_19</span>, <span class="va">other_vote_19</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span></span>
<span>    cols<span class="op">=</span><span class="va">con_vote_19</span><span class="op">:</span><span class="va">other_vote_19</span>, </span>
<span>    names_to<span class="op">=</span><span class="st">"party"</span>, values_to<span class="op">=</span><span class="st">"votes"</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    party<span class="op">=</span><span class="fu">str_extract</span><span class="op">(</span><span class="va">party</span>, <span class="st">"[^_]+"</span><span class="op">)</span>,</span>
<span>    votes_dot<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">votes</span><span class="op">/</span><span class="fl">1000</span>,<span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">votes_dot</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Sample within constituency polygons. </span></span>
<span><span class="co"># This might take a bit of time to execute.</span></span>
<span><span class="va">start_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">sampled_points</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">cons_outline</span> <span class="op">|&gt;</span>   </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">geometry</span>, <span class="va">pcon21cd</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">pcon21cd</span><span class="op">!=</span><span class="st">"S14000051"</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu">inner_join</span><span class="op">(</span></span>
<span>    <span class="va">vote_data</span> <span class="op">|&gt;</span> <span class="fu">group_by</span><span class="op">(</span><span class="va">ons_const_id</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>    <span class="fu">summarise</span><span class="op">(</span>votes_dot<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">votes_dot</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span>, </span>
<span>    by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pcon21cd"</span><span class="op">=</span><span class="st">"ons_const_id"</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">nest</span><span class="op">(</span>data<span class="op">=</span><span class="fu">everything</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    sampled_points<span class="op">=</span><span class="fu">map</span><span class="op">(</span><span class="va">data</span>, </span>
<span>      <span class="op">~</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_sample.html">st_sample</a></span><span class="op">(</span></span>
<span>        x<span class="op">=</span><span class="va">.x</span>, size<span class="op">=</span><span class="va">.x</span><span class="op">$</span><span class="va">votes_dot</span>, exact<span class="op">=</span><span class="cn">TRUE</span>, type<span class="op">=</span><span class="st">"random"</span></span>
<span>        <span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">st_coordinates</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>        <span class="fu">as_tibble</span><span class="op">(</span>.name_repair<span class="op">=</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"east"</span>, <span class="st">"north"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>     const_id<span class="op">=</span><span class="fu">map</span><span class="op">(</span><span class="va">data</span>, <span class="op">~</span><span class="va">.x</span> <span class="op">|&gt;</span>  <span class="fu">st_drop_geometry</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>     <span class="fu">select</span><span class="op">(</span><span class="va">pcon21cd</span>, <span class="va">votes_dot</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">uncount</span><span class="op">(</span><span class="va">votes_dot</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">unnest</span><span class="op">(</span><span class="op">-</span><span class="va">data</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="va">end_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">end_time</span> <span class="op">-</span> <span class="va">start_time</span></span>
<span><span class="va">point_votes</span> <span class="op">&lt;-</span> <span class="va">vote_data</span> <span class="op">|&gt;</span> <span class="fu">select</span><span class="op">(</span><span class="va">party</span>, <span class="va">votes_dot</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">uncount</span><span class="op">(</span><span class="va">votes_dot</span><span class="op">)</span></span>
<span><span class="va">sampled_points</span>  <span class="op">&lt;-</span> <span class="va">sampled_points</span> <span class="op">|&gt;</span>  <span class="fu">bind_cols</span><span class="op">(</span><span class="va">point_votes</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot sampled points.</span></span>
<span><span class="va">party_colours</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">con</span>, <span class="va">lab</span>, <span class="va">other</span><span class="op">)</span></span>
<span><span class="va">sampled_points</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span></span>
<span>    data<span class="op">=</span><span class="va">cons_outline</span>, fill<span class="op">=</span><span class="st">"transparent"</span>, </span>
<span>    colour<span class="op">=</span><span class="st">"#636363"</span>, linewidth<span class="op">=</span><span class="fl">.03</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data<span class="op">=</span><span class="va">cons_outline</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu">inner_join</span><span class="op">(</span><span class="va">vote_data</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pcon21cd"</span><span class="op">=</span><span class="st">"ons_const_id"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu">group_by</span><span class="op">(</span><span class="va">region</span><span class="op">)</span> <span class="op">|&gt;</span>  <span class="fu">summarise</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    fill<span class="op">=</span><span class="st">"transparent"</span>, colour<span class="op">=</span><span class="st">"#636363"</span>, linewidth<span class="op">=</span><span class="fl">.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span></span>
<span>    <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">east</span>,y<span class="op">=</span><span class="va">north</span>, fill<span class="op">=</span><span class="va">party</span>, colour<span class="op">=</span><span class="va">party</span><span class="op">)</span>, </span>
<span>    alpha<span class="op">=</span><span class="fl">.5</span>, size<span class="op">=</span><span class="fl">.6</span>, stroke<span class="op">=</span><span class="fl">0</span></span>
<span>    <span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">party_colours</span>, <span class="st">"1 dot = 1,000 votes"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">scale_colour_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">party_colours</span>, <span class="st">"1 dot = 1,000 votes"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>colour<span class="op">=</span><span class="fu">guide_legend</span><span class="op">(</span>override.aes<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p> </p>
</section></section></section><section id="conclusions" class="level2" data-number="3.4"><h2 data-number="3.4" class="anchored" data-anchor-id="conclusions">
<span class="header-section-number">3.4</span> Conclusions</h2>
<p>Visualization design is ultimately a process of decision-making. Data must be filtered and prioritised before being encoded with marks, visual channels and symbolisation. The most successful data graphics are those that expose structure, connections and comparisons that could not be achieved easily via other, non-visual means. This chapter has introduced concepts – a vocabulary, framework and empirically-informed guidelines – that help support this decision-making and that underpin modern visualization toolkits, ggplot2 especially. Through an analysis of UK 2019 General Election data, we have demonstrated how these concepts can be applied in a real data analysis.</p>
</section><section id="further-reading" class="level2" data-number="3.5"><h2 data-number="3.5" class="anchored" data-anchor-id="further-reading">
<span class="header-section-number">3.5</span> Further Reading</h2>
<p>For a primer on visualization design principles:</p>
<ul>
<li>Munzner, T. 2014. “Visualization Analysis and Design”, Boca Raton, FL: <em>CRC Press</em>.</li>
</ul>
<p>A paper presenting evidence-backed guidelines on visualization design, aimed at applied researchers:</p>
<ul>
<li>Franconeri S. L., Padilla L. M., Shah P., Zacks J. M., Hullman J. (2021). “The science of visual data communication: What works”. <em>Psychological Science in the Public Interest</em>, 22(3), 110–161. doi: 10.1177/15291006211051956.</li>
</ul>
<p>For an introduction to ggplot2 and its relationship with Wilkinson’s <span class="citation" data-cites="wilkinson_grammar_1999">(<a href="a2-references.html#ref-wilkinson_grammar_1999" role="doc-biblioref">1999</a>)</span> <em>grammar of graphics</em>:</p>
<ul>
<li>Wickham, H., Çetinkaya-Rundel, M., Grolemund, G. 2023, “R for Data Science, 2nd Edition”, Sebastopol, CA: <em>O’Reilly</em>.
<ul>
<li>Chapters 1, 9.</li>
</ul>
</li>
</ul>
<p>Excellent paper looking at consumption and impact of election forecast visualizations:</p>
<ul>
<li>Yang, F. et al.&nbsp;2024. “Swaying the Public? Impacts of Election Forecast Visualizations on Emotion, Trust, and Intention in the 2022 U.S. Midterms.” <em>IEEE Transactions on Visualization and Computer Graphics</em>, 30(1), 23–33. doi: 10.1109/TVCG.2023.3327356.</li>
</ul>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-bbc_visual_2019" class="csl-entry" role="listitem">
BBC Visual and Data Journalism Team. 2019. <span>“BBC Visual and Data Journalism Cookbook for <span>R</span> Graphics.”</span> <a href="https://github.com/bbc/rcookbook" class="uri">https://github.com/bbc/rcookbook</a>.
</div>
<div id="ref-beecham_using_2020" class="csl-entry" role="listitem">
Beecham, R. 2020. <span>“Using Position, Angle and Thickness to Expose the Shifting Geographies of the 2019 <span>UK</span> <span>General</span> <span>Election</span>.”</span> <em>Environment and Planning A: Economy and Space</em> 52 (5): 833–36. <a href="https://doi.org/10.1177/0308518X20909392">https://doi.org/10.1177/0308518X20909392</a>.
</div>
<div id="ref-beecham_regionally-structured_2020" class="csl-entry" role="listitem">
Beecham, R., N. Williams, and L. Comber. 2020. <span>“Regionally-Structured Explanations Behind Area-Level Populism: <span>An</span> Update to Recent Ecological Analyses.”</span> <em>PLOS One</em> 15 (3): e0229974. <a href="https://doi.org/10.1371/journal.pone.0229974">https://doi.org/10.1371/journal.pone.0229974</a>.
</div>
<div id="ref-buja_statistical_2009" class="csl-entry" role="listitem">
Buja, A., D. Cook, H. Hofmann, M. Lawrence, E-K Lee, D. Swayne, and H. Wickham. 2009. <span>“Statistical Inference for Exploratory Data Analysis and Model Diagnostics.”</span> <em>Philosophical Transactions of the Royal Society A: Mathematical, Physical and Engineering Sciences</em> 367 (1906): 4361–83. <a href="https://doi.org/10.1098/rsta.2009.0120">https://doi.org/10.1098/rsta.2009.0120</a>.
</div>
<div id="ref-burnmurdoch_making_2023" class="csl-entry" role="listitem">
Burn-Murdoch, J. 2023. <span>“Making Charts That Make an Impact.”</span> Invited talk, Data Visualization Society’s Outlier Conference. <a href="https://www.youtube.com/watch?v=tIbaQUo6H9g&amp;ab_channel=DataVisualizationSociety">https://www.youtube.com/watch?v=tIbaQUo6H9g&amp;ab_channel=DataVisualizationSociety</a>.
</div>
<div id="ref-butler_why_1990" class="csl-entry" role="listitem">
Butler, D., and S. Van Beek. 1990. <span>“Why Not Swing? <span>Measuring</span> Electoral Change.”</span> <em>Political Science &amp; Politics</em> 23 (2): 178–84. <a href="https://doi.org/10.2307/420065">https://doi.org/10.2307/420065</a>.
</div>
<div id="ref-muth_your_2018" class="csl-entry" role="listitem">
Charlotte Muth, L. 2018. <span>“Your Friendly Guide to Colors in Data Visualisation: An Overview of Color Tools.”</span> <span>Datawrapper</span>. <a href="https://www.datawrapper.de/blog/colorguide">https://www.datawrapper.de/blog/colorguide</a>.
</div>
<div id="ref-cleveland_graphical_1984" class="csl-entry" role="listitem">
Cleveland, W., and R. McGill. 1984. <span>“Graphical <span>Perception</span>: <span>Theory</span>, <span>Experimentation</span>, and <span>Application</span> to the <span>Development</span> of <span>Graphical</span> <span>Methods</span>.”</span> <em>Journal of the American Statistical Association</em> 79 (387): 531–54. <a href="https://doi.org/10.2307/2288400">https://doi.org/10.2307/2288400</a>.
</div>
<div id="ref-comber_route_2023" class="csl-entry" role="listitem">
Comber, A., C. Brunsdon, M. Charlton, G. Dong, R. Harris, B. Lu, Y. Lü, et al. 2023. <span>“A Route Map for Successful Applications of Geographically Weighted Regression.”</span> <em>Geographical Analysis</em> 55 (1): 155–78. <a href="https://doi.org/10.1111/gean.12316">https://doi.org/10.1111/gean.12316</a>.
</div>
<div id="ref-franconeri_psychological_2022" class="csl-entry" role="listitem">
Franconeri, S. L., L. M. Padilla, P. Shah, J. M. Zacks, and J. Hullman. 2021. <span>“The Science of Visual Data Communication: What Works.”</span> <em>Psychological Science in the Public Interest</em> 22 (3): 110–61. <a href="https://doi.org/10.1177/15291006211051956%20">https://doi.org/10.1177/15291006211051956 </a>.
</div>
<div id="ref-gamio_how_2016" class="csl-entry" role="listitem">
Gamio, L., and D. Keating. 2016. <span>“How <span>Trump</span> Redrew the Electoral Map, from Sea to Shining Sea.”</span> <span>The Washington Post</span>. <a href="https://www.washingtonpost.com/graphics/politics/2016-election/election-results-from-coast-to-coast/">https://www.washingtonpost.com/graphics/politics/2016-election/election-results-from-coast-to-coast/</a>.
</div>
<div id="ref-hanretty_areal_2017" class="csl-entry" role="listitem">
Hanretty, C. 2017. <span>“Areal Interpolation and the <span>UK</span>’s Referendum on <span>EU</span> Membership.”</span> <em>Journal of Elections, Public Opinion and Parties</em> 37 (4): 466–83. <a href="https://doi.org/10.1080/17457289.2017.1287081">https://doi.org/10.1080/17457289.2017.1287081</a>.
</div>
<div id="ref-harrower_colorbrewerorg_2003" class="csl-entry" role="listitem">
Harrower, M., and C. A. Brewer. 2003. <span>“ColorBrewer.org: An Online Tool for Selecting Colour Schemes for Maps.”</span> <em>The Cartographic Journal</em> 40 (1): 27–37. <a href="https://doi.org/10.1179/000870403235002042">https://doi.org/10.1179/000870403235002042</a>.
</div>
<div id="ref-healy_data_2018" class="csl-entry" role="listitem">
Healy, K. 2019. <em>Data Visualization: A Practical Introduction</em>. Princeton, NJ: Princeton University Press. <a href="https://socviz.co">https://socviz.co</a>.
</div>
<div id="ref-heer_crowdsourcing_2010" class="csl-entry" role="listitem">
Heer, J., and M. Bostock. 2010. <span>“Crowdsourcing <span>Graphical</span> <span>Perception</span>: <span>Using</span> <span>Mechanical</span> <span>Turk</span> to <span>Assess</span> <span>Visualization</span> <span>Design</span>.”</span> In <em><span>ACM</span> <span>Human</span> <span>Factors</span> in <span>Computing</span> <span>Systems</span></em>, 203–12. <a href="https://doi.org/10.1145/1753326.1753357">https://doi.org/10.1145/1753326.1753357</a>.
</div>
<div id="ref-hullman_designing_2021" class="csl-entry" role="listitem">
Hullman, J., and A. Gelman. 2021. <span>“Designing for Interactive Exploratory Data Analysis Requires Theories of Graphical Inference.”</span> <em>Harvard Data Science Review</em> 3 (3).
</div>
<div id="ref-ismay_moderndive_2020" class="csl-entry" role="listitem">
Ismay, C., and A. Kim. 2020. <em>Statistical Inference via Data Science: A <span>ModernDive</span> into <span>R</span> and the Tidyverse</em>. New York, NY: CRC Press. <a href="https://doi.org/10.1201/9780367409913">https://doi.org/10.1201/9780367409913</a>.
</div>
<div id="ref-kale_hypothetical_2019" class="csl-entry" role="listitem">
Kale, A., F. Nguyen, M. Kay, and J. Hullman. 2019. <span>“Hypothetical Outcome Plots Help Untrained Observers Judge Trends in Ambiguous Data.”</span> <em>IEEE Transactions on Visualization and Computer Graphics</em> 25 (1): 892–902. <a href="https://doi.org/10.1109/TVCG.2018.2864909">https://doi.org/10.1109/TVCG.2018.2864909</a>.
</div>
<div id="ref-kay_uncertainty_2021" class="csl-entry" role="listitem">
Kay, M. 2021. <span>“Uncertainty Visualization as a Moral Imperative.”</span> Invited talk, BostonCHI meeting. <a href="https://www.youtube.com/watch?v=mfQ3QVyw4N0&amp;ab_channel=BostonCHI">https://www.youtube.com/watch?v=mfQ3QVyw4N0&amp;ab_channel=BostonCHI</a>.
</div>
<div id="ref-kosara_lesson_2023" class="csl-entry" role="listitem">
Kosara, R. 2023. <span>“Lesson 4: Presentation, Uncertainty, ISOTYPE.”</span> ObservableHQ Notebook; ObservableHQ. <a href="https://observablehq.com/@observablehq/lesson-4-presentation-uncertainty-isotype?collection=@observablehq/advanced-data-vis-course">https://observablehq.com/@observablehq/lesson-4-presentation-uncertainty-isotype?collection=@observablehq/advanced-data-vis-course</a>.
</div>
<div id="ref-munzner_visualization_2014" class="csl-entry" role="listitem">
Munzner, T. 2014. <em>Visualization <span>Analysis</span> and <span>Design</span></em>. <span>AK</span> <span>Peters</span> <span>Visualization</span> <span>Series</span>. Boca Raton, FL: CRC Press.
</div>
<div id="ref-pebesma_simple_2018" class="csl-entry" role="listitem">
Pebesma, E. 2018. <span>“<span class="nocase">Simple Features for R: Standardized Support for Spatial Vector Data</span>.”</span> <em><span>The R Journal</span></em> 10 (1): 439–46. <a href="https://doi.org/10.32614/RJ-2018-009">https://doi.org/10.32614/RJ-2018-009</a>.
</div>
<div id="ref-scherer_designing_2023" class="csl-entry" role="listitem">
Scherer, C. 2023. <span>“Designing Data Visualizations to Successfully Tell a Story.”</span> Workshop at Posit::conf(2023), Chicago, IL. <a href="https://posit-conf-2023.github.io/dataviz-storytelling/">https://posit-conf-2023.github.io/dataviz-storytelling/</a>.
</div>
<div id="ref-turing_the_2025" class="csl-entry" role="listitem">
The Turing Way Community. 2025. <span>“The Turing Way: A Handbook for Reproducible, Ethical and Collaborative Research.”</span> Zenodo. <a href="https://doi.org/10.5281/zenodo.15213042">https://doi.org/10.5281/zenodo.15213042</a>.
</div>
<div id="ref-tufte_visual_1983" class="csl-entry" role="listitem">
Tufte, E. 1983. <em>The <span>Visual</span> <span>Display</span> of <span>Quantitative</span> <span>Information</span></em>. Cheshire, CT: Graphics Press.
</div>
<div id="ref-uberoi_general_2020" class="csl-entry" role="listitem">
Uberoi, E., C. Baker, and R. Cracknell. 2020. <span>“General Election 2019: Full Results and Analysis.”</span> <span>House of Commons Library</span>. <a href="https://commonslibrary.parliament.uk/research-briefings/cbp-8749/">https://commonslibrary.parliament.uk/research-briefings/cbp-8749/</a>.
</div>
<div id="ref-white_symbolization_2017" class="csl-entry" role="listitem">
White, T. 2017. <span>“Symbolization and the <span>Visual</span> <span>Variables</span>.”</span> In <em>The <span>Geographic</span> <span>Information</span> <span>Science</span> &amp; <span>Technology</span> <span>Body</span> of <span>Knowledge</span></em>, edited by John P. Wilson.
</div>
<div id="ref-wickham_layered_2010" class="csl-entry" role="listitem">
Wickham, H. 2010. <span>“A Layered Grammar of Graphics.”</span> <em>Journal of Computational and Graphical Statistics</em> 19 (1): 3–28. <a href="https://doi.org/10.1198/jcgs.2009.07098">https://doi.org/10.1198/jcgs.2009.07098</a>.
</div>
<div id="ref-wilkinson_grammar_1999" class="csl-entry" role="listitem">
Wilkinson, L. 1999. <em>The <span>Grammar</span> of <span>Graphics</span></em>. New York, NY: Springer.
</div>
<div id="ref-wolf_spatial_2021" class="csl-entry" role="listitem">
Wolf, L. J., L. Anselin, D. Arribas-Bel, and L. Rivers Mobley. 2021. <span>“On Spatial and Platial Dependence: Examining Shrinkage in Spatially Dependent Multilevel Models.”</span> <em>Annals of the American Association of Geographers</em> 111 (6): 1679–91. <a href="https://doi.org/10.1080/24694452.2020.1841602">https://doi.org/10.1080/24694452.2020.1841602</a>.
</div>
<div id="ref-yang_swaying_2024" class="csl-entry" role="listitem">
Yang, F., M. Cau, C. Mortenson, H. Fakhari, A. D. Lokmanoglu, J. Hullman, S. Franconeri, N. Diakopoulos, E. C. Nisbet, and M. Kay. 2024. <span>“Swaying the Public? Impacts of Election Forecast Visualizations on Emotion, Trust, and Intention in the 2022 <span>U.S.</span> Midterms.”</span> <em>IEEE Transactions on Visualization and Computer Graphics</em> 30 (1): 23–33. <a href="https://doi.org/10.1109/TVCG.2023.3327356">https://doi.org/10.1109/TVCG.2023.3327356</a>.
</div>
</div>
</section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p><code>https://blog.datawrapper.de/colorguide/</code><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p><code>https://vis4sds.github.io/vis4sds/files/03-template.qmd</code><a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/vis4sds\/vis4sds");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./02-data.html" class="pagination-link" aria-label="Data Fundamentals">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data Fundamentals</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./04-explore.html" class="pagination-link" aria-label="Exploratory Data Analysis">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Exploratory Data Analysis</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>