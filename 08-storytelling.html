<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Visualization for Social Data Science - 8&nbsp; Data Storytelling</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./references.html" rel="next">
<link href="./07-uncertainty.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script><script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script><script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">
<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./08-storytelling.html"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Data Storytelling</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Visualization for Social Data Science</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/vis4sds/vis4sds/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="https://twitter.com/intent/tweet?url=%7Curl%7C" title="Twitter" class="quarto-navigation-tool px-1" aria-label="Twitter"><i class="bi bi-twitter"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data Fundamentals</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-visual.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Visualization Fundamentals</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-explore.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Exploratory Data Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-network.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Networks</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-model.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-uncertainty.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Uncertainty</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-storytelling.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Data Storytelling</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./a1-tasks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Task answers</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">8.1</span> Introduction</a></li>
  <li>
<a href="#concepts" id="toc-concepts" class="nav-link" data-scroll-target="#concepts"><span class="header-section-number">8.2</span> Concepts</a>
  <ul class="collapse">
<li><a href="#data-driven-storytelling" id="toc-data-driven-storytelling" class="nav-link" data-scroll-target="#data-driven-storytelling"><span class="header-section-number">8.2.1</span> Data-driven storytelling</a></li>
  <li><a href="#designed-and-partial" id="toc-designed-and-partial" class="nav-link" data-scroll-target="#designed-and-partial"><span class="header-section-number">8.2.2</span> Designed and partial</a></li>
  <li><a href="#intuitive-and-compelling" id="toc-intuitive-and-compelling" class="nav-link" data-scroll-target="#intuitive-and-compelling"><span class="header-section-number">8.2.3</span> Intuitive and compelling</a></li>
  <li><a href="#political" id="toc-political" class="nav-link" data-scroll-target="#political"><span class="header-section-number">8.2.4</span> Political</a></li>
  </ul>
</li>
  <li>
<a href="#techniques" id="toc-techniques" class="nav-link" data-scroll-target="#techniques"><span class="header-section-number">8.3</span> Techniques</a>
  <ul class="collapse">
<li><a href="#import" id="toc-import" class="nav-link" data-scroll-target="#import"><span class="header-section-number">8.3.1</span> Import</a></li>
  <li><a href="#plot-trajectories" id="toc-plot-trajectories" class="nav-link" data-scroll-target="#plot-trajectories"><span class="header-section-number">8.3.2</span> Plot trajectories</a></li>
  <li><a href="#add-labels-and-annotations" id="toc-add-labels-and-annotations" class="nav-link" data-scroll-target="#add-labels-and-annotations"><span class="header-section-number">8.3.3</span> Add labels and annotations</a></li>
  <li><a href="#build-custom-legend" id="toc-build-custom-legend" class="nav-link" data-scroll-target="#build-custom-legend"><span class="header-section-number">8.3.4</span> Build custom legend</a></li>
  <li><a href="#compose-graphic" id="toc-compose-graphic" class="nav-link" data-scroll-target="#compose-graphic"><span class="header-section-number">8.3.5</span> Compose graphic</a></li>
  </ul>
</li>
  <li><a href="#conclusions" id="toc-conclusions" class="nav-link" data-scroll-target="#conclusions"><span class="header-section-number">8.4</span> Conclusions</a></li>
  <li><a href="#further-reading" id="toc-further-reading" class="nav-link" data-scroll-target="#further-reading"><span class="header-section-number">8.5</span> Further Reading</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/vis4sds/vis4sds/edit/master/08-storytelling.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title"><span id="sec-storytelling" class="quarto-section-identifier"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Data Storytelling</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p>By the end of this chapter you should gain the following knowledge and practical skills.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Knowledge
</div>
</div>
<div class="callout-body-container callout-body">
<ul class="task-list">
<li><label><input type="checkbox">Appreciate the main characteristics of data-driven stories.</label></li>
<li><label><input type="checkbox">Identify how visual and rhetorical devices are used to communicate with data.</label></li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Practical skills
</div>
</div>
<div class="callout-body-container callout-body">
<ul class="task-list">
<li><label><input type="checkbox">Use shape primitives to code up custom chart designs in ggplot2.</label></li>
<li><label><input type="checkbox">Add non-standard annotations to ggplot2 graphics.</label></li>
</ul>
</div>
</div>
<section id="introduction" class="level2" data-number="8.1"><h2 data-number="8.1" class="anchored" data-anchor-id="introduction">
<span class="header-section-number">8.1</span> Introduction</h2>
<p>It is now taken-for-granted that we live in an evidence-based society in which data are deeply embedded in most domains and in how we approach the world’s problems. This recognition has coincided with the open source movement, which has freed up access and accelerated the development of tools for working with data. The response to Covid-19 is an excellent example. Enter <a href="https://www.google.com/search?q=covid19+github&amp;rlz=1C5CHFA_enGB632GB632&amp;oq=covid19+&amp;aqs=chrome.0.69i59l2j69i57j0l2j69i61l3.3040j0j7&amp;sourceid=chrome&amp;ie=UTF-8">Covid19 github</a> into a search and you’ll be confronted with hundreds of code repositories demonstrating how data related to the pandemic can be collected, processed and analysed. This is exciting and feels very democratic. But there is a responsibility amongst those constructing and sharing evidence-based arguments to do so with integrity; navigating the difficult tension between communicating a clear message – necessarily reducing some of the complexity – at the same time as acknowledging uncertainty.</p>
<p>The role of narrative and storytelling when working with data is much discussed in Information Visualization <span class="citation" data-cites="henryriche_data_2018">(Henry-Riche et al. 2018)</span> and Science Communication <span class="citation" data-cites="franconeri_psychological_2022">(Franconeri et al. 2022)</span>. Importantly, this work recognises that there is no single, optimal visualization design that exposes the true structure or story in a dataset. Instead, that careful design decisions must be made in light of data, audience and intended purpose.</p>
<p>In this chapter we will review some of this literature with a special focus on approaches to communicating data around the Covid-19 pandemic, specifically publicly reported numbers on cases, hospitalisations and deaths.</p>
</section><section id="concepts" class="level2" data-number="8.2"><h2 data-number="8.2" class="anchored" data-anchor-id="concepts">
<span class="header-section-number">8.2</span> Concepts</h2>
<section id="data-driven-storytelling" class="level3" data-number="8.2.1"><h3 data-number="8.2.1" class="anchored" data-anchor-id="data-driven-storytelling">
<span class="header-section-number">8.2.1</span> Data-driven storytelling</h3>
<p>In earlier chapters of the book (e.g. <a href="03-visual.html" class="quarto-xref"><span>Chapter 3</span></a>) we identified and explored some common characteristics of effective data graphics. <span class="citation" data-cites="roth_cartographic_2020">Roth (2021)</span> enumerates 10 such characteristics specialised to data storytelling. Particularly important for visualization design is that data graphics are:</p>
<!-- Although  reasonably generalisable, those characteristics benefit from being re-interpreted when designing for *communication*.  -->
<!-- we made the case that visual data analysis is about encoding data to visuals in a way that follows established guidelines known to work well for particular tasks. This might imply there is some optimal visualization design that can be achieved. Clearly, no such optimal solution exists, especially so when designing graphics for *communication* [@henryriche_data_2018]. However, we can consider some of the common characteristics of effective visual data stories. @roth_cartographic_2020 identifies 10 such characteristics, but particularly important are that visual design stories are: -->
<ul>
<li><p><em>Designed</em>: The analyst makes very deliberate decisions in light of audience and purpose. The goal of visual storytelling is not just to <em>show</em> but also to <em>explain</em>.</p></li>
<li><p><em>Partial</em>: Essential information is prioritised and made salient, with abstraction and brevity preferred over complexity and completeness.</p></li>
<li><p><em>Intuitive</em>: Visual narratives take advantage of our natural tendency to communicate via metaphor and story, with a clear entry point and clear progression.</p></li>
<li><p><em>Compelling</em>: Visual stories often capture attention through an array of graphical devices – sequence, animation and interaction. They generate an aesthetic response.</p></li>
<li><p><em>Relatable and situated</em>: Visual stories promote empathy, using devices that place the audience in the story setting. They are usually constructed from somewhere – according to a particular position.</p></li>
<li><p><em>Political</em>: Visual data stories promote with clarity particular voices, interpretations or positions.</p></li>
</ul>
<p>In the sections that follow, we review some prominent Covid-19 visualizations and reflect on how they implement these sorts of storytelling devices.</p>
</section><section id="designed-and-partial" class="level3" data-number="8.2.2"><h3 data-number="8.2.2" class="anchored" data-anchor-id="designed-and-partial">
<span class="header-section-number">8.2.2</span> Designed and partial</h3>
<p>Perhaps the most high-profile example of data graphics specialised to communication were those produced by the Financial Times <span class="citation" data-cites="ft_coronavirus_2020">(Financial Times 2020)</span>. <a href="#fig-ft-vis" class="quarto-xref">Figure&nbsp;<span>8.1</span></a> displays one such example, the Financial Times’s Covid-19 trajectory tracker. Along the y-axis are cumulative numbers of deaths represented using a log-scale; and along the x-axis, the number of days that elapsed since some threshold number of deaths was recorded.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-ft-vis" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-ft-vis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/08/cum_deaths_full.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ft-vis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.1: <a href="https://www.ft.com/john-burn-murdoch">John Burn-Murdoch</a>’s international comparison of deaths, as explained in <span class="citation" data-cites="ft_coronavirus_2020">Financial Times (2020)</span>. This is an approximate ggplot2 re-implementation of the original Financial Times graphic.
</figcaption></figure>
</div>
</div>
</div>
<p>We can evaluate the graphic using some of the principles introduced in <a href="03-visual.html" class="quarto-xref"><span>Chapter 3</span></a>. In its use of position on an aligned scale to encode death counts, colour hue to differentiate countries and lines to connect daily counts, the graphic’s visual encoding exploits our cognitive abilities. The graphic also makes appropriate use of superimposition to support comparison <span class="citation" data-cites="gleicher_visual_2011">(Gleicher and Roberts 2011)</span> – lines for each country represented on the same coordinate space.</p>
<p>On <span class="citation" data-cites="roth_cartographic_2020">Roth (2021)</span>’s characteristics of visual storytelling, it is clear that the graphic is <em>designed</em> with a very deliberate purpose:</p>
<ol type="1">
<li>Between country comparison: <em>Are countries on the same course?</em>
</li>
<li>Comparison against milestone: <em>How many days does it take a certain county to reach a given number of deaths?</em>
</li>
</ol>
<p>It is possible to see each of these goals informing the graphic. Comparison between countries is most obviously supported by the use of a log-scale. This data transformation removes the dominant, hockey-stick type pattern inevitable when analysing disease growth (e.g.&nbsp;exponential doubling) and instead allows slopes, <em>growth rates</em>, to be compared directly. Log scales are, though, not so familiar to the average reader. Annotations are therefore provided to anchor the reader on reference slope gradients (growth rates), again narrowing on the essential goal of between country comparison. Notice also that there are no legends in this chart. Countries are differentiated with colour hue and then directly-labelled at their most recent death count, an addition that offloads an otherwise taxing look-up task, but also serves to emphasise a country’s ‘stage’ in the pandemic.</p>
<!--
In other design variants there are also approaches to dealing with daily volatility -- a smoothing function based on [splines](https://en.wikipedia.org/wiki/Smoothing_spline). Exposing full details of smoothing functions and their parameterisation is probably a level of complexity beyond the average reader, and so these sorts of features are incorporated discreetly. -->
<!-- ::: {.callout-note icon="true"}
You might be interested to know that most [Financial Times graphics](https://www.ft.com/graphics) are built using ggplot2. A presentation in which John Burn-Mudoch makes the case for ggplot2 for Data Journalism [from this link](https://johnburnmurdoch.github.io/slides/r-ggplot/#/).
::: -->
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>A design alternative that supports between country comparison is <span class="citation" data-cites="bhatia_covidtrends_2020">Bhatia and Reich (2020)</span>’s <a href="https://aatishb.com/covidtrends/">Covid Trends</a> chart (<a href="#fig-covid-trends" class="quarto-xref">Figure&nbsp;<span>8.2</span></a>). In this example, a double log scale is used and growth rates in new cases are presented on the y-axis with total case numbers, rather than time elapsed, plotted along the x-axis. Whilst the introduction of a double log scale might be judged to increase difficulty, actually this design narrows or simplifies the reader’s visual judgement to looking at the thing that we are most interested in: comparison of country growth rates against the two day doubling (annotated with the diagonal). The chart is also accompanied with an excellent <a href="https://www.hippocraticpost.com/covid-19-update/how-to-tell-if-were-beating-covid-19/">explanatory video</a><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>, in which many of the characteristics of visual data stories enumerated by <span class="citation" data-cites="roth_cartographic_2020">Roth (2021)</span> can be identified.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-covid-trends" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-covid-trends-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/08/covid_logs.png" class="img-fluid figure-img" style="width:80.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-covid-trends-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.2: <a href="https://aatishb.com/covidtrends/">Covid Trends</a> chart <span class="citation" data-cites="bhatia_covidtrends_2020">(Bhatia and Reich 2020)</span>. This is an approximate ggplot2 re-implementation of a static from the original webpage.
</figcaption></figure>
</div>
</div>
</div>
</div>
</div>
</section><section id="intuitive-and-compelling" class="level3" data-number="8.2.3"><h3 data-number="8.2.3" class="anchored" data-anchor-id="intuitive-and-compelling">
<span class="header-section-number">8.2.3</span> Intuitive and compelling</h3>
<p>Visual data stories are often explanatory <span class="citation" data-cites="roth_cartographic_2020">(Roth 2021)</span>. They make <em>compelling</em> use of graphical and rhetorical devices to support understanding. This is especially important in data-driven storytelling as it often involves concepts that are initially quite challenging. In <a href="#fig-lambrechts-connected" class="quarto-xref">Figure&nbsp;<span>8.3</span></a> is a static image from a data story written by Flourish<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> <span class="citation" data-cites="flourish_masters_2021">(Lawlor and Robertson 2021)</span> based on design work by <a href="https://twitter.com/maartenzam/status/1319622943526293505">Marteen Lambrechts</a>. The data story is essentially a design exposition <span class="citation" data-cites="beecham_design_2020 wood_design_2018">(Beecham et al. 2020; Wood, Kachkaev, and Dykes 2018)</span>, guiding readers from the familiar to the unfamiliar. First a standard time series chart of hospitalisations and deaths is presented. Deficiencies in this layout are explained before progressively introducing the transformations involved to generate the preferred graphic, a connected scatterplot <span class="citation" data-cites="haroz_the_2016">(Haroz, Kosara, and Franconeri 2016)</span>. Ordering the story in this way explains design decisions and trade-offs from a familiar starting point and helps justify new, sometimes unfamiliar encodings. Thinking about <span class="citation" data-cites="roth_cartographic_2020">Roth (2021)</span>’s characteristics of visual storytelling, formulating a design story in this way helps build <em>intuition</em> – there is a clear entry point and clear progression.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-lambrechts-connected" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-lambrechts-connected-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/08/lambrechts-connected-flourish.png" class="img-fluid figure-img" style="width:95.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-lambrechts-connected-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.3: Screenshot from a data story written by <span class="citation" data-cites="flourish_masters_2021">Lawlor and Robertson (2021)</span>, demonstrating how connected scatterplots can be used to analyse changes in hospitalisations and deaths. The screenshot is reprinted, with permission, from <em>Flourish</em>.
</figcaption></figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<!-- For a more involved design exposition of connected scatterplots, see [Danny Dorling](http://www.dannydorling.org)'s work on [slowdown](https://twitter.com/dannydorling/status/1245010922592231424). Note that Danny also encodes time using line width. This is an important addition, along with colour as demonstrated with [timecurves](https://aviz.fr/~bbach/timecurves/). -->
<p>For an example of guided design exposition, see <span class="citation" data-cites="beecham_on_2021">Beecham et al. (2021)</span> which develops ways of showing simultaneously absolute and relative change in cases, with geographic context.</p>
</div>
</div>
<p>Animations in data graphics can increase engagement and aesthetic appeal. They can also overwhelm since they involve complex tracking of information between frames <span class="citation" data-cites="franconeri_psychological_2022">(Franconeri et al. 2022)</span>. An example of how animation can be used selectively to build <em>intuition</em> is demonstrated in <a href="#fig-ft-anim" class="quarto-xref">Figure&nbsp;<span>8.4</span></a>, again from Financial Times <span class="citation" data-cites="ft_flu_2021">(Financial Times 2021)</span>. The main objective is to demonstrate how different 2020-21 is in terms of admissions to intensive care compared to a normal year. This was in response to claims that Covid-19 behaves much like seasonal flu; to this extent the graphic is also quite <em>political</em>. Each year from 2013-14 is added to the chart and the y-axis rescaled to reflect the new numbers. The animated transitions of the y-axis help build expectation around normal variability in a similar way to hypothetical outcome plots <span class="citation" data-cites="hullman_hypothetical_2015">(Hullman, Resnick, and Adar 2015)</span>, covered in the previous chapter. The claim that the 2020-21 flu season is consistent with normal variability is then debunked by the introduction of the 2020-21 line in red, with animated rescaling of the y-axis used to further emphasise this point.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-ft-anim" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-ft-anim-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/08/flu_years.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ft-anim-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.4: Weekly admissions to intensive care units in England. Each year is introduced progressively, with animated rescaling of the y-axis used to demonstrates how different in terms of intensive care admissions 2020/21 is to previous flu seasons. These are frames from an approximate ggplot2 re-implementation of the original Financial Times graphic <span class="citation" data-cites="ft_flu_2021">(Financial Times 2021)</span>.
</figcaption></figure>
</div>
</div>
</div>
</section><section id="political" class="level3" data-number="8.2.4"><h3 data-number="8.2.4" class="anchored" data-anchor-id="political">
<span class="header-section-number">8.2.4</span> Political</h3>
<p><a href="#fig-ft-vaccine" class="quarto-xref">Figure&nbsp;<span>8.5</span></a> presents a final example from Financial Times <span class="citation" data-cites="burnmurdoch_vaccines_2021">(Burn-Murdoch 2021)</span> with an obviously political purpose. The graphic was created in response to some claims that it is movement restrictions (lockdowns) rather than vaccination that reduced infection rates in the country.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-ft-vaccine" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-ft-vaccine-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/08/vaccine_effect.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ft-vaccine-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.5: Data graphic by <span class="citation" data-cites="burnmurdoch_vaccines_2021">Burn-Murdoch (2021)</span>, presenting an argument for the role of vaccines in reducing Covid cases, hospital admissions and deaths. An approximate ggplot2 re-implementation of the original Financial Times graphic. Note that a slightly different smoothing function may have been used in the original graphic, especially for the cases data.
</figcaption></figure>
</div>
</div>
</div>
<p>Interesting here is how annotation and <em>visual saliency</em> is used to direct our reading. If the graphic was only annotated with points in time when lockdown and vaccination was initiated, it might invite judgements about the effects of these two events on infectious rates. That the graphic makes highly salient annotations labelling the (unmeasurable) <em>effect</em> of the vaccine is an interesting addition. There is little room for ambiguity.</p>
<p>This sort of presentation, labelling the chart with an unmeasurable vaccine effect, may risk graphical integrity. In a keynote given at IEEE VIS 2020, John <span class="citation" data-cites="burnmurdoch_beliv_2020">Burn-Murdoch (2020)</span>, who created this and the other Financial Times graphics, reflected on his experiences generating data stories early in the pandemic. One observation was that the way in which the Financial Times’s data graphics were interpreted, and misinterpreted, varied depending on the prior expectations and political beliefs of those consuming them. The chart labelling in this case might have been added to signal more directly the evidence-based argument that was being made – to amplify a particular conclusion supported by the data.</p>
<p>Clearly all data analysis is heavily informed by the values, prejudices, motivations and incentives of those undertaking them. As demonstrated by <span class="citation" data-cites="roth_cartographic_2020">Roth (2021)</span>’s characteristics of data storytelling, these individual factors are necessary to communicate effectively. An interesting question, then, is around how integrity and trust is designed into a data analysis. Perhaps in the case of the Financial Times data journalists, this trust is established over time, through a portfolio of data analysis work that is considered, communicated transparently and with humility.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The annotations in <a href="#fig-ft-vaccine" class="quarto-xref">Figure&nbsp;<span>8.5</span></a> have heavy saliency thanks to the parsimonious use of axis titles, marks and legends, and other non-data-ink <span class="citation" data-cites="tufte_visual_1983">(Tufte 1983)</span>.</p>
</div>
</div>
</section></section><section id="techniques" class="level2" data-number="8.3"><h2 data-number="8.3" class="anchored" data-anchor-id="techniques">
<span class="header-section-number">8.3</span> Techniques</h2>
<p>The technical element demonstrates how to design plots deliberatively with annotations in ggplot2. We will recreate a glyphmap type graphic that originally appeared in The Washington Post<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> <span class="citation" data-cites="thebault_reis_covid-19s_2020">(Thebault and Hauslohner 2020)</span> to tell a story of growth in Covid-19 cases by US county. The graphic is presented in <a href="#fig-wp" class="quarto-xref">Figure&nbsp;<span>8.6</span></a>. Each US county is represented as a line encoded by daily growth rates in new cases between 3rd May and 26th May 2020. Lines are positioned at the geographic centre of each county.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-wp" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-wp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/08/wp.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-wp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.6: Glyphmap design displaying growth in COVID-19 cases by US county, based on the design by <span class="citation" data-cites="thebault_reis_covid-19s_2020">Thebault and Hauslohner (2020)</span>, originally in <a href="https://www.washingtonpost.com/nation/2020/05/24/coronavirus-rural-america-outbreaks/?arc404=true">The Washington Post</a>.
</figcaption></figure>
</div>
</div>
</div>
<p><a href="#fig-wp" class="quarto-xref">Figure&nbsp;<span>8.6</span></a> is certainly data dense. Without careful decisions on which aspects to emphasise it would be quite unreadable. Line thickness is varied according to relative infection rates (cumulative cases/population size) and growth rate is double encoded with colour value – darker and steeper lines for higher growth rates. Even with these additions it is challenging to discern trajectories for every county, but instead a typical model or expectation of these trajectories can be learnt from visually scanning the graphic. That there is spatial autocorrelation in trajectories means an overall pattern of exposure can be inferred, before eyes are drawn to exceptions. Initially these are towards the extreme end: tall, steep, dark and thick lines suggesting rapid growth rates and high case rates. Secondary patterns can also be discerned, for example thick and mid-dark lines surrounded by lines that are generally lighter and thinner: counties that appear locally exceptional in having comparatively high growth and exposure rates.</p>
<p>The design is impressive, and there is an obvious benefit to showing growth rates in their spatial position. However, we are not looking at absolute numbers here. The counties that are most salient are not those with the largest case counts. Rather, they have experienced rapid growth since the number of cases reported on 3rd May. So the graphic is most certainly <em>partial</em> and <em>designed</em> to suit a particular purpose. A slight adjustment in the implementation in <a href="#fig-wp" class="quarto-xref">Figure&nbsp;<span>8.6</span></a> was to only show growth rates for counties that had non-negligible case counts on 3rd May (<span class="math inline">\geq20</span> cases).</p>
<p>Without the careful integration of annotations and non-standard legends, <a href="#fig-wp" class="quarto-xref">Figure&nbsp;<span>8.6</span></a> would not be so successful. The aim of this technical section is to demonstrate an approach to generating heavily designed annotations – custom legends, which are often necessary when communicating with maps. For more extensive demonstration of how charts can be annotated and refined, do see the Further Reading section of this chapter.</p>
<section id="import" class="level3" data-number="8.3.1"><h3 data-number="8.3.1" class="anchored" data-anchor-id="import">
<span class="header-section-number">8.3.1</span> Import</h3>
<ul>
<li>Download the <a href="./files/08-template.qmd">08-template.qmd</a> file and save it to your <code>vis4sds</code> project.</li>
<li>Open your <code>vis4sds</code> project in RStudio and load the template file by clicking <code>File</code> &gt; <code>Open File ...</code> &gt; <code>08-template.qmd</code>.</li>
</ul>
<p>The template file lists the required packages – <code>tidyverse</code> and <code>sf</code>. The data were collected using the <a href="https://kjhealy.github.io/covdata/"><code>covdata</code></a> package <span class="citation" data-cites="healy_covdata_2020">(Healy 2020)</span>, attributing the county-level cumulative cases dataset maintained by data journalists at <span class="citation" data-cites="nyt_coronavirus_2021">The New York Times (2021)</span>.</p>
<p>The template provides access to a version of this dataset that is ‘staged’ for charting. For this cases are filtered on the dates covered by the Washington Post graphic (3rd to 25th May); counties whose daily case counts were <span class="math inline">\geq20</span> cases on 3rd May are identified; calculated daily growth rates are anchored to case counts on 3rd May; calculated ‘end’ growth rates and daily counts for each county are calculated (those recorded on 25th May); and finally a binned growth rate variable identifying counties with daily case counts on 25rd May that were <span class="math inline">\leq2\times</span>, <span class="math inline">\geq2\times</span>, <span class="math inline">\geq4\times</span>, <span class="math inline">\geq7\times</span> the daily case counts measured on 3rd May. Also there is a <code>state_boundaries</code> dataset to download, which contains <code>geometry</code> data for each US state, collected from <a href="https://www.census.gov/geographies/mapping-files/time-series/geo/carto-boundary-file.html">US Census Bureau</a> as well as coordinate variables describing the geographic centroid of each state. The <a href="https://en.wikipedia.org/wiki/Albers_projection">Albers Equal Area</a> projection is used.</p>
</section><section id="plot-trajectories" class="level3" data-number="8.3.2"><h3 data-number="8.3.2" class="anchored" data-anchor-id="plot-trajectories">
<span class="header-section-number">8.3.2</span> Plot trajectories</h3>
<div class="cell">
<div class="cell-output-display">
<div id="fig-wp-basic" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-wp-basic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/08/wp-basic.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-wp-basic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.7: Glyphmap design displaying growth in COVID-19 cases by US county, without legend and annotations.
</figcaption></figure>
</div>
</div>
</div>
<p>The main graphic is reasonably straightforward to construct. Different from many of the data graphics in earlier chapters, the way in which growth lines are generated is somewhat low-level. Remembering that lines are initially positioned in x- and y- on their county centroid, we generate from the data positions in geographic space for each observation – growth rates recorded by day since 3rd May 2020.</p>
<p>The code:</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">county_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span></span>
<span>    data<span class="op">=</span><span class="va">state_boundaries</span>,</span>
<span>    fill<span class="op">=</span><span class="st">"#eeeeee"</span>, colour<span class="op">=</span><span class="st">"#ffffff"</span>, linewidth<span class="op">=</span><span class="fl">0.4</span></span>
<span>  <span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span>crs<span class="op">=</span><span class="fl">5070</span>, datum<span class="op">=</span><span class="cn">NA</span>, clip<span class="op">=</span><span class="st">"off"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span></span>
<span>    data<span class="op">=</span><span class="va">.</span><span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">date</span><span class="op">==</span><span class="st">"2020-05-03"</span><span class="op">)</span>,</span>
<span>    <span class="fu">aes</span><span class="op">(</span></span>
<span>      x<span class="op">=</span><span class="va">x</span>, y<span class="op">=</span><span class="va">y</span>, size<span class="op">=</span><span class="va">case_rate</span>, alpha<span class="op">=</span><span class="va">binned_growth_rate</span>,</span>
<span>      colour<span class="op">=</span><span class="va">binned_growth_rate</span></span>
<span>      <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Plot case data.</span></span>
<span>  <span class="fu">geom_path</span><span class="op">(</span></span>
<span>    <span class="fu">aes</span><span class="op">(</span></span>
<span>      x<span class="op">=</span><span class="va">x</span><span class="op">+</span><span class="op">(</span><span class="op">(</span><span class="va">day_num</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="fl">6000</span><span class="op">)</span>, y<span class="op">=</span><span class="va">y</span><span class="op">+</span><span class="op">(</span><span class="op">(</span><span class="va">growth_rate</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="fl">50000</span><span class="op">)</span>,</span>
<span>      group<span class="op">=</span><span class="va">fips</span>, linewidth<span class="op">=</span><span class="va">case_rate</span>, alpha<span class="op">=</span><span class="va">binned_growth_rate</span>,</span>
<span>      colour<span class="op">=</span><span class="va">binned_growth_rate</span><span class="op">)</span>,</span>
<span>      lineend<span class="op">=</span><span class="st">"round"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_colour_manual</span><span class="op">(</span></span>
<span>    values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#fa9fb5"</span>, <span class="st">"#dd3497"</span>, <span class="st">"#7a0177"</span>, <span class="st">"#49006a"</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_size</span><span class="op">(</span>range<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.1</span>,<span class="fl">1.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_linewidth</span><span class="op">(</span>range<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.3</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_alpha_ordinal</span><span class="op">(</span>range<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.2</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>colour<span class="op">=</span><span class="st">"none"</span>, size<span class="op">=</span><span class="st">"none"</span>, alpha<span class="op">=</span><span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The plot specification:</p>
<ol type="1">
<li>
<em>Data</em>: The main dataset – the staged <code>county_data</code> file. Separately there is a <code>state_boundaries</code> file used to draw state boundaries and later label states. For the points drawn at the centroid of each US county (<code>geom_point()</code>), the data are filtered so that only a single day is represented (<code>filter(date=="2020-05-03")</code>).</li>
<li>
<em>Encoding</em>: For <code>geom_point()</code>, x-position and y-position is mapped to county centroid (<code>x</code>,<code>y</code> variables in <code>county_data</code>), points are coloured according to <code>binned_growth_rate</code> using both <code>colour</code> and <code>alpha</code> and sized according to that county’s <code>case_rate</code>. The same colour and size encoding is used for the lines (<code>geom_path()</code>). County lines are again anchored at county centroids but offset in <code>x</code> according to time elapsed (<code>day_num</code>) and in <code>y</code> according to <code>growth_rate</code>. The constants applied to <code>growth_rate</code> (5000) and <code>day_num</code> (6000), which control the space occupied by the lines, was arrived at manually through trial and error. Note that these numbers are large as they relate to geographic coordinate space. In order to draw separate lines for each county, we set the <code>group=</code> argument to the county identifier variable <code>fips</code>.</li>
<li>
<em>Marks</em>: <code>geom_point()</code> for the start points centred on county centroids and <code>geom_path()</code> for the lines.</li>
<li>
<em>Scale</em>: <code>scale_colour_manual()</code> for the binned growth rate colours; <code>scale_alpha()</code> for an ordinal transparency range – the floor for this is 0.2 and not 0, otherwise counties with the smallest binned growth rates would not be visible; <code>scale_size()</code> and <code>scale_linewidth_size()</code> for varying the size of points and thickness of lines continuously according to case rate, the range was arrived at through trial and error.</li>
<li>
<em>Setting</em>: We don’t want the default legend to appear and so <code>guides()</code> turns these off; additionally <code>theme_void()</code> for removing default axes, gridlines etc.</li>
</ol></section><section id="add-labels-and-annotations" class="level3" data-number="8.3.3"><h3 data-number="8.3.3" class="anchored" data-anchor-id="add-labels-and-annotations">
<span class="header-section-number">8.3.3</span> Add labels and annotations</h3>
<p>The two-letter state boundaries, held in the <code>state_boundaries</code> file can be added in a <code>geom_text()</code> layer, positioned in <code>x</code> and <code>y</code> at state centroids. For obvious reasons this needs to appear <em>after</em> the first call to <code>geom_sf()</code>, which draws the filled state outlines:</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">county_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span></span>
<span>    data<span class="op">=</span><span class="va">state_boundaries</span>,</span>
<span>    fill<span class="op">=</span><span class="st">"#eeeeee"</span>, colour<span class="op">=</span><span class="st">"#ffffff"</span>, linewidth<span class="op">=</span><span class="fl">0.4</span></span>
<span>  <span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_text</span><span class="op">(</span>data<span class="op">=</span><span class="va">state_boundaries</span>, <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>,y<span class="op">=</span><span class="va">y</span>,label<span class="op">=</span><span class="va">STUSPS</span><span class="op">)</span>, alpha<span class="op">=</span><span class="fl">.8</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="va">...</span></span>
<span>  <span class="va">...</span></span>
<span>  <span class="va">...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For the counties annotated with accompanying growth rates we create a staged, filtered data frame containing only those counties and with just one row for each county. This is a little more tedious as we have to manually identify these in a <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code>. Note that we filter on <code>date</code> first, so that only one row is returned for each county. Within the <code>mutate()</code> some manual abbreviations are made for state names and also the <code>end_rate</code> variable is rounded to whole numbers for better labelling.</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Counties to annotate.</span></span>
<span><span class="va">annotate</span> <span class="op">&lt;-</span> <span class="va">county_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">date</span><span class="op">==</span><span class="st">"2020-05-03"</span>,</span>
<span>    <span class="va">county</span><span class="op">==</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Huntingdon"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">state</span><span class="op">==</span><span class="st">"Pennsylvania"</span> <span class="op">|</span></span>
<span>    <span class="va">county</span><span class="op">==</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Lenawee"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">state</span><span class="op">==</span><span class="st">"Michigan"</span> <span class="op">|</span></span>
<span>    <span class="va">county</span><span class="op">==</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Crawford"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">state</span><span class="op">==</span><span class="st">"Iowa"</span> <span class="op">|</span></span>
<span>    <span class="va">county</span><span class="op">==</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Wapello"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">state</span><span class="op">==</span><span class="st">"Iowa"</span> <span class="op">|</span></span>
<span>    <span class="va">county</span><span class="op">==</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Lake"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">state</span><span class="op">==</span><span class="st">"Tennessee"</span> <span class="op">|</span></span>
<span>    <span class="va">county</span><span class="op">==</span><span class="st">"Texas"</span> <span class="op">&amp;</span> <span class="va">state</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Oklahoma"</span><span class="op">)</span> <span class="op">|</span></span>
<span>    <span class="va">county</span><span class="op">==</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Duplin"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">state</span><span class="op">==</span><span class="st">"North Carolina"</span> <span class="op">|</span></span>
<span>    <span class="va">county</span><span class="op">==</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Santa Cruz"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">state</span><span class="op">==</span><span class="st">"Arizona"</span><span class="op">|</span></span>
<span>    <span class="va">county</span><span class="op">==</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Titus"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">state</span><span class="op">==</span><span class="st">"Texas"</span><span class="op">|</span></span>
<span>    <span class="va">county</span><span class="op">==</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Yakima"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">state</span><span class="op">==</span><span class="st">"Washington"</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    state_abbr<span class="op">=</span><span class="fu">case_when</span><span class="op">(</span></span>
<span>      <span class="va">state</span><span class="op">==</span><span class="st">"Pennsylvania"</span> <span class="op">~</span> <span class="st">"Penn."</span>,</span>
<span>      <span class="va">state</span><span class="op">==</span><span class="st">"Iowa"</span> <span class="op">~</span> <span class="st">"Iowa"</span>,</span>
<span>      <span class="va">state</span><span class="op">==</span><span class="st">"Tennessee"</span> <span class="op">~</span> <span class="st">"Tenn."</span>,</span>
<span>      <span class="va">state</span><span class="op">==</span><span class="st">"Oklahoma"</span> <span class="op">~</span> <span class="st">"Okla."</span>,</span>
<span>      <span class="va">state</span><span class="op">==</span><span class="st">"Texas"</span> <span class="op">~</span> <span class="st">"Texas"</span>,</span>
<span>      <span class="va">state</span><span class="op">==</span><span class="st">"North Carolina"</span> <span class="op">~</span> <span class="st">"N.C."</span>,</span>
<span>      <span class="va">state</span><span class="op">==</span><span class="st">"Washington"</span> <span class="op">~</span> <span class="st">"Wash."</span>,</span>
<span>      <span class="va">state</span><span class="op">==</span><span class="st">"Michigan"</span> <span class="op">~</span> <span class="st">"Mich."</span>,</span>
<span>      <span class="va">state</span><span class="op">==</span><span class="st">"Arizona"</span> <span class="op">~</span> <span class="st">"Arizona"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">""</span><span class="op">)</span>,</span>
<span>    end_rate_round <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">end_rate</span>,<span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Plotting these is again quite straightforward with <code>geom_text()</code>. The <code><a href="https://rdrr.io/r/base/paste.html">paste0()</a></code> function is used to build labels that display conty names (<code>county</code>) and then state abbreviations (<code>state_abbr</code>). These appear below each county and this is effected by offseting y-position. Additionally the counties are given a bold font by passing an argument to <code>fontface="bold"</code>. The same approach is used for the rate labels, but with an incremented y-position offset so that they don’t overlap the county name labels.</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">county_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data<span class="op">=</span><span class="va">state_boundaries</span>, fill<span class="op">=</span><span class="st">"#eeeeee"</span>, colour<span class="op">=</span><span class="st">"#ffffff"</span>, linewidth<span class="op">=</span><span class="fl">0.4</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="va">...</span></span>
<span>  <span class="va">...</span></span>
<span>  <span class="fu">geom_text</span><span class="op">(</span></span>
<span>    data<span class="op">=</span><span class="va">annotate</span>,</span>
<span>    <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>,y<span class="op">=</span><span class="va">y</span><span class="op">-</span><span class="fl">20000</span>,label<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">county</span>,<span class="st">", "</span>,<span class="va">state_abbr</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    size<span class="op">=</span><span class="fl">3</span>, fontface<span class="op">=</span><span class="st">"bold"</span></span>
<span>    <span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_text</span><span class="op">(</span></span>
<span>    data<span class="op">=</span><span class="va">annotate</span>,</span>
<span>    <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>,y<span class="op">=</span><span class="va">y</span><span class="op">-</span><span class="fl">65000</span>,label<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">end_rate_round</span>,<span class="st">"X more cases"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    size<span class="op">=</span><span class="fl">2.5</span></span>
<span>    <span class="op">)</span><span class="op">+</span></span>
<span>  <span class="va">...</span></span>
<span>  <span class="va">...</span></span>
<span>  <span class="va">...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="build-custom-legend" class="level3" data-number="8.3.4"><h3 data-number="8.3.4" class="anchored" data-anchor-id="build-custom-legend">
<span class="header-section-number">8.3.4</span> Build custom legend</h3>
<p>Since <a href="#fig-wp" class="quarto-xref">Figure&nbsp;<span>8.6</span></a> is a custom data graphic coded in a somewhat low-level way with <code>geom_segment()</code>, it is useful to accompany it with a more expressive legend. We therefore build our own legend from scratch, using the geographic space of the plot as our canvas.</p>
<div id="fig-legends" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-legends-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="columns">
<div class="column" style="width:47%;">
<div id="fig-wp-growth-legend" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-wp-growth-legend-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/08/wp-legend-growth.png" class="img-fluid figure-img" data-ref-parent="fig-legends">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-wp-growth-legend-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Growth rates
</figcaption></figure>
</div>
</div><div class="column" style="width:53%;">
<div id="fig-wp-case-legend" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-wp-case-legend-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/08/wp-legend-case.png" class="img-fluid figure-img" data-ref-parent="fig-legends">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-wp-case-legend-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Case rates
</figcaption></figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-legends-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.8: Custom legends used to demonstrate growth and case rates.
</figcaption></figure>
</div>
<p>To support positioning of the legend we extract the spatial limits, or bounding box, of our plot area – the mainland US.</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Bounding box for mainland US.</span></span>
<span><span class="va">bbox</span> <span class="op">&lt;-</span> <span class="fu">st_bbox</span><span class="op">(</span><span class="va">state_boundaries</span><span class="op">)</span></span>
<span><span class="va">width</span> <span class="op">&lt;-</span> <span class="va">bbox</span><span class="op">$</span><span class="va">xmax</span><span class="op">-</span><span class="va">bbox</span><span class="op">$</span><span class="va">xmin</span></span>
<span><span class="va">height</span> <span class="op">&lt;-</span> <span class="va">bbox</span><span class="op">$</span><span class="va">ymax</span><span class="op">-</span><span class="va">bbox</span><span class="op">$</span><span class="va">ymin</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then create a dataset for the top right legend displaying the different categories of growth rate – <a href="#fig-wp-growth-legend" class="quarto-xref">Figure&nbsp;<span>8.8 (a)</span></a>. Counties filtered by their different growth rates were identified manually. As you will see shortly we use exactly the same <em>encoding</em> as the main graphic for the example legend lines, but rather than positioning these selected counties in their real geographic position, we override their x- and y- location so that the lines appear in a margin to the top right of the graphic. This is achieved in the <code>mutate()</code>, where we set x-position to start at the right quarter of the graphic (<code>bbox$xmax-.25*width</code>) and y-position to start slightly above the top of the graphic <code>bbox$ymax+.05*height</code>. <code>case_rate</code> is set to a constant as we don’t want line width to vary and also a manually created <code>label</code> variable.</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Legend : growth</span></span>
<span><span class="va">legend_growth</span> <span class="op">&lt;-</span> <span class="va">county_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">county</span><span class="op">==</span><span class="st">"Dubois"</span> <span class="op">&amp;</span> <span class="va">state</span><span class="op">==</span><span class="st">"Indiana"</span> <span class="op">|</span></span>
<span>    <span class="va">county</span><span class="op">==</span><span class="st">"Androscoggin"</span> <span class="op">&amp;</span> <span class="va">state</span><span class="op">==</span><span class="st">"Maine"</span> <span class="op">|</span></span>
<span>    <span class="va">county</span><span class="op">==</span><span class="st">"Fairfax"</span> <span class="op">&amp;</span> <span class="va">state</span><span class="op">==</span><span class="st">"Virginia"</span> <span class="op">|</span></span>
<span>    <span class="va">county</span><span class="op">==</span><span class="st">"Bledsoe"</span> <span class="op">&amp;</span> <span class="va">state</span><span class="op">==</span><span class="st">"Tennessee"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    x<span class="op">=</span><span class="va">bbox</span><span class="op">$</span><span class="va">xmax</span><span class="op">-</span><span class="fl">.25</span><span class="op">*</span><span class="va">width</span>, y<span class="op">=</span><span class="va">bbox</span><span class="op">$</span><span class="va">ymax</span><span class="op">+</span><span class="fl">.05</span><span class="op">*</span><span class="va">height</span>,</span>
<span>    case_rate<span class="op">=</span><span class="fl">.01</span>,</span>
<span>    label<span class="op">=</span><span class="fu">case_when</span><span class="op">(</span></span>
<span>      <span class="va">county</span> <span class="op">==</span> <span class="st">"Dubois"</span> <span class="op">~</span> <span class="st">"7x more cases than on May 3"</span>,</span>
<span>      <span class="va">county</span> <span class="op">==</span> <span class="st">"Androscoggin"</span> <span class="op">~</span> <span class="st">"4x"</span>,</span>
<span>      <span class="va">county</span> <span class="op">==</span> <span class="st">"Fairfax"</span> <span class="op">~</span> <span class="st">"2x"</span>,</span>
<span>      <span class="va">county</span> <span class="op">==</span> <span class="st">"Bledsoe"</span> <span class="op">~</span> <span class="st">"About the same as on May 3"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A separate dataset is also created for drawing the top left legend – <a href="#fig-wp-case-legend" class="quarto-xref">Figure&nbsp;<span>8.8 (b)</span></a>, showing different case rates relative to population size. In the <code>mutate()</code> we set x-position to start towards the left of the graphic (<code>bbox$xmax-.88*width</code>) and y-position to start slightly above the top of the graphic <code>bbox$ymax+.05*height</code>. We want to draw three lines corresponding to a low, medium and high growth rate and so <code>pivot_longer()</code> to duplicate the daily case data over rows. Each line needs to be drawn next to one another and this is achieved with the <code>offset_day</code> variable, a multiple applied to the geographic <code>width</code> of US used later in the ggplot2 specification.</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Legend : case</span></span>
<span><span class="va">legend_case</span> <span class="op">&lt;-</span> <span class="va">county_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">county</span> <span class="op">==</span> <span class="st">"Kings"</span> <span class="op">&amp;</span> <span class="va">state</span><span class="op">==</span><span class="st">"California"</span> <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    x<span class="op">=</span><span class="va">bbox</span><span class="op">$</span><span class="va">xmax</span><span class="op">-</span><span class="fl">.88</span><span class="op">*</span><span class="va">width</span>,y<span class="op">=</span><span class="va">bbox</span><span class="op">$</span><span class="va">ymax</span><span class="op">+</span><span class="fl">.05</span><span class="op">*</span><span class="va">height</span>,</span>
<span>    binned_growth_rate<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">binned_growth_rate</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">day_num</span>, <span class="va">growth_rate</span>, <span class="va">binned_growth_rate</span>, <span class="va">fips</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>low<span class="op">=</span><span class="fl">.001</span>, mid<span class="op">=</span><span class="fl">.009</span>, high<span class="op">=</span><span class="fl">.015</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span></span>
<span>    cols<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">low</span>, <span class="va">mid</span>, <span class="va">high</span><span class="op">)</span>, names_to<span class="op">=</span><span class="st">"offset"</span>, values_to<span class="op">=</span><span class="st">"offset_rate"</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    offset_day<span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span></span>
<span>      <span class="va">offset</span> <span class="op">==</span> <span class="st">"low"</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="va">offset</span> <span class="op">==</span> <span class="st">"mid"</span> <span class="op">~</span> <span class="fl">.04</span>,</span>
<span>      <span class="va">offset</span> <span class="op">==</span> <span class="st">"high"</span> <span class="op">~</span> <span class="fl">.08</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="compose-graphic" class="level3" data-number="8.3.5"><h3 data-number="8.3.5" class="anchored" data-anchor-id="compose-graphic">
<span class="header-section-number">8.3.5</span> Compose graphic</h3>
<p>The code block below demonstrates how derived data for the legends are used in the ggplot2 specification. Exactly the same mappings are used in the legend as the main graphic, and so the call to <code>geom_path()</code> looks similar, except for the different use of x- and y- position. Labels for the legends are generated using <code>annotate()</code> and again positioned using location information contained in <code>bbox</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Text for annotations and titles.</span></span>
<span><span class="va">growth_text</span> <span class="op">&lt;-</span> <span class="st">"Line height and colour show change in reported cases</span></span>
<span><span class="st">relative to May 3"</span></span>
<span><span class="va">case_text</span> <span class="op">&lt;-</span> <span class="st">"Line thickness shows current number relative to</span></span>
<span><span class="st">county population"</span></span>
<span><span class="va">title_text</span> <span class="op">&lt;-</span> <span class="st">"Change in reported cases since May 3"</span></span>
<span></span>
<span><span class="va">county_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data<span class="op">=</span><span class="va">state_boundaries</span>, fill<span class="op">=</span><span class="st">"#eeeeee"</span>, colour<span class="op">=</span><span class="st">"#bcbcbc"</span>, linewidth<span class="op">=</span><span class="fl">0.4</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="va">...</span></span>
<span>  <span class="va">...</span></span>
<span>  <span class="va">...</span></span>
<span>  <span class="co"># Plot growth legend lines.</span></span>
<span>  <span class="fu">geom_path</span><span class="op">(</span></span>
<span>    data<span class="op">=</span><span class="va">legend_growth</span>,</span>
<span>    <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span><span class="op">+</span><span class="op">(</span><span class="op">(</span><span class="va">day_num</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="fl">6000</span><span class="op">)</span>, y<span class="op">=</span><span class="va">y</span><span class="op">+</span><span class="op">(</span><span class="op">(</span><span class="va">growth_rate</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="fl">50000</span><span class="op">)</span>,</span>
<span>      group<span class="op">=</span><span class="va">fips</span>, linewidth<span class="op">=</span><span class="va">case_rate</span>, alpha<span class="op">=</span><span class="va">binned_growth_rate</span>, colour<span class="op">=</span><span class="va">binned_growth_rate</span><span class="op">)</span>,</span>
<span>      lineend<span class="op">=</span><span class="st">"round"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Text label for growth legend lines.</span></span>
<span>  <span class="fu">geom_text</span><span class="op">(</span></span>
<span>    <span class="co"># For positioning manually edit growth_rate of Bledsoe.</span></span>
<span>    data<span class="op">=</span><span class="va">legend_growth</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">day_num</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">county_data</span><span class="op">$</span><span class="va">day_num</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">mutate</span><span class="op">(</span>growth_rate<span class="op">=</span><span class="fu">if_else</span><span class="op">(</span><span class="va">county</span><span class="op">==</span><span class="st">"Bledsoe"</span>, <span class="op">-</span><span class="fl">1</span>,<span class="va">growth_rate</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span><span class="op">+</span><span class="op">(</span><span class="va">day_num</span><span class="op">*</span><span class="fl">6000</span><span class="op">)</span><span class="op">+</span><span class="fl">10000</span>,y<span class="op">=</span><span class="va">y</span><span class="op">+</span><span class="op">(</span><span class="op">(</span><span class="va">growth_rate</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="fl">50000</span><span class="op">)</span>,</span>
<span>      label<span class="op">=</span><span class="fu">str_wrap</span><span class="op">(</span><span class="va">label</span>, <span class="fl">15</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      size<span class="op">=</span><span class="fl">2.5</span></span>
<span>      <span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span><span class="st">"text"</span>,</span>
<span>    x<span class="op">=</span><span class="va">bbox</span><span class="op">$</span><span class="va">xmax</span><span class="op">-</span><span class="fl">.25</span><span class="op">*</span><span class="va">width</span>, y<span class="op">=</span><span class="va">bbox</span><span class="op">$</span><span class="va">ymax</span><span class="op">+</span><span class="fl">.08</span><span class="op">*</span><span class="va">height</span>,</span>
<span>    label<span class="op">=</span><span class="fu">str_wrap</span><span class="op">(</span><span class="va">growth_text</span>,<span class="fl">35</span><span class="op">)</span>, size<span class="op">=</span><span class="fl">3.5</span>, hjust<span class="op">=</span><span class="fl">1</span></span>
<span>    <span class="op">)</span><span class="op">+</span></span>
<span>  <span class="co"># Plot case legend lines.</span></span>
<span>  <span class="fu">geom_path</span><span class="op">(</span></span>
<span>    data<span class="op">=</span><span class="va">legend_case</span>,</span>
<span>    <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span><span class="op">+</span><span class="op">(</span><span class="op">(</span><span class="va">day_num</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="fl">6000</span><span class="op">)</span><span class="op">+</span><span class="va">offset_day</span><span class="op">*</span><span class="va">width</span>, y<span class="op">=</span><span class="va">y</span><span class="op">+</span><span class="op">(</span><span class="op">(</span><span class="va">growth_rate</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="fl">50000</span><span class="op">)</span>,</span>
<span>      group<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">fips</span>,<span class="va">offset</span><span class="op">)</span>, linewidth<span class="op">=</span><span class="va">offset_rate</span>,</span>
<span>      alpha<span class="op">=</span><span class="va">binned_growth_rate</span>, colour<span class="op">=</span><span class="va">binned_growth_rate</span><span class="op">)</span>,</span>
<span>      lineend<span class="op">=</span><span class="st">"round"</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Text label for case legend lines.</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span><span class="st">"text"</span>,</span>
<span>    x<span class="op">=</span><span class="va">bbox</span><span class="op">$</span><span class="va">xmax</span><span class="op">-</span><span class="fl">.88</span><span class="op">*</span><span class="va">width</span>, y<span class="op">=</span><span class="va">bbox</span><span class="op">$</span><span class="va">ymax</span><span class="op">+</span><span class="fl">.04</span><span class="op">*</span><span class="va">height</span>, label<span class="op">=</span><span class="st">"Less"</span>, size<span class="op">=</span><span class="fl">2.5</span></span>
<span>    <span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span><span class="st">"text"</span>,</span>
<span>    x<span class="op">=</span><span class="va">bbox</span><span class="op">$</span><span class="va">xmax</span><span class="op">-</span><span class="fl">.8</span><span class="op">*</span><span class="va">width</span>, y<span class="op">=</span><span class="va">bbox</span><span class="op">$</span><span class="va">ymax</span><span class="op">+</span><span class="fl">.04</span><span class="op">*</span><span class="va">height</span>, label<span class="op">=</span><span class="st">"More"</span>, size<span class="op">=</span><span class="fl">2.5</span></span>
<span>    <span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span><span class="st">"text"</span>,</span>
<span>    x<span class="op">=</span><span class="va">bbox</span><span class="op">$</span><span class="va">xmax</span><span class="op">-</span><span class="fl">.75</span><span class="op">*</span><span class="va">width</span>, y<span class="op">=</span><span class="va">bbox</span><span class="op">$</span><span class="va">ymax</span><span class="op">+</span><span class="fl">.08</span><span class="op">*</span><span class="va">height</span>,</span>
<span>    label<span class="op">=</span><span class="fu">str_wrap</span><span class="op">(</span><span class="va">case_text</span>,<span class="fl">35</span><span class="op">)</span>, size<span class="op">=</span><span class="fl">3.5</span>, hjust<span class="op">=</span><span class="fl">0</span></span>
<span>    <span class="op">)</span><span class="op">+</span></span>
<span>  <span class="co"># Title.</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span><span class="st">"text"</span>,</span>
<span>    x<span class="op">=</span><span class="va">bbox</span><span class="op">$</span><span class="va">xmax</span><span class="op">-</span><span class="fl">.5</span><span class="op">*</span><span class="va">width</span>, y<span class="op">=</span><span class="va">bbox</span><span class="op">$</span><span class="va">ymax</span><span class="op">+</span><span class="fl">.15</span><span class="op">*</span><span class="va">height</span>,</span>
<span>    label<span class="op">=</span><span class="va">title_text</span>, size<span class="op">=</span><span class="fl">5</span></span>
<span>    <span class="op">)</span><span class="op">+</span></span>
<span>  <span class="va">...</span></span>
<span>  <span class="va">...</span></span>
<span>  <span class="va">...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="conclusions" class="level2" data-number="8.4"><h2 data-number="8.4" class="anchored" data-anchor-id="conclusions">
<span class="header-section-number">8.4</span> Conclusions</h2>
<p>Communicating effectively with data is not an easy undertaking. Difficult decisions must be made around how much detail to sacrifice in favour of clarity and simplicity of message. Visual approaches can help here, giving cues that order and prioritise information and that build explanatory narratives using metaphor and other rhetorical devices. There are stellar examples of this from in-house data journalism teams, most obviously in recent evidence-based stories around the Covid-19 pandemic. We have considered some of these and the careful design decisions made when communicating data-driven stories in light of data, audience and intended purpose. Many data journalists use ggplot2 as their visualization toolkit of choice and in the technical section we demonstrated how more <em>designed</em> graphics can be generated. This somewhat fiddly approach to creating graphics is different from the style of workflow envisaged in <a href="03-visual.html" class="quarto-xref"><span>Chapter 3</span></a> and <a href="04-explore.html" class="quarto-xref"><span>Chapter 4</span></a> on exploratory visual analysis. However, as demonstrated through the examples in this chapter and the book more generally, ggplot2 can be used for this more deliberative visualization design, making control over annotations, text labels and embedded graphics useful skills to develop.</p>
</section><section id="further-reading" class="level2" data-number="8.5"><h2 data-number="8.5" class="anchored" data-anchor-id="further-reading">
<span class="header-section-number">8.5</span> Further Reading</h2>
<p>Cédric Scherer’s excellent workshop at posit::conf(2023). Highly recommended as a resource for covering in a methodical way how to parameterise ggplot2 scales, coordinate systems, facets, annotation and labelling.</p>
<ul>
<li>Cédric Scherer, 2023. “Designing Data Visualizations to Successfully Tell a Story”, A posit::conf(2023) Workshop, <a href="https://posit-conf-2023.github.io/dataviz-storytelling/">posit-conf-2023.github.io/dataviz-storytelling/</a>
</li>
</ul>
<p>For a similarly excellent resource see:</p>
<ul>
<li>Kieran Healy, 2019. “Data Visualization: A Practical Introduction”. <em>Princeton University Press</em>.
<ul>
<li>Chapter 8</li>
</ul>
</li>
</ul>
<p>Data journalists at the BBC have assembled a useful ‘cookbook’ demonstrating basic but useful edits to standard ggplot2 graphics.</p>
<ul>
<li>BBC, 2019. “BBC Visual and Data Journalism cookbook for R graphics”, <a href="https://bbc.github.io/rcookbook/">bbc.github.io/rcookbook/</a>
</li>
</ul>
<p>High-level but principled description of how to incorporate annotations, customise scales and legends when generating plots for communication.</p>
<ul>
<li>Wickham, H., Çetinkaya-Rundel, M., Grolemund, G. 2023, “R for Data Science, 2nd Edition”, <em>O’Rielly</em>.
<ul>
<li>Chapter 12.</li>
</ul>
</li>
</ul>


</section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p><code>https://www.hippocraticpost.com/covid-19-update/how-to-tell-if-were-beating-covid-19/</code><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p><code>https://flourish.studio/2021/04/06/masters-connected-scatter-maarten-lambrechts/</code><a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p><code>https://www.washingtonpost.com/nation/2020/05/24/coronavirus-rural-america-outbreaks/?arc404=true</code><a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/vis4sds\/vis4sds");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./07-uncertainty.html" class="pagination-link" aria-label="Uncertainty">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Uncertainty</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./references.html" class="pagination-link" aria-label="References">
        <span class="nav-page-text">References</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/vis4sds/vis4sds/edit/master/08-storytelling.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></div></div></footer></body></html>