<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Visualization for Social Data Science - 2&nbsp; Data Fundamentals</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./03-visual.html" rel="next">
<link href="./01-intro.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script src="site_libs/kePrint-0.0.1/kePrint.js"></script><link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./02-data.html"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data Fundamentals</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Visualization for Social Data Science</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/vis4sds/vis4sds/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-data.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data Fundamentals</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-visual.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Visualization Fundamentals</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-explore.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Exploratory Data Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-network.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Geographic Networks</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-model.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-uncertainty.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Uncertainty</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-storytelling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Visual Storytelling</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./a1-tasks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Task Answers</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./a2-references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">2.1</span> Introduction</a></li>
  <li>
<a href="#concepts" id="toc-concepts" class="nav-link" data-scroll-target="#concepts"><span class="header-section-number">2.2</span> Concepts</a>
  <ul class="collapse">
<li><a href="#data-frames" id="toc-data-frames" class="nav-link" data-scroll-target="#data-frames"><span class="header-section-number">2.2.1</span> Data frames</a></li>
  <li><a href="#types-of-variable" id="toc-types-of-variable" class="nav-link" data-scroll-target="#types-of-variable"><span class="header-section-number">2.2.2</span> Types of variable</a></li>
  <li><a href="#types-of-observation" id="toc-types-of-observation" class="nav-link" data-scroll-target="#types-of-observation"><span class="header-section-number">2.2.3</span> Types of observation</a></li>
  <li><a href="#tidy-data" id="toc-tidy-data" class="nav-link" data-scroll-target="#tidy-data"><span class="header-section-number">2.2.4</span> Tidy data</a></li>
  </ul>
</li>
  <li>
<a href="#techniques" id="toc-techniques" class="nav-link" data-scroll-target="#techniques"><span class="header-section-number">2.3</span> Techniques</a>
  <ul class="collapse">
<li><a href="#import" id="toc-import" class="nav-link" data-scroll-target="#import"><span class="header-section-number">2.3.1</span> Import</a></li>
  <li><a href="#manipulate" id="toc-manipulate" class="nav-link" data-scroll-target="#manipulate"><span class="header-section-number">2.3.2</span> Manipulate</a></li>
  <li><a href="#tidy" id="toc-tidy" class="nav-link" data-scroll-target="#tidy"><span class="header-section-number">2.3.3</span> Tidy</a></li>
  </ul>
</li>
  <li><a href="#conclusions" id="toc-conclusions" class="nav-link" data-scroll-target="#conclusions"><span class="header-section-number">2.4</span> Conclusions</a></li>
  <li><a href="#further-reading" id="toc-further-reading" class="nav-link" data-scroll-target="#further-reading"><span class="header-section-number">2.5</span> Further Reading</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title"><span id="sec-data" class="quarto-section-identifier"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data Fundamentals</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p>By the end of this chapter you should gain the following knowledge and practical skills.</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Knowledge outcomes
</div>
</div>
<div class="callout-body-container callout-body">
<ul class="task-list">
<li><label><input type="checkbox">Learn the vocabulary and concepts used to describe data.</label></li>
<li><label><input type="checkbox">Appreciate the characteristics and importance of tidy data <span class="citation" data-cites="wickham_tidy_2014">(<a href="a2-references.html#ref-wickham_tidy_2014" role="doc-biblioref">Wickham 2014</a>)</span>.</label></li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Skills outcomes
</div>
</div>
<div class="callout-body-container callout-body">
<ul class="task-list">
<li><label><input type="checkbox">Read-in large external files as data frames.</label></li>
<li><label><input type="checkbox">Calculate descriptive summaries over datasets using <code>dplyr</code>.</label></li>
<li><label><input type="checkbox">Learn how to structure, join and reshape data using <code>dplyr</code> and <code>tidyr</code>.</label></li>
<li><label><input type="checkbox">Create statistical graphics for initial data description and exploration.</label></li>
</ul>
</div>
</div>
<section id="introduction" class="level2" data-number="2.1"><h2 data-number="2.1" class="anchored" data-anchor-id="introduction">
<span class="header-section-number">2.1</span> Introduction</h2>
<p>This chapter covers the basics of how to describe and organise data. While this might sound prosaic, there are several reasons why being able to consistently describe a dataset is important. First, it is the initial step in any analysis and helps delimit the analytical procedures that can be deployed. This is especially relevant to modern data analysis, where it is common to apply the same analysis templates over many different datasets. Describing data using a consistent vocabulary enables you to identify which analysis templates to reuse. Second, relates to the point in <a href="01-intro.html" class="quarto-xref">Chapter&nbsp;<span>1</span></a>, that social data science projects usually involve repurposing datasets for the first time. It is often not obvious whether a dataset contains sufficient detail and structure to characterise the behaviours being researched and the target populations it is assumed to represent. This leads to additional levels of uncertainty and places greater importance on the initial steps of data processing, description and exploration.</p>
<p>Through the chapter we will develop vocabulary for describing and thinking about data, as well as some of the most important data processing and organisation techniques in R. We will do so using data from New York’s Citibike system.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Data vocabulary
</div>
</div>
<div class="callout-body-container callout-body">
<p>A consistent vocabulary for describing data is especially useful when learning modern visualization toolkits like <code>ggplot2</code>, <code>Tableau</code> and <code>vega-lite</code>. We will expand upon this in some detail in <a href="03-visual.html" class="quarto-xref">Chapter&nbsp;<span>3</span></a> as we introduce the fundamentals of visualization design and the Grammar of Graphics <span class="citation" data-cites="wilkinson_grammar_1999">(<a href="a2-references.html#ref-wilkinson_grammar_1999" role="doc-biblioref">Wilkinson 1999</a>)</span>.</p>
</div>
</div>
</section><section id="concepts" class="level2" data-number="2.2"><h2 data-number="2.2" class="anchored" data-anchor-id="concepts">
<span class="header-section-number">2.2</span> Concepts</h2>
<section id="data-frames" class="level3" data-number="2.2.1"><h3 data-number="2.2.1" class="anchored" data-anchor-id="data-frames">
<span class="header-section-number">2.2.1</span> Data frames</h3>
<p> Throughout this book we will work with data frames. These are spreadsheet-like representations where rows are observations and columns are variables. In an R data frame, variables are vectors that must be of equal length. Where observations have missing values, for certain variables the missing values must be substituted with something, usually with <code>NA</code> or similar. This constraint can cause difficulties. For example, when working with variables that contain many values of different length for an observation, we create a special class of column, a <code>list-column</code>. Organising data according to this simple structure – rows as observations, columns as variables – is useful for developing analysis templates that work with the <code>tidyverse</code> package ecosystem.</p>
</section><section id="types-of-variable" class="level3" data-number="2.2.2"><h3 data-number="2.2.2" class="anchored" data-anchor-id="types-of-variable">
<span class="header-section-number">2.2.2</span> Types of variable</h3>
<p> A familiar classification for describing data is that developed by <span class="citation" data-cites="stevens_on_1946">Stevens (<a href="a2-references.html#ref-stevens_on_1946" role="doc-biblioref">1946</a>)</span> when considering the level of measurement of a variable. <span class="citation" data-cites="stevens_on_1946">Stevens (<a href="a2-references.html#ref-stevens_on_1946" role="doc-biblioref">1946</a>)</span> organises variables into two classes: variables that describe <em>categories</em> of things and variables that describe <em>measurements</em> of things.</p>
<p> Categories include attributes like gender, customer segments, ranked orders (1st, 2nd, 3rd largest etc.). Measurements include quantities like distance, age and travel time. Categories can be further subdivided into those that are unordered (<em>nominal</em>) and those that are ordered (<em>ordinal</em>). Measurements can also be subdivided. <em>Interval</em> measurements are quantities where the computed difference between two values is meaningful. <em>Ratio</em> measurements have this property, but also have a meaningful <code>0</code>, where <code>0</code> means the absence of something, and the ratio of two values can be computed. </p>
<p>Why is this useful? The measurement level of a variable determines the types of data analysis operations that can be performed and therefore allows us to make quick decisions when working with a dataset for the first time <span>(<a href="#tbl-variable-types" class="quarto-xref">Table&nbsp;<span>2.1</span></a>)</span>.</p>
<!-- ::: {.landscape} -->
<div class="cell">
<div id="tbl-variable-types" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-variable-types-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2.1: Breakdown of variable types and corresponding mathematical operations.
</figcaption><div aria-describedby="tbl-variable-types-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div>
<table class="do-not-create-environment cell table table-sm table-striped small" data-quarto-postprocess="true">
<thead><tr class="header">
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">Measurement</th>
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">Example</th>
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">Operators</th>
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">Midpoint</th>
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">Spread</th>
</tr></thead>
<tbody>
<tr class="odd" data-grouplength="2">
<td colspan="5" style="border-bottom: 0px solid">Categories</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em; width: 8em; font-family: Monospace;" data-indentlevel="1">Nominal</td>
<td style="text-align: left;">Political parties; street names</td>
<td style="text-align: left; width: 8em; font-family: Monospace;">= ≠</td>
<td style="text-align: left;">mode</td>
<td style="text-align: left;">entropy</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em; width: 8em; font-family: Monospace;" data-indentlevel="1">Ordinal</td>
<td style="text-align: left;">Terrorism threat levels</td>
<td style="text-align: left; width: 8em; font-family: Monospace;">= ≠ &lt;&gt;</td>
<td style="text-align: left;">median</td>
<td style="text-align: left;">percentile</td>
</tr>
<tr class="even" data-grouplength="2">
<td colspan="5" style="border-bottom: 0px solid">Measures</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em; width: 8em; font-family: Monospace;" data-indentlevel="1">Interval</td>
<td style="text-align: left;">Temperatures; years</td>
<td style="text-align: left; width: 8em; font-family: Monospace;">= ≠ &lt;&gt; + -</td>
<td style="text-align: left;">mean</td>
<td style="text-align: left;">variance</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em; width: 8em; font-family: Monospace;" data-indentlevel="1">Ratio</td>
<td style="text-align: left;">Distances; prices</td>
<td style="text-align: left; width: 8em; font-family: Monospace;">= ≠ &lt;&gt; + - | × ÷</td>
<td style="text-align: left;">mean</td>
<td style="text-align: left;">variance</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</figure>
</div>
</div>
<div id="tbl-variable-types-tex" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-variable-types-tex-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2.2: Breakdown of variable types and corresponding mathematical operations.
</figcaption><div aria-describedby="tbl-variable-types-tex-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">

</div>
</figure>
</div>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task 1
</div>
</div>
<div class="callout-body-container callout-body">
<p>Complete the data description table below identifying the <em>measurement level</em> of each variable in the New York bikeshare stations dataset.</p>
<table class="table">
<thead><tr class="header">
<th>Variable name</th>
<th>Variable value</th>
<th>Measurement level</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>name</code></td>
<td>“Central Park”</td>
<td><enter here=""></enter></td>
</tr>
<tr class="even">
<td><code>capacity</code></td>
<td>80</td>
<td></td>
</tr>
<tr class="odd">
<td><code>rank_capacity</code></td>
<td>45</td>
<td></td>
</tr>
<tr class="even">
<td><code>date_opened</code></td>
<td>“2014-05-23”</td>
<td></td>
</tr>
<tr class="odd">
<td><code>longitude</code></td>
<td>-74.00149746</td>
<td></td>
</tr>
<tr class="even">
<td><code>latitude</code></td>
<td>40.74177603</td>
<td></td>
</tr>
</tbody>
</table>
</div>
</div>
<p></p>
</section><section id="types-of-observation" class="level3" data-number="2.2.3"><h3 data-number="2.2.3" class="anchored" data-anchor-id="types-of-observation">
<span class="header-section-number">2.2.3</span> Types of observation</h3>
<p> Observations form an entire population or a sample that we expect is representative of a target population. In social data science applications we often work with datasets that are so-called population-level. The Citibike dataset is a complete, population-level dataset in that every Citibike journey is recorded. Whether or not this is truly a population-level dataset, however, depends on the analysis purpose. When analysing trips made by Citibike users, are we interested only in those cyclists? Or are we taking the patterns observed through our analysis to make inferences about New York cycling more generally? If the latter, then there are problems as the level of detail we have on our sample is pretty trivial compared to traditional, actively-collected datasets, where data collection activities are designed with a target population in mind. It may therefore be difficult to gauge how representative Citibike users and Citibike cycling is of New York’s general cycling population. The flipside is that so-called passively-collected data may not suffer from the same problems of non-response bias and social-desirability bias as traditional, actively-collected data.</p>
</section><section id="tidy-data" class="level3" data-number="2.2.4"><h3 data-number="2.2.4" class="anchored" data-anchor-id="tidy-data">
<span class="header-section-number">2.2.4</span> Tidy data</h3>
<p> We will work with data frames organised such that columns always and only refer to variables and rows always and only refer to observations. This arrangement, called <em>tidy</em> <span class="citation" data-cites="wickham_tidy_2014">(<a href="a2-references.html#ref-wickham_tidy_2014" role="doc-biblioref">Wickham 2014</a>)</span>, has two key advantages. First, if data are arranged in this tidy form, then it is easier to apply and re-use tools for wrangling them as they have the same underlying structure. Second, placing variables into columns with each column containing a vector of values, means that we can take advantage of R’s vectorised functions for transforming data. This is demonstrated in the technical element of the chapter.</p>
<p>The three rules for tidy data <span class="citation" data-cites="wickham_tidy_2014">(<a href="a2-references.html#ref-wickham_tidy_2014" role="doc-biblioref">Wickham 2014</a>)</span>:</p>
<ol type="1">
<li>Each variable forms a column.</li>
<li>Each observation forms a row.</li>
<li>Each type of observation unit forms a table.</li>
</ol>
<p>The concept of tidy data, and its usefulness for <code>tidyverse</code>-style operations, is best explained through example. The technical element to this chapter is therefore comparatively lengthy and demonstrates key coding templates for organising and re-organising data frames for analysis.</p>
</section></section><section id="techniques" class="level2" data-number="2.3"><h2 data-number="2.3" class="anchored" data-anchor-id="techniques">
<span class="header-section-number">2.3</span> Techniques</h2>
<p>In this section we import, describe, transform and tidy data from New York’s Citibike bikeshare system.</p>
<ul>
<li>Download the <code>02-template.qmd</code><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> file, and save it to your <code>vis4sds</code> project, created in Chapter <a href="01-intro.html" class="quarto-xref"><span>1</span></a>.</li>
<li>Open your <code>vis4sds</code> project in RStudio, and load the template file by clicking <code>File</code> &gt; <code>Open File ...</code> &gt; <code>02-template.qmd</code>.</li>
</ul>
<section id="import" class="level3" data-number="2.3.1"><h3 data-number="2.3.1" class="anchored" data-anchor-id="import">
<span class="header-section-number">2.3.1</span> Import</h3>
<p>In the template file there is documentation on how to set up your R session with key packages – <code>tidyverse</code> , <code>fst</code>, <code>lubridate</code>, <code>sf</code>. The data were collected using the <code>bikedata</code> R package. A subset of data from New York’s bikeshare system, Citibike, were collected for this chapter and can be downloaded from the book’s accompanying data repository<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>.</p>
<p> The code for reading in these data may be familiar to most readers. The <code>here</code> package, which reliably creates paths relative to a project’s root, is used to pass the locations at which the New York trips and stations data are stored as a parameter to <code>read_csv()</code> and <code>read_fst()</code>. Notice that we use <em>assignment</em> (<code>&lt;-</code>), so data are loaded as objects and appear in the Environment pane of RStudio.</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Read in local copies of the trips and stations data.</span></span>
<span><span class="va">ny_trips</span> <span class="op">&lt;-</span> <span class="fu">read_fst</span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"ny_trips.fst"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ny_stations</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"ny_stations.csv"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<code>fst</code> for in-memory analysis
</div>
</div>
<div class="callout-body-container callout-body">
<p> <code>fst</code> is a special class of file that implements in the background various operations to speed-up reading and writing of data. This makes it possible to work with large datasets in-memory in R rather than connecting to a database and returning data summaries/subsets.</p>
</div>
</div>
<p>Inspecting the layout of the stations data with <code>View(ny_stations)</code> you will notice that the top line is the header and contains column (variable) names. The <code>glimpse()</code> function can be used to quickly describe a data frame’s dimensions. We have 500,000 trip observations in <code>ny_trips</code> and 11 variables; the 500,000 represents a random sample of c.1.9 million trips recorded in June 2020. The function also prints out the object type for each of these variables, with the variables either of type <code>int</code>, <code>chr</code> or <code>dbl</code>.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-view-annotate" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-view-annotate-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/02/view.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-view-annotate-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.1: <code>ny_trips</code> and <code>ny_stations</code> as they appear when calling <code><a href="https://rdrr.io/r/utils/View.html">View()</a></code>.
</figcaption></figure>
</div>
</div>
</div>
<p>In this case the assignment needs correcting. <code>start_time</code> and <code>stop_time</code> may be better represented in <code>date-time</code> format; the station identifier variables (e.g.&nbsp;<code>start_station_id</code>) are more efficient when converted to <code>int</code> types; and the geographic coordinates, currently stored as text strings (<code>chr</code>), are better converted as floating points (<code>dbl</code>) or <code>POINT</code> geometry types <span class="citation" data-cites="pebesma_simple_2018">(<a href="a2-references.html#ref-pebesma_simple_2018" role="doc-biblioref">Pebesma 2018</a>)</span>. In the <code>02-template.qmd</code> file are code chunks for doing these conversions. There are some slightly more involved data transform procedures in this code, which you may wish to ignore at this stage.</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">glimpse</span><span class="op">(</span><span class="va">ny_trips</span><span class="op">)</span></span>
<span><span class="co">## Rows: 500,000</span></span>
<span><span class="co">## Columns: 11</span></span>
<span><span class="co">## $ id               &lt;int&gt; 1, 2, 3, 4, 5, 6, 7…</span></span>
<span><span class="co">## $ city             &lt;chr&gt; "ny", "ny", "ny", "n.."</span></span>
<span><span class="co">## $ trip_duration    &lt;dbl&gt; 1062, 3810, 1017, 226..</span></span>
<span><span class="co">## $ start_time       &lt;chr&gt; "2020-06-01 00:00:03", ...</span></span>
<span><span class="co">## $ stop_time        &lt;chr&gt; "2020-06-01 00:17:46", ...</span></span>
<span><span class="co">## $ start_station_id &lt;chr&gt; "ny3419", "ny366", "ny389", ...</span></span>
<span><span class="co">## $ end_station_id   &lt;chr&gt; "ny3419", "ny336", "ny3562", ...</span></span>
<span><span class="co">## $ bike_id          &lt;chr&gt; "39852", "37558", "37512", ...</span></span>
<span><span class="co">## $ user_type        &lt;chr&gt; "Customer", "Subscriber", ...</span></span>
<span><span class="co">## $ birth_year       &lt;chr&gt; "1997", "1969", "1988", ...</span></span>
<span><span class="co">## $ gender           &lt;dbl&gt; 2, 0, 2, 0, 2, 1, 2, 2, ...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">glimpse</span><span class="op">(</span><span class="va">ny_stations</span><span class="op">)</span></span>
<span><span class="co">## Rows: 1,010</span></span>
<span><span class="co">## Columns: 6</span></span>
<span><span class="co">## $ id        &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, ...</span></span>
<span><span class="co">## $ city      &lt;chr&gt; "ny", "ny", "ny", "ny", "ny", "n..."</span></span>
<span><span class="co">## $ stn_id    &lt;chr&gt; "ny116", "ny119", "ny120", "ny127", "n..."</span></span>
<span><span class="co">## $ name      &lt;chr&gt; "W 17 St &amp; 8 Ave", "Park Ave", "B…."</span></span>
<span><span class="co">## $ longitude &lt;chr&gt; "-74.00149746", "-73.97803415", "..."</span></span>
<span><span class="co">## $ latitude  &lt;chr&gt; "40.74177603", "40.69608941", "..."</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="tbl-data-types" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-data-types-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2.3: A breakdown of data types in R.
</figcaption><div aria-describedby="tbl-data-types-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">

</div>
</figure>
</div>
</section><section id="manipulate" class="level3" data-number="2.3.2"><h3 data-number="2.3.2" class="anchored" data-anchor-id="manipulate">
<span class="header-section-number">2.3.2</span> Manipulate</h3>
<section id="manipulate-with-dplyr-and-pipes" class="level4 unnumbered"><h4 class="unnumbered anchored" data-anchor-id="manipulate-with-dplyr-and-pipes">Manipulate with <code>dplyr</code> and pipes (<code>|&gt;</code>)</h4>
<p></p>
<p><code>dplyr</code> is the foundational package of the tidyverse. It provides a <em>grammar of data manipulation</em>, with access to functions that can be variously combined to support most data processing and manipulation tasks. Once familiar with <code>dplyr</code> functions, you will find yourself generating analysis templates to re-use whenever working on a dataset.</p>
<p>All <code>dplyr</code> functions operate in a consistent way:</p>
<ol type="1">
<li>Start with a data frame.</li>
<li>Pass arguments to a function performing some updates to the data frame.</li>
<li>Return the updated data frame.</li>
</ol>
<p>So every <code>dplyr</code> function expects a data frame and will always return a data frame.</p>
<div id="tbl-dplyr-verbs-tex" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-dplyr-verbs-tex-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2.4: dplyr functions (verbs) for manipulating data frames.
</figcaption><div aria-describedby="tbl-dplyr-verbs-tex-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">

</div>
</figure>
</div>
<div class="cell">
<div id="tbl-dplyr-verbs" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-dplyr-verbs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2.5: dplyr functions (verbs) for manipulating data frames.
</figcaption><div aria-describedby="tbl-dplyr-verbs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div>
<table class="do-not-create-environment cell table table-sm table-striped small" data-quarto-postprocess="true">
<thead><tr class="header">
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">function()</th>
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left; font-family: Monospace;">filter()</td>
<td style="text-align: left;">Picks rows (observations) if their values match a specified criteria</td>
</tr>
<tr class="even">
<td style="text-align: left; font-family: Monospace;">arrange()</td>
<td style="text-align: left;">Reorders rows (observations) based on their values</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-family: Monospace;">select()</td>
<td style="text-align: left;">Picks a subset of columns (variables) by name (or name characteristics)</td>
</tr>
<tr class="even">
<td style="text-align: left; font-family: Monospace;">rename()</td>
<td style="text-align: left;">Changes the name of columns in the data frame</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-family: Monospace;">mutate()</td>
<td style="text-align: left;">Adds new columns</td>
</tr>
<tr class="even">
<td style="text-align: left; font-family: Monospace;">group_by()</td>
<td style="text-align: left;">Chunks the dataset into groups for grouped operations</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-family: Monospace;">summarise()</td>
<td style="text-align: left;">Calculates single-row (non-grouped) or multiple-row (if grouped) summary values</td>
</tr>
<tr class="even">
<td style="text-align: left; font-family: Monospace;">...</td>
<td style="text-align: left;"></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</figure>
</div>
</div>
<p><code>dplyr</code> functions are designed to be chained together, and this chaining of functions can be achieved using the <em>pipe</em> operator (<code>|&gt;</code>). Pipes are mechanisms for passing information in a program. They take the output of a set of code (a <code>dplyr</code> specification) and make it the input of the next set (another <code>dplyr</code> specification). Pipes can be easily applied to <code>dplyr</code> functions and the functions of all packages that form the <code>tidyverse</code>. We mentioned in <a href="01-intro.html" class="quarto-xref"><span>Chapter 1</span></a> that ggplot2 provides a framework for specifying a <em>layered grammar of graphics</em> (more on this in <a href="03-visual.html" class="quarto-xref"><span>Chapter 3</span></a>). Together with the pipe operator, <code>dplyr</code> supports a <em>layered grammar of data manipulation</em>. You will see this throughout the book as we develop and re-use code templates for performing some data manipulation that is then piped to a ggplot2 specification for visual analysis.</p>
</section><section id="count-and-summarise-over-rows" class="level4 unnumbered"><h4 class="unnumbered anchored" data-anchor-id="count-and-summarise-over-rows">
<code>count()</code> and <code>summarise()</code> over rows</h4>
<p>Let’s combine some <code>dplyr</code> functions to generate statistical summaries of the New York bikeshare data. First we’ll count the number of trips made in June 2020 by <code>user_type</code>, a variable distinguishing casual users from those formally registered to use the system (<code>Customer</code> vs.&nbsp;<code>Subscriber</code> cyclists). <code>dplyr</code> has a convenience function for counting, so we could run the code below, also in the <code>02-template.qmd</code> for this chapter.</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Take the ny_trips data frame.</span></span>
<span><span class="va">ny_trips</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Run the count function and sort the result.</span></span>
<span>  <span class="fu">count</span><span class="op">(</span><span class="va">user_type</span>, sort<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">##    user_type      n</span></span>
<span><span class="co">## 1 Subscriber 347204</span></span>
<span><span class="co">## 2   Customer 152796</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are a few things happening in the <code>count()</code> function. It takes the <code>usr_type</code> variable from <code>ny_trips</code>, organises or <em>groups</em> the rows in the data frame according to its values (<code>Customer</code> | <code>Subscriber</code>), counts the rows and then orders the summarised output descending on the counts.</p>
<p>Often you will want to do more than simply counting, and you may also want to be more explicit in the way the data frame is grouped for computation. A common workflow is to combine <code>group_by()</code> and <code>summarise()</code>, and in this case <code>arrange()</code> to replicate the <code>count()</code> example.</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Take the ny_trips data frame.</span></span>
<span><span class="va">ny_trips</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Group by user_type.</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">user_type</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="co"># Count the number of observations per group.</span></span>
<span>    <span class="fu">summarise</span><span class="op">(</span>count<span class="op">=</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="co"># Arrange the grouped and summarised (collapsed) rows in count.</span></span>
<span>    <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 2</span></span>
<span><span class="co">##   user_type   count</span></span>
<span><span class="co">##   &lt;chr&gt;       &lt;int&gt;</span></span>
<span><span class="co">## 1 Subscriber 347204</span></span>
<span><span class="co">## 2 Customer   152796</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In <code>ny_trips</code> there is a variable measuring trip duration in seconds (<code>trip_duration</code>). It may be instructive to calculate some summary statistics to see how trip duration varies between these groups. The code below uses <code>group_by()</code>, <code>summarise()</code> and <code>arrange()</code> in exactly the same way, but with the addition of other aggregate functions summarises the <code>trip_duration</code> variable according to central tendency (mean and standard deviation) and by <code>user_type</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Take the ny_trips data frame.</span></span>
<span><span class="va">ny_trips</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>trip_duration<span class="op">=</span><span class="va">trip_duration</span><span class="op">/</span><span class="fl">60</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Group by user type.</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">user_type</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Summarise over the grouped rows,</span></span>
<span>  <span class="co"># generate a new variable for each type of summary.</span></span>
<span>  <span class="fu">summarise</span><span class="op">(</span></span>
<span>    count<span class="op">=</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    avg_duration<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">trip_duration</span><span class="op">)</span>,</span>
<span>    median_duration<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">trip_duration</span><span class="op">)</span>,</span>
<span>    sd_duration<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">trip_duration</span><span class="op">)</span>,</span>
<span>    min_duration<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">trip_duration</span><span class="op">)</span>,</span>
<span>    max_duration<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">trip_duration</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Arrange on the count variable.</span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## # A tibble: 2 × 7</span></span>
<span><span class="co">##   user_type   count avg_dur med_dur sd_dur min_dur max_dur</span></span>
<span><span class="co">##   &lt;chr&gt;       &lt;int&gt; &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;</span></span>
<span><span class="co">## 1 Subscriber 347204  20.3   14.4    116.   1.02    33090.</span></span>
<span><span class="co">## 2 Customer   152796  43.3   23.1    383.   1.02    46982.</span></span>
<span><span class="co">## # … with abbreviated variable names</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As each line is commented you hopefully get a sense of what is happening in the code above. Since <code>dplyr</code> functions read like verbs, and code is executed sequentially, it greatly helps to organise <code>dplyr</code> code such that each new verb (function call) occupies a single line, separated with a pipe (<code>|&gt;</code>). Once you are familiar with <code>dplyr</code>, it becomes very easy to read, write, re-use and share code in this way.</p>
<div id="tbl-aggregate-functions-tex" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-aggregate-functions-tex-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2.6: A breakdown of aggregate functions commonly used with <code>summarise()</code>.
</figcaption><div aria-describedby="tbl-aggregate-functions-tex-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">

</div>
</figure>
</div>
<div class="cell">
<div id="tbl-aggregate-functions" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-aggregate-functions-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2.7: A breakdown of aggregate functions commonly used with <code>summarise()</code>.
</figcaption><div aria-describedby="tbl-aggregate-functions-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div>
<table class="do-not-create-environment cell table table-sm table-striped small" data-quarto-postprocess="true">
<thead><tr class="header">
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">Function</th>
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left; font-family: Monospace;">n()</td>
<td style="text-align: left;">Counts the number of observations</td>
</tr>
<tr class="even">
<td style="text-align: left; font-family: Monospace;">n_distinct(var)</td>
<td style="text-align: left;">Counts the number of unique observations</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-family: Monospace;">sum(var)</td>
<td style="text-align: left;">Sums the values of observations</td>
</tr>
<tr class="even">
<td style="text-align: left; font-family: Monospace;">max(var)|min(var)</td>
<td style="text-align: left;">Finds the min|max values of observations</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-family: Monospace;">mean(var)|median(var)| ...</td>
<td style="text-align: left;">Calculates central tendency of observations</td>
</tr>
<tr class="even">
<td style="text-align: left; font-family: Monospace;">...</td>
<td style="text-align: left;">Many more</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</figure>
</div>
</div>
<p></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
On pipes <code>|&gt;</code>
</div>
</div>
<div class="callout-body-container callout-body">
<p></p>
<p>Remembering that pipes take the output of a set of code and make it the input of the next set, separate lines are used for each call to the pipe operator. This is good practice for supporting readability of your code, and for debugging and learning how your data is affected by each line. Especially if <code>dplyr</code> is new to you, we recommend you run each code line separated by a pipe (<code>|&gt;</code>) in the Console and observe how the dataset is changed.</p>
</div>
</div>
</section><section id="manipulate-dates-with-lubridate" class="level4 unnumbered"><h4 class="unnumbered anchored" data-anchor-id="manipulate-dates-with-lubridate">Manipulate dates with <code>lubridate</code>
</h4>
<p></p>
<p>Let’s continue this investigation of trips by user type by profiling how usage varies over time. To do this we will need to work with <code>date-time</code> variables. The <code>lubridate</code> package provides various convenience functions for this.</p>
<p>In the code block below we extract the <em>day of week</em> and <em>hour of day</em> from the <code>start_time</code> variable using <code>lubridate</code>’s day accessor functions. Documentation on these can be accessed in the usual way (<code>?&lt;function-name&gt;</code>). Next we count the number of trips made by hour of day, day of week and user type. The summarised data frame will be re-used several times in our analysis, so we store it as an object with a suitable name (<code>ny_temporal</code>) using the assignment operator.</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create an hour of day and day of week summary by user type</span></span>
<span><span class="co"># and assign it the name "ny_temporal".</span></span>
<span><span class="va">ny_temporal</span> <span class="op">&lt;-</span> <span class="va">ny_trips</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    <span class="co"># Create a new column to identify dow.</span></span>
<span>    day<span class="op">=</span><span class="fu">wday</span><span class="op">(</span><span class="va">start_time</span>, label<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    <span class="co"># Create a new column to identify hod.</span></span>
<span>    hour<span class="op">=</span><span class="fu">hour</span><span class="op">(</span><span class="va">start_time</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Group by day, hour, user_type.</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">user_type</span>, <span class="va">day</span>, <span class="va">hour</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Count the grouped rows.</span></span>
<span>  <span class="fu">summarise</span><span class="op">(</span>count<span class="op">=</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Keeping track of derived data
</div>
</div>
<div class="callout-body-container callout-body">
<p>Whether or not to store derived data frames, like the newly assigned <code>ny_temporal</code>, in a session is not an easy decision. You should avoid cluttering the Environment pane with many data objects. Often when generating charts it is necessary to create these sorts of derived tables as input data to ggplot2. Adding derived data frames to the RStudio Environment pane each time an exploratory plot is created risks an unhelpfully large number of such tables. A general rule: if the derived data frame is to be used more than three times in a data analysis or is computationally intensive, create and assign it (<code>&lt;-</code>) as a named object.</p>
</div>
</div>
<p>In <a href="#fig-plot-temporal" class="quarto-xref">Figure&nbsp;<span>2.2</span></a> the newly derived data are plotted. Code for creating this data graphic is below. The plot demonstrates a familiar weekday-weekend pattern of usage. Trip frequencies peak in the morning and evening rush hours during weekdays and mid/late-morning and afternoon during weekends, with the weekday afternoon peak much larger than the morning peak. There are obvious differences in the type of trips made by subscribers versus customers – the temporal signature for subscribers appears to match more closely what one would expect of commuting behaviour. That this pattern exists is notable when remembering the data are from June 2020, a time when New York residents were emerging from lockdown. It would be instructive to compare with data from a non-Covid year. The fact that bikeshare is recorded continuously, in contrast to actively-collected survey data, makes this sort of behavioural change analysis possible.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-plot-temporal" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-plot-temporal-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/02/hod_dow.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-plot-temporal-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.2: Citibike trips made by hour of day and day and week, differentiated by customer type.
</figcaption></figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Calculate trips by hour of day, day and customer type.</span></span>
<span><span class="va">ny_trips</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    day<span class="op">=</span><span class="fu">wday</span><span class="op">(</span><span class="va">start_time</span>, label<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    hour<span class="op">=</span><span class="fu">hour</span><span class="op">(</span><span class="va">start_time</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">user_type</span>, <span class="va">day</span>, <span class="va">hour</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">summarise</span><span class="op">(</span>count<span class="op">=</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># Pipe to ggplot2 for plotting.</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">hour</span>, y<span class="op">=</span><span class="va">count</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>colour<span class="op">=</span><span class="va">user_type</span><span class="op">)</span>, size<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_colour_manual</span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#e31a1c"</span>, <span class="st">"#1f78b4"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">day</span>, nrow<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x<span class="op">=</span><span class="st">"hour of day"</span>, y<span class="op">=</span><span class="st">"trip counts"</span>, colour<span class="op">=</span><span class="st">"user type"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="relate-tables-with-join" class="level4 unnumbered"><h4 class="unnumbered anchored" data-anchor-id="relate-tables-with-join">Relate tables with <code>join()</code>
</h4>
<p>Trip distance is not recorded directly in the <code>ny_trips</code> table, but may be important for profiling usage behaviour. Since <code>ny_stations</code> contains coordinates corresponding to station locations, distances can be calculated by linking these station coordinates to the origin and destination stations recorded in <code>ny_trips</code>. To relate the two tables we need to specify a join between them.</p>
<p>A sensible approach is to:</p>
<ol type="1">
<li>Select all uniquely cycled trip pairs (origin-destination pairs) that appear in the <code>ny_trips</code> table.</li>
<li>Bring in the corresponding coordinate pairs representing the origin and destination stations by joining on the <code>ny_stations</code> table.</li>
<li>Calculate the distance between the coordinate pairs representing the origin and destination.</li>
</ol>
<p>The code below is one way of achieving this.</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Take the ny_trips data frame.</span></span>
<span><span class="va">od_pairs</span> <span class="op">&lt;-</span> <span class="va">ny_trips</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Select trip origin and destination (OD) station columns</span></span>
<span>  <span class="co"># and extract unique OD pairs.</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">start_station_id</span>, <span class="va">end_station_id</span><span class="op">)</span> <span class="op">|&gt;</span>  <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Select lon, lat columns from ny_stations and join on origin column.</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span></span>
<span>    <span class="va">ny_stations</span> <span class="op">|&gt;</span> <span class="fu">select</span><span class="op">(</span><span class="va">stn_id</span>, <span class="va">longitude</span>, <span class="va">latitude</span><span class="op">)</span>,</span>
<span>    by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"start_station_id"</span><span class="op">=</span><span class="st">"stn_id"</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Rename new lon, lat columns and associate with origin station.</span></span>
<span>  <span class="fu">rename</span><span class="op">(</span>o_lon<span class="op">=</span><span class="va">longitude</span>, o_lat<span class="op">=</span><span class="va">latitude</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Select lon, lat columns from ny_stations and join</span></span>
<span>  <span class="co"># on destination column.</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span></span>
<span>    <span class="va">ny_stations</span> <span class="op">|&gt;</span> <span class="fu">select</span><span class="op">(</span><span class="va">stn_id</span>, <span class="va">longitude</span>, <span class="va">latitude</span><span class="op">)</span>,</span>
<span>    by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"end_station_id"</span><span class="op">=</span><span class="st">"stn_id"</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Rename new lon, lat columns and associate with destination station.</span></span>
<span>  <span class="fu">rename</span><span class="op">(</span>d_lon<span class="op">=</span><span class="va">longitude</span>, d_lat<span class="op">=</span><span class="va">latitude</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Compute distance calculation on each row (od_pair).</span></span>
<span>  <span class="fu">rowwise</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Calculate distance and express in kms.</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    dist<span class="op">=</span></span>
<span>    <span class="fu">geosphere</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/geosphere/man/distHaversine.html">distHaversine</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">o_lat</span>, <span class="va">o_lon</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">d_lat</span>, <span class="va">d_lon</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fl">1000</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Some new functions are introduced: <code>select()</code> to pick or drop variables, <code>rename()</code> to rename variables and a convenience function for calculating straight line distances from polar coordinates, <code>distHaversine()</code>. The key function to emphasise is the <code>left_join()</code>. If you’ve worked with relational databases, <code>dplyr</code>’s join functions will be familiar to you. In a <code>left_join</code> all the values from the first (left-most) table are retained, <code>ny_trips</code> in this case, and variables from the table on the right , <code>ny_stations</code>, are added. We specify the variable on which tables should be joined with the <code>by=</code> parameter, <code>station_id</code> in this case. If there is a <code>station_id</code> in <code>ny_trips</code> that doesn’t exist in <code>ny_stations</code> then corresponding cells are filled out with <code>NA</code>.</p>
<div id="tbl-table-joins-tex" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-table-joins-tex-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2.8: A breakdown of <code>dplyr</code> join functions.
</figcaption><div aria-describedby="tbl-table-joins-tex-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">

</div>
</figure>
</div>
<div class="cell">
<div id="tbl-table-joins" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-table-joins-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2.9: A breakdown of <code>dplyr</code> join functions.
</figcaption><div aria-describedby="tbl-table-joins-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div>
<table class="do-not-create-environment cell table table-sm table-striped small" data-quarto-postprocess="true">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead><tr class="header">
<th data-quarto-table-cell-role="th" style="text-align: center; border-bottom: hidden; padding-bottom: 0; padding-left: 3px; padding-right: 3px; font-family: Monospace; border-bottom: 1px solid;"><div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
*_join(x, y) ...
</div></th>
<th data-quarto-table-cell-role="th" style="text-align: left; empty-cells: hide; border-bottom: hidden; font-family: Monospace; border-bottom: 1px solid;"></th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left; width: 10em; font-family: Monospace;">left_join()</td>
<td style="text-align: left;">all rows from table x</td>
</tr>
<tr class="even">
<td style="text-align: left; width: 10em; font-family: Monospace;">right_join()</td>
<td style="text-align: left;">all rows from table y</td>
</tr>
<tr class="odd">
<td style="text-align: left; width: 10em; font-family: Monospace;">full_join()</td>
<td style="text-align: left;">all rows from both table x and y</td>
</tr>
<tr class="even">
<td style="text-align: left; width: 10em; font-family: Monospace;">`semi_join()`</td>
<td style="text-align: left;">all rows from table x where there are matching values in table y, keeping just columns from table x</td>
</tr>
<tr class="odd">
<td style="text-align: left; width: 10em; font-family: Monospace;">inner_join()</td>
<td style="text-align: left;">all rows from table x where there are matching values in table y, returning all combinations where there are multiple matches</td>
</tr>
<tr class="even">
<td style="text-align: left; width: 10em; font-family: Monospace;">anti_join</td>
<td style="text-align: left;">all rows from table x where there are not matching values in table y, never duplicating rows of table x</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</figure>
</div>
</div>
<p>From the newly created distance variable we can calculate the average (mean) trip distance for the 500,000 sampled trips – 1.6km. This might seem very short, but remember that these are straight-line distances between pairs of docking stations. Ideally we would calculate distances derived from cycle trajectories. A separate reason, discovered when generating a histogram on the <code>dist</code> variable, is that there are a large number of trips that start and end at the same docking station. These might be unsuccessful hires – people failing to undock a bike for example. We could investigate this further by paying attention to the docking stations at which same origin-destination trips occur, as in the code block below.</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ny_trips</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">start_station_id</span><span class="op">==</span><span class="va">end_station_id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">start_station_id</span><span class="op">)</span> <span class="op">|&gt;</span>  <span class="fu">summarise</span><span class="op">(</span>count<span class="op">=</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span></span>
<span>    <span class="va">ny_stations</span> <span class="op">|&gt;</span>   <span class="fu">select</span><span class="op">(</span><span class="va">stn_id</span>, <span class="va">name</span><span class="op">)</span>,</span>
<span>    by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"start_station_id"</span><span class="op">=</span><span class="st">"stn_id"</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 958 x 3</span></span>
<span><span class="co">##    start_station_id count name</span></span>
<span><span class="co">##    &lt;chr&gt;            &lt;int&gt; &lt;chr&gt;</span></span>
<span><span class="co">##  1 ny3423            2017 West Drive &amp; Prospect Park West</span></span>
<span><span class="co">##  2 ny3881            1263 12 Ave &amp; W 125 St</span></span>
<span><span class="co">##  3 ny514             1024 12 Ave &amp; W 40 St</span></span>
<span><span class="co">##  4 ny3349             978 Grand Army Plaza &amp; Plaza St West</span></span>
<span><span class="co">##  5 ny3992             964 W 169 St &amp; Fort Washington Ave</span></span>
<span><span class="co">##  6 ny3374             860 Central Park North &amp; Adam Clayton Powell </span></span>
<span><span class="co">##  7 ny3782             837 Brooklyn Bridge Park - Pier 2</span></span>
<span><span class="co">##  8 ny3599             829 Franklin Ave &amp; Empire Blvd</span></span>
<span><span class="co">##  9 ny3521             793 Lenox Ave &amp; W 111 St</span></span>
<span><span class="co">## 10 ny2006             782 Central Park S &amp; 6 Ave</span></span>
<span><span class="co">## # … with 948 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The top 10 docking stations are either in parks, near parks or located along the river. This, coupled with the fact that same origin-destination trips occur in much greater relative number for casual users (<code>Customer</code>), associated with discretionary leisure-oriented cycling, than regular users (<code>Subscriber</code>) is further evidence that these are valid trips. Note also the different shapes in the distribution of distances for trips cycled by subscribers and customers (<a href="#fig-plot-dist" class="quarto-xref">Figure&nbsp;<span>2.3</span></a>), again suggesting these groups may use Citibike in different ways. Code for creating <a href="#fig-plot-dist" class="quarto-xref">Figure&nbsp;<span>2.3</span></a> appears below the graphic.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-plot-dist" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-plot-dist-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/02/dist.png" class="img-fluid figure-img" style="width:95.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-plot-dist-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.3: Citibike trip distances (straight-line km) for Subscriber and Customer cyclists.
</figcaption></figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Plot faceted histograms.</span></span>
<span><span class="va">ny_trips</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># Cast as factor variable to draw Subscriber plot facet first.</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    user_type<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">user_type</span>, levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Subscriber"</span>, <span class="st">"Customer"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">dist</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">user_type</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x<span class="op">=</span><span class="st">"distance = km"</span>, y<span class="op">=</span><span class="st">"frequency"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="write-functions-of-your-own" class="level4 unnumbered"><h4 class="unnumbered anchored" data-anchor-id="write-functions-of-your-own">Write functions of your own</h4>
<p></p>
<p>There may be times when you need to create functions of your own. Most often this is when you find yourself copy-pasting the same chunks of code with minimal adaptation.</p>
<p>Functions have three key characteristics:</p>
<ol type="1">
<li>They are (usually) named – the name should be expressive and communicate what the function does.</li>
<li>They have brackets <code>&lt;function-name()&gt;</code> usually containing arguments – inputs, which determine what the function does and returns.</li>
<li>Immediately followed by <code>&lt;function-name()&gt;</code> are curly brackets (<code><a href="https://rdrr.io/r/base/Paren.html">{}</a></code>) used to contain the body – code that performs a distinct task, described by the function’s name.</li>
</ol>
<p>Effective functions are short and perform single, discrete operations.</p>
<p>You will recall that in the <code>ny_trips</code> table there is a variable called <code>birth_year</code>. From this we can derive cyclists’ approximate age in years. Below is a function called <code>get_age()</code>. The function expects two arguments: <code>yob</code> – a year of birth as type <code>chr</code>; and <code>yref</code> – a reference year. In the body, <code>lubridate</code>’s <code><a href="https://lubridate.tidyverse.org/reference/as.period.html">as.period()</a></code> function is used to calculate the time in years that elapsed between these dates.</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># get_age() depends on lubridate.</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org">lubridate</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate time elapsed between two dates in years (age).</span></span>
<span><span class="co"># yob : datetime object recording birth year.</span></span>
<span><span class="co"># yref : datetime object recording reference year.</span></span>
<span><span class="va">get_age</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">yob</span>, <span class="va">yref</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">period</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/as.period.html">as.period</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/interval.html">interval</a></span><span class="op">(</span><span class="va">yob</span>, <span class="va">yref</span><span class="op">)</span>,unit <span class="op">=</span> <span class="st">"year"</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">period</span><span class="op">$</span><span class="va">year</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">ny_trips</span> <span class="op">&lt;-</span> <span class="va">ny_trips</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Calculate age from birth_date.</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    age<span class="op">=</span><span class="fu">get_age</span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="va">birth_year</span>, format<span class="op">=</span><span class="st">"%Y"</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="st">"2020"</span>, format<span class="op">=</span><span class="st">"%Y"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can use the two new derived variables – distance travelled and age – in our analysis. In <a href="#fig-plot-speeds" class="quarto-xref">Figure&nbsp;<span>2.4</span></a>, we explore how approximate travel speeds vary by age, trip distance and customer type. Again the average speed calculation should be treated cautiously as it is based on straight line distances, and it is likely that this will vary depending on whether the trip is made for ‘utilitarian’ or ‘leisure’ purposes. Additionally, due to the heavy subsetting data become a little volatile for certain age groups, and so the age variable is aggregated into 5-year bands.</p>
<p>There are some notable patterns in <a href="#fig-plot-speeds" class="quarto-xref">Figure&nbsp;<span>2.4</span></a>. Subscribers make faster trips than do customers, although this gap narrows as trip distance increases. Trips with a straight-line distance of 4.5km are non-trivial and so may be classed as utilitarian even for non-regular customers. There is a very slight effect of decreasing trip speed by age cycled for the longer trips. The volatility in the older age groups for trips &gt;4.5km suggests more data, and a more involved analysis, is required to confidently establish this. For example, it may be that the comparatively rare occurrence of trips in the 65-70 age group is made by only a small subset of cyclists; with a larger dataset we may expect a regression to the mean effect that negates noise caused by outlier individuals.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-plot-speeds" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-plot-speeds-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/02/speeds.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-plot-speeds-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.4: Citibike average trip speeds (approximate) by age, customer type and straight-line trip distance.
</figcaption></figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Generate staged dataset for plotting. </span></span>
<span><span class="co"># Filter weekday-only trips, less than 1hr in duration, </span></span>
<span><span class="co"># exclude trips that start and end at same docking station, </span></span>
<span><span class="co"># and generate binned age and distance variables.  </span></span>
<span><span class="va">temp_data</span> <span class="op">&lt;-</span> <span class="va">ny_trips</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    day<span class="op">=</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/day.html">wday</a></span><span class="op">(</span><span class="va">start_time</span>, label<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>    is_weekday<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">!</span><span class="va">day</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Sat"</span>, <span class="st">"Sun"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">is_weekday</span><span class="op">==</span><span class="fl">1</span>,</span>
<span>    <span class="va">start_station_id</span><span class="op">!=</span><span class="va">end_station_id</span>,</span>
<span>    <span class="va">duration_minutes</span><span class="op">&lt;=</span><span class="fl">60</span>,</span>
<span>    <span class="fu">between</span><span class="op">(</span><span class="va">age</span>, <span class="fl">16</span>, <span class="fl">74</span><span class="op">)</span>,</span>
<span>    <span class="va">dist</span><span class="op">&gt;</span><span class="fl">.5</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    dist_bands<span class="op">=</span><span class="fu">case_when</span><span class="op">(</span></span>
<span>      <span class="va">dist</span> <span class="op">&lt;</span> <span class="fl">1.5</span> <span class="op">~</span> <span class="st">"&lt;1.5km"</span>,</span>
<span>      <span class="va">dist</span> <span class="op">&lt;</span> <span class="fl">3</span> <span class="op">~</span> <span class="st">"&gt;1.5-3km"</span>,</span>
<span>      <span class="va">dist</span> <span class="op">&lt;</span> <span class="fl">4.5</span> <span class="op">~</span> <span class="st">"&gt;3-4.5km"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"&gt;4.5km"</span><span class="op">)</span>,</span>
<span>    age_band<span class="op">=</span><span class="fu">if_else</span><span class="op">(</span><span class="va">age</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">10</span> <span class="op">&gt;</span> <span class="fl">4</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">age</span><span class="op">/</span><span class="fl">5</span><span class="op">)</span><span class="op">*</span><span class="fl">5</span>, </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="va">age</span><span class="op">/</span><span class="fl">5</span><span class="op">)</span><span class="op">*</span><span class="fl">5</span><span class="op">)</span>,</span>
<span>    speed<span class="op">=</span><span class="va">dist</span><span class="op">/</span><span class="op">(</span><span class="va">duration_minutes</span><span class="op">/</span><span class="fl">60</span><span class="op">)</span></span>
<span>  <span class="op">)</span>  <span class="op">|&gt;</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">user_type</span>, <span class="va">age_band</span>, <span class="va">dist_bands</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">summarise</span><span class="op">(</span>avg_speed<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">speed</span><span class="op">)</span>, sample_size<span class="op">=</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span>, </span>
<span>    std<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">speed</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># Plot.</span></span>
<span><span class="va">temp_data</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">age_band</span>, y<span class="op">=</span><span class="va">avg_speed</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>colour<span class="op">=</span><span class="va">user_type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_colour_manual</span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#e31a1c"</span>, <span class="st">"#1f78b4"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#e31a1c"</span>, <span class="st">"#1f78b4"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">dist_bands</span>, nrow<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x<span class="op">=</span><span class="st">"age"</span>, y<span class="op">=</span><span class="st">"speed - km/h "</span>, fill<span class="op">=</span><span class="st">"user type"</span>, </span>
<span>    colour<span class="op">=</span><span class="st">"user type"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Remove staging dataset.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">temp_data</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p></p>
</section></section><section id="tidy" class="level3" data-number="2.3.3"><h3 data-number="2.3.3" class="anchored" data-anchor-id="tidy">
<span class="header-section-number">2.3.3</span> Tidy</h3>
<p> The <code>ny_trips</code> and <code>ny_stations</code> data already comply with the rules for tidy data <span class="citation" data-cites="wickham_tidy_2014">(<a href="a2-references.html#ref-wickham_tidy_2014" role="doc-biblioref">Wickham 2014</a>)</span>. Each row in <code>ny_trips</code> is a distinct trip and each row in <code>ny_stations</code> a distinct station. However, it is common to encounter datasets that are untidy and must be reshaped. In the book’s data repository are two examples: <code>ny_spread_rows</code> and <code>ny_spread_columns</code>. <code>ny_spread_rows</code> is so-called because the variable <code>summary_type</code> is spread across the rows (observations); <code>ny_spread_columns</code> because multiple variables are stored in single columns – the <code>dist_weekday</code>, <code>duration_weekday</code> columns.</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ny_spread_rows</span></span>
<span><span class="co">## # A tibble: 411,032 × 6</span></span>
<span><span class="co">##    o_station d_station wkday   count summary_type  value</span></span>
<span><span class="co">##        &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt;   &lt;dbl&gt; &lt;chr&gt;         &lt;dbl&gt;</span></span>
<span><span class="co">##  1        72       116 weekend     1 dist           1.15</span></span>
<span><span class="co">##  2        72       116 weekend     1 duration      18.2</span></span>
<span><span class="co">##  3        72       127 weekend     4 dist           7.18</span></span>
<span><span class="co">##  4        72       127 weekend     4 duration     122.</span></span>
<span><span class="co">##  5        72       146 weekend     4 dist           9.21</span></span>
<span><span class="co">##  6        72       146 weekend     4 duration     122.</span></span>
<span><span class="co">##  7        72       164 weekend     1 dist           2.66</span></span>
<span><span class="co">##  8        72       164 weekend     1 duration      12.5</span></span>
<span><span class="co">##  9        72       173 weekend     2 dist           2.13</span></span>
<span><span class="co">## 10        72       173 weekend     2 duration      43.6</span></span>
<span><span class="co">## # … with 411,022 more rows</span></span>
<span></span>
<span><span class="va">ny_spread_columns</span></span>
<span><span class="co">## # A tibble: 156,449 × 8</span></span>
<span><span class="co">##    o_stat d_stat ct_wend ct_wdy dst_wnd dst_wdy dur_wnd dur_wdy</span></span>
<span><span class="co">##     &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;</span></span>
<span><span class="co">##  1    72   116       1      3    1.15   3.45    18.2     49.9</span></span>
<span><span class="co">##  2    72   127       4      4    7.18   7.18    122.     101.</span></span>
<span><span class="co">##  3    72   146       4      2    9.21   4.61    122.     64.1</span></span>
<span><span class="co">##  4    72   164       1      1    2.66   2.66    12.5     43.2</span></span>
<span><span class="co">##  5    72   173       2     13    2.13   13.9    43.6    189.</span></span>
<span><span class="co">##  6    72   195       1      4    2.56   10.2    24.7     98.3</span></span>
<span><span class="co">##  7    72   212       3      3    4.83   4.83    40.3     54.0</span></span>
<span><span class="co">##  8    72   223       1     NA    1.13     NA    21.1     NA</span></span>
<span><span class="co">##  9    72   228       2      1    4.97   2.49    30.2     13.6</span></span>
<span><span class="co">## 10    72   229       1     NA    1.22     NA    39.2     NA</span></span>
<span><span class="co">## # … with 156,439 more rows, and abbreviated variable names </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To re-organise the table in tidy form, we should identify what constitutes a distinct observation – an origin-destination pair summarising counts, distances and durations of trips that occur during the weekday or weekend. From here, the table’s variables are:</p>
<ul>
<li>
<code>o_station</code>: station id of the origin station</li>
<li>
<code>d_station</code>: station id of the destination station</li>
<li>
<code>wkday</code>: trip occurs on weekday or weekend</li>
<li>
<code>count</code>: count of trips for observation type</li>
<li>
<code>dist</code>: total straight-line distance in km (cumulative) of trips for observation type</li>
<li>
<code>duration</code>: total duration in minutes (cumulative) of trips for observation type</li>
</ul>
<p>There are two functions for reshaping untidy data, from the <code>tidyr</code> package: <code>pivot_longer()</code> and <code>pivot_wider()</code>. <code>pivot_longer()</code> is used to tidy data in which observations are spread across columns; <code>pivot_wider()</code> to tidy data in which variables are spread across rows. The functions are especially useful in visual data analysis to fix messy data, but also to flexibly reshape data supplied to ggplot2 specifications (more on this in Chapters <a href="03-visual.html" class="quarto-xref"><span>3</span></a> and <a href="04-explore.html" class="quarto-xref"><span>4</span></a>).</p>
<p>To fix <code>ny_spread_rows</code>, we use <code>pivot_wider()</code> and pass to the function’s arguments the name of the problematic column and the column containing values used to populate the newly created columns.</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ny_spread_rows</span> <span class="op">|&gt;</span></span>
<span>   <span class="fu">pivot_wider</span><span class="op">(</span>names_from<span class="op">=</span><span class="va">summary_type</span>, values_from<span class="op">=</span><span class="va">value</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## # A tibble: 205,516 × 6</span></span>
<span><span class="co">##    o_station d_station wkday   count  dist duration</span></span>
<span><span class="co">##        &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">##  1        72       116 weekend     1  1.15     18.2</span></span>
<span><span class="co">##  2        72       127 weekend     4  7.18    122.</span></span>
<span><span class="co">##  3        72       146 weekend     4  9.21    122.</span></span>
<span><span class="co">##  4        72       164 weekend     1  2.66     12.5</span></span>
<span><span class="co">##  5        72       173 weekend     2  2.13     43.6</span></span>
<span><span class="co">##  6        72       195 weekend     1  2.56     24.7</span></span>
<span><span class="co">##  7        72       212 weekend     3  4.83     40.3</span></span>
<span><span class="co">##  8        72       223 weekend     1  1.13     21.1</span></span>
<span><span class="co">##  9        72       228 weekend     2  4.97     30.2</span></span>
<span><span class="co">## 10        72       229 weekend     1  1.22     39.2</span></span>
<span><span class="co">## # … with 205,506 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To fix <code>ny_spread_columns</code> requires a little more thought. First we <code>pivot_longer()</code> on columns that are muddled with multiple variables. This results in a long and thin dataset similar to <code>ny_spread_rows</code> – each row is the origin-destination pair with either a count, distance or duration recorded for trips occurring on weekends or weekdays. The muddled variables, for example <code>dist_weekend</code> <code>duration_weekday</code>, now appear in the rows of a new column with the default title <code>name</code>. This column is separated on the <code>_</code> mark to create two new columns, <code>summary_type</code> and <code>wkday</code>, used in <code>pivot_wider()</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ny_spread_columns</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span>cols <span class="op">=</span> <span class="va">count_weekend</span><span class="op">:</span><span class="va">duration_weekday</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">separate</span><span class="op">(</span>col <span class="op">=</span> <span class="va">name</span>, into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"summary_type"</span>, <span class="st">"wkday"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">summary_type</span>, values_from <span class="op">=</span> <span class="va">value</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## # A tibble: 312,898 × 6</span></span>
<span><span class="co">##    o_station d_station wkday   count  dist duration</span></span>
<span><span class="co">##        &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">##  1        72       116 weekend     1  1.15     18.2</span></span>
<span><span class="co">##  2        72       116 weekday     3  3.45     49.9</span></span>
<span><span class="co">##  3        72       127 weekend     4  7.18    122.</span></span>
<span><span class="co">##  4        72       127 weekday     4  7.18    101.</span></span>
<span><span class="co">##  5        72       146 weekend     4  9.21    122.</span></span>
<span><span class="co">##  6        72       146 weekday     2  4.61     64.1</span></span>
<span><span class="co">##  7        72       164 weekend     1  2.66     12.5</span></span>
<span><span class="co">##  8        72       164 weekday     1  2.66     43.2</span></span>
<span><span class="co">##  9        72       173 weekend     2  2.13     43.6</span></span>
<span><span class="co">## 10        72       173 weekday    13 13.9     189.</span></span>
<span><span class="co">## # … with 312,888 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task 2
</div>
</div>
<div class="callout-body-container callout-body">
<p><a href="#fig-plot-temporal" class="quarto-xref">Figure&nbsp;<span>2.2</span></a> uses a derived dataset that summarises trip counts by <code>user_type</code> and <code>day_of_week</code>. This dataset is created in the template file for the chapter and is named <code>ny_temporal</code>. Each observation is a trip count on a day of week, hour of day and for a given user type (<code>Customer</code> or <code>Subscriber</code>).</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ny_temporal</span> <span class="op">&lt;-</span> <span class="va">ny_trips</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    day<span class="op">=</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/day.html">wday</a></span><span class="op">(</span><span class="va">start_time</span>, label<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    hour<span class="op">=</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/hour.html">hour</a></span><span class="op">(</span><span class="va">start_time</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">user_type</span>, <span class="va">day</span>, <span class="va">hour</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">summarise</span><span class="op">(</span>count<span class="op">=</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To explore whether customers and subscribers have different usage behaviours, we calculate the proportion of trips made by day of week for these two user groups. Customers, as expected, contribute a greater relative number of trips on weekends than do subscribers.</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># # A tibble: 7 × 3</span></span>
<span><span class="co">#   day   Customer Subscriber</span></span>
<span><span class="co">#   &lt;ord&gt;    &lt;dbl&gt;      &lt;dbl&gt;</span></span>
<span><span class="co"># 1 Sun     0.198       0.144</span></span>
<span><span class="co"># 2 Mon     0.137       0.163</span></span>
<span><span class="co"># 3 Tue     0.144       0.172</span></span>
<span><span class="co"># 4 Wed     0.104       0.125</span></span>
<span><span class="co"># 5 Thu     0.0973      0.122</span></span>
<span><span class="co"># 6 Fri     0.135       0.138</span></span>
<span><span class="co"># 7 Sat     0.185       0.136</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Can you write some <code>dplyr</code> code to generate such a summary? There are several possible approaches, but you will need to think about which variables to <code>group_by()</code> and <code>summarise()</code> over, and you may need to <code>pivot_wider()</code> your dataset in order to compare the user types side-by-side.</p>
</div>
</div>
<p> </p>
</section></section><section id="conclusions" class="level2" data-number="2.4"><h2 data-number="2.4" class="anchored" data-anchor-id="conclusions">
<span class="header-section-number">2.4</span> Conclusions</h2>
<p>Developing the vocabulary and technical skills to systematically describe and organise data is crucial to modern data analysis. This chapter has covered the fundamentals: that data consist of <em>observations</em> and <em>variables</em> of different types <span class="citation" data-cites="stevens_on_1946">(<a href="a2-references.html#ref-stevens_on_1946" role="doc-biblioref">Stevens 1946</a>)</span> and that in order to work effectively with datasets, these data should be organised such that they are <em>tidy</em> <span class="citation" data-cites="wickham_tidy_2014">(<a href="a2-references.html#ref-wickham_tidy_2014" role="doc-biblioref">Wickham 2014</a>)</span>. Most of the chapter content was dedicated to the techniques that enable these concepts to be operationalised. We covered how to download, transform and reshape a reasonably large dataset from New York’s Citibike system. In doing so, we generated insights that might inform further data collection and analysis activity. In the next chapter we will extend this conceptual and technical knowledge as we introduce the fundamentals of visual data analysis and ggplot2’s <em>grammar of graphics</em>.</p>
</section><section id="further-reading" class="level2" data-number="2.5"><h2 data-number="2.5" class="anchored" data-anchor-id="further-reading">
<span class="header-section-number">2.5</span> Further Reading</h2>
<p>There are many accessible introductions to the <code>tidyverse</code> for modern data analysis. Two excellent resources:</p>
<ul>
<li>Wickham, H., Çetinkaya-Rundel, M., Grolemund, G. 2023, “R for Data Science, 2nd Edition”, Sebastopol, CA: <em>O’Reilly</em>.
<ul>
<li>Chapter 3.</li>
</ul>
</li>
<li>Ismay, C. and Kim, A. 2020. “Statistical Inference via Data Science: A ModernDive into R and the Tidyverse”, New York, NY: <em>CRC Press</em>. doi: 10.1201/9780367409913.
<ul>
<li>Chapters 3, 4.</li>
</ul>
</li>
</ul>
<p>Hadley Wickham’s original paper on Tidy Data:</p>
<ul>
<li>Wickham, H. 2010. “Tidy Data” <em>Journal of Statistical Software</em>, 59(10): 1–23. doi: 10.18637/jss.v059.i10.</li>
</ul>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-bbc_visual_2019" class="csl-entry" role="listitem">
BBC Visual and Data Journalism Team. 2019. <span>“BBC Visual and Data Journalism Cookbook for <span>R</span> Graphics.”</span> <a href="https://github.com/bbc/rcookbook" class="uri">https://github.com/bbc/rcookbook</a>.
</div>
<div id="ref-beecham_regionally-structured_2020" class="csl-entry" role="listitem">
Beecham, R., N. Williams, and L. Comber. 2020. <span>“Regionally-Structured Explanations Behind Area-Level Populism: <span>An</span> Update to Recent Ecological Analyses.”</span> <em>PLOS One</em> 15 (3): e0229974. <a href="https://doi.org/10.1371/journal.pone.0229974">https://doi.org/10.1371/journal.pone.0229974</a>.
</div>
<div id="ref-buja_statistical_2009" class="csl-entry" role="listitem">
Buja, A., D. Cook, H. Hofmann, M. Lawrence, E-K Lee, D. Swayne, and H. Wickham. 2009. <span>“Statistical Inference for Exploratory Data Analysis and Model Diagnostics.”</span> <em>Philosophical Transactions of the Royal Society A: Mathematical, Physical and Engineering Sciences</em> 367 (1906): 4361–83. <a href="https://doi.org/10.1098/rsta.2009.0120">https://doi.org/10.1098/rsta.2009.0120</a>.
</div>
<div id="ref-burnmurdoch_making_2023" class="csl-entry" role="listitem">
Burn-Murdoch, J. 2023. <span>“Making Charts That Make an Impact.”</span> Invited talk, Data Visualization Society’s Outlier Conference. <a href="https://www.youtube.com/watch?v=tIbaQUo6H9g&amp;ab_channel=DataVisualizationSociety">https://www.youtube.com/watch?v=tIbaQUo6H9g&amp;ab_channel=DataVisualizationSociety</a>.
</div>
<div id="ref-comber_route_2023" class="csl-entry" role="listitem">
Comber, A., C. Brunsdon, M. Charlton, G. Dong, R. Harris, B. Lu, Y. Lü, et al. 2023. <span>“A Route Map for Successful Applications of Geographically Weighted Regression.”</span> <em>Geographical Analysis</em> 55 (1): 155–78. <a href="https://doi.org/10.1111/gean.12316">https://doi.org/10.1111/gean.12316</a>.
</div>
<div id="ref-franconeri_psychological_2022" class="csl-entry" role="listitem">
Franconeri, S. L., L. M. Padilla, P. Shah, J. M. Zacks, and J. Hullman. 2021. <span>“The Science of Visual Data Communication: What Works.”</span> <em>Psychological Science in the Public Interest</em> 22 (3): 110–61. <a href="https://doi.org/10.1177/15291006211051956%20">https://doi.org/10.1177/15291006211051956 </a>.
</div>
<div id="ref-healy_data_2018" class="csl-entry" role="listitem">
Healy, K. 2019. <em>Data Visualization: A Practical Introduction</em>. Princeton, NJ: Princeton University Press. <a href="https://socviz.co">https://socviz.co</a>.
</div>
<div id="ref-hullman_designing_2021" class="csl-entry" role="listitem">
Hullman, J., and A. Gelman. 2021. <span>“Designing for Interactive Exploratory Data Analysis Requires Theories of Graphical Inference.”</span> <em>Harvard Data Science Review</em> 3 (3).
</div>
<div id="ref-ismay_moderndive_2020" class="csl-entry" role="listitem">
Ismay, C., and A. Kim. 2020. <em>Statistical Inference via Data Science: A <span>ModernDive</span> into <span>R</span> and the Tidyverse</em>. New York, NY: CRC Press. <a href="https://doi.org/10.1201/9780367409913">https://doi.org/10.1201/9780367409913</a>.
</div>
<div id="ref-kale_hypothetical_2019" class="csl-entry" role="listitem">
Kale, A., F. Nguyen, M. Kay, and J. Hullman. 2019. <span>“Hypothetical Outcome Plots Help Untrained Observers Judge Trends in Ambiguous Data.”</span> <em>IEEE Transactions on Visualization and Computer Graphics</em> 25 (1): 892–902. <a href="https://doi.org/10.1109/TVCG.2018.2864909">https://doi.org/10.1109/TVCG.2018.2864909</a>.
</div>
<div id="ref-kay_uncertainty_2021" class="csl-entry" role="listitem">
Kay, M. 2021. <span>“Uncertainty Visualization as a Moral Imperative.”</span> Invited talk, BostonCHI meeting. <a href="https://www.youtube.com/watch?v=mfQ3QVyw4N0&amp;ab_channel=BostonCHI">https://www.youtube.com/watch?v=mfQ3QVyw4N0&amp;ab_channel=BostonCHI</a>.
</div>
<div id="ref-kosara_lesson_2023" class="csl-entry" role="listitem">
Kosara, R. 2023. <span>“Lesson 4: Presentation, Uncertainty, ISOTYPE.”</span> ObservableHQ Notebook; ObservableHQ. <a href="https://observablehq.com/@observablehq/lesson-4-presentation-uncertainty-isotype?collection=@observablehq/advanced-data-vis-course">https://observablehq.com/@observablehq/lesson-4-presentation-uncertainty-isotype?collection=@observablehq/advanced-data-vis-course</a>.
</div>
<div id="ref-pebesma_simple_2018" class="csl-entry" role="listitem">
Pebesma, E. 2018. <span>“<span class="nocase">Simple Features for R: Standardized Support for Spatial Vector Data</span>.”</span> <em><span>The R Journal</span></em> 10 (1): 439–46. <a href="https://doi.org/10.32614/RJ-2018-009">https://doi.org/10.32614/RJ-2018-009</a>.
</div>
<div id="ref-scherer_designing_2023" class="csl-entry" role="listitem">
Scherer, C. 2023. <span>“Designing Data Visualizations to Successfully Tell a Story.”</span> Workshop at Posit::conf(2023), Chicago, IL. <a href="https://posit-conf-2023.github.io/dataviz-storytelling/">https://posit-conf-2023.github.io/dataviz-storytelling/</a>.
</div>
<div id="ref-stevens_on_1946" class="csl-entry" role="listitem">
Stevens, S. 1946. <span>“On the Theory of Scales of Measurement.”</span> <em>Science</em> 103 (2684): 677–80. <a href="https://doi.org/10.1126/science.103.2684.677">https://doi.org/10.1126/science.103.2684.677</a>.
</div>
<div id="ref-turing_the_2025" class="csl-entry" role="listitem">
The Turing Way Community. 2025. <span>“The Turing Way: A Handbook for Reproducible, Ethical and Collaborative Research.”</span> Zenodo. <a href="https://doi.org/10.5281/zenodo.15213042">https://doi.org/10.5281/zenodo.15213042</a>.
</div>
<div id="ref-wickham_tidy_2014" class="csl-entry" role="listitem">
Wickham, H. 2014. <span>“Tidy <span>Data</span>.”</span> <em>Journal of Statistical Software</em> 59 (10): 1–23. <a href="https://doi.org/10.18637/jss.v059.i10">https://doi.org/10.18637/jss.v059.i10</a>.
</div>
<div id="ref-wilkinson_grammar_1999" class="csl-entry" role="listitem">
Wilkinson, L. 1999. <em>The <span>Grammar</span> of <span>Graphics</span></em>. New York, NY: Springer.
</div>
<div id="ref-wolf_spatial_2021" class="csl-entry" role="listitem">
Wolf, L. J., L. Anselin, D. Arribas-Bel, and L. Rivers Mobley. 2021. <span>“On Spatial and Platial Dependence: Examining Shrinkage in Spatially Dependent Multilevel Models.”</span> <em>Annals of the American Association of Geographers</em> 111 (6): 1679–91. <a href="https://doi.org/10.1080/24694452.2020.1841602">https://doi.org/10.1080/24694452.2020.1841602</a>.
</div>
<div id="ref-yang_swaying_2024" class="csl-entry" role="listitem">
Yang, F., M. Cau, C. Mortenson, H. Fakhari, A. D. Lokmanoglu, J. Hullman, S. Franconeri, N. Diakopoulos, E. C. Nisbet, and M. Kay. 2024. <span>“Swaying the Public? Impacts of Election Forecast Visualizations on Emotion, Trust, and Intention in the 2022 <span>U.S.</span> Midterms.”</span> <em>IEEE Transactions on Visualization and Computer Graphics</em> 30 (1): 23–33. <a href="https://doi.org/10.1109/TVCG.2023.3327356">https://doi.org/10.1109/TVCG.2023.3327356</a>.
</div>
</div>
</section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p><code>https://vis4sds.github.io/vis4sds/files/02-template.qmd</code><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p><code>https://github.com/vis4sds/data</code><a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/vis4sds\/vis4sds");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./01-intro.html" class="pagination-link" aria-label="Introduction">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./03-visual.html" class="pagination-link" aria-label="Visualization Fundamentals">
        <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Visualization Fundamentals</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>