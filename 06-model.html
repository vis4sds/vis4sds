<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Visualization for Social Data Science - 6&nbsp; Models</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./07-uncertainty.html" rel="next">
<link href="./05-network.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script src="site_libs/kePrint-0.0.1/kePrint.js"></script><link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script><script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script><script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">
<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./06-model.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Models</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Visualization for Social Data Science</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/vis4sds/vis4sds/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data Fundamentals</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-visual.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Visualization Fundamentals</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-explore.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Exploratory Data Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-network.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Geographic Networks</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-model.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-uncertainty.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Uncertainty</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-storytelling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Visual Storytelling</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./a1-tasks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Task Answers</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./a2-references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">6.1</span> Introduction</a></li>
  <li>
<a href="#concepts" id="toc-concepts" class="nav-link" data-scroll-target="#concepts"><span class="header-section-number">6.2</span> Concepts</a>
  <ul class="collapse">
<li><a href="#quantifying-and-exploring-variation" id="toc-quantifying-and-exploring-variation" class="nav-link" data-scroll-target="#quantifying-and-exploring-variation"><span class="header-section-number">6.2.1</span> Quantifying and exploring variation</a></li>
  <li><a href="#quantifying-and-exploring-co-variation" id="toc-quantifying-and-exploring-co-variation" class="nav-link" data-scroll-target="#quantifying-and-exploring-co-variation"><span class="header-section-number">6.2.2</span> Quantifying and exploring co-variation</a></li>
  <li><a href="#modelling-for-co-variation" id="toc-modelling-for-co-variation" class="nav-link" data-scroll-target="#modelling-for-co-variation"><span class="header-section-number">6.2.3</span> Modelling for co-variation</a></li>
  <li><a href="#evaluating-model-bias" id="toc-evaluating-model-bias" class="nav-link" data-scroll-target="#evaluating-model-bias"><span class="header-section-number">6.2.4</span> Evaluating model bias</a></li>
  <li><a href="#geographic-context-as-grouped-nuisance-term" id="toc-geographic-context-as-grouped-nuisance-term" class="nav-link" data-scroll-target="#geographic-context-as-grouped-nuisance-term"><span class="header-section-number">6.2.5</span> Geographic context as grouped nuisance term</a></li>
  <li><a href="#geographic-context-as-grouped-effects" id="toc-geographic-context-as-grouped-effects" class="nav-link" data-scroll-target="#geographic-context-as-grouped-effects"><span class="header-section-number">6.2.6</span> Geographic context as grouped effects</a></li>
  <li><a href="#estimate-volatility-and-alternative-modelling-approaches" id="toc-estimate-volatility-and-alternative-modelling-approaches" class="nav-link" data-scroll-target="#estimate-volatility-and-alternative-modelling-approaches"><span class="header-section-number">6.2.7</span> Estimate volatility and alternative modelling approaches</a></li>
  </ul>
</li>
  <li>
<a href="#techniques" id="toc-techniques" class="nav-link" data-scroll-target="#techniques"><span class="header-section-number">6.3</span> Techniques</a>
  <ul class="collapse">
<li><a href="#import-transform-explore" id="toc-import-transform-explore" class="nav-link" data-scroll-target="#import-transform-explore"><span class="header-section-number">6.3.1</span> Import, transform, explore</a></li>
  <li><a href="#model-tidily" id="toc-model-tidily" class="nav-link" data-scroll-target="#model-tidily"><span class="header-section-number">6.3.2</span> Model tidily</a></li>
  <li><a href="#plot-models-tidily" id="toc-plot-models-tidily" class="nav-link" data-scroll-target="#plot-models-tidily"><span class="header-section-number">6.3.3</span> Plot models tidily</a></li>
  <li><a href="#extend-model-terms" id="toc-extend-model-terms" class="nav-link" data-scroll-target="#extend-model-terms"><span class="header-section-number">6.3.4</span> Extend model terms</a></li>
  <li><a href="#evaluate-models-with-lineups" id="toc-evaluate-models-with-lineups" class="nav-link" data-scroll-target="#evaluate-models-with-lineups"><span class="header-section-number">6.3.5</span> Evaluate models with lineups</a></li>
  </ul>
</li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"><span class="header-section-number">6.4</span> Conclusion</a></li>
  <li><a href="#further-reading" id="toc-further-reading" class="nav-link" data-scroll-target="#further-reading"><span class="header-section-number">6.5</span> Further Reading</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title"><span id="sec-model" class="quarto-section-identifier"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Models</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p>By the end of this chapter you should gain the following knowledge and practical skills.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Knowledge
</div>
</div>
<div class="callout-body-container callout-body">
<ul class="task-list">
<li><label><input type="checkbox">Be reminded of the basics of linear regression modelling.</label></li>
<li><label><input type="checkbox">Appreciate how data graphics can inform the process of building and evaluating models.</label></li>
<li><label><input type="checkbox">Understand two categories of geographic effect in regression modelling: spatial <em>dependence</em> in values and spatial <em>non-stationarity</em> in processes.</label></li>
<li><label><input type="checkbox">Learn how graphics can be used to test for these effects and how linear regression models can be updated to account for and further explore them.</label></li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Practical skills
</div>
</div>
<div class="callout-body-container callout-body">
<ul class="task-list">
<li><label><input type="checkbox">Write ggplot2 code to generate graphics for exploring multivariate association and presenting regression outputs (faceted scatterplots, parallel coordinate plots, dot plots with error bars).</label></li>
<li><label><input type="checkbox">Write code to generate linear regression models in R.</label></li>
<li><label><input type="checkbox">Extract model outputs and diagnostics in a <code>tidy</code> manner.</label></li>
<li><label><input type="checkbox">Apply functional-style programming for working over multiple model outputs.</label></li>
<li><label><input type="checkbox">Generate graphical line-up plots in ggplot2 to test regression assumptions.</label></li>
</ul>
</div>
</div>
<section id="introduction" class="level2" data-number="6.1"><h2 data-number="6.1" class="anchored" data-anchor-id="introduction">
<span class="header-section-number">6.1</span> Introduction</h2>
<p> So far the analysis presented in this book has been data-driven. Having described data in a consistent way (<a href="02-data.html" class="quarto-xref"><span>Chapter 2</span></a>), visual analysis approaches have been applied, informed by established visualization guidelines. Chapters <a href="04-explore.html" class="quarto-xref"><span>4</span></a> and <a href="05-network.html" class="quarto-xref"><span>5</span></a> involved model building, but these were largely value-free models based on limited prior theory. This chapter is presented as a worked data analysis. We look at a well-known dataset with a more explicit and theoretically-informed motivation.</p>
<p>The chapter explores variation in voting behaviour in the UK’s 2016 referendum on leaving the EU. You might remember that while there was a slight majority for Leave (c.&nbsp;52%), the vote varied between different parts of the country. There were many explanations offered for why particular places voted the way they did, often related to the demographic composition of those areas. We will explore whether the discussed compositional demographic factors vary systematically with area-level Leave voting. Using regression frameworks, we will model the relative effect of each of these compositional factors in structuring variation in the vote and construct data graphics that allow these models and parameters to be evaluated in detail. </p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Regression primer
</div>
</div>
<div class="callout-body-container callout-body">
<p>This chapter assumes some basic familiarity with linear regression modelling. For a fuller overview, with excellent and real-world social science examples, you may wish to consult <em>Regression and Other Stories</em> <span class="citation" data-cites="gelman_regression_2020">(<a href="a2-references.html#ref-gelman_regression_2020" role="doc-biblioref">Gelman, Hill, and Vehtari 2020</a>)</span>.</p>
</div>
</div>
</section><section id="concepts" class="level2" data-number="6.2"><h2 data-number="6.2" class="anchored" data-anchor-id="concepts">
<span class="header-section-number">6.2</span> Concepts</h2>
<section id="quantifying-and-exploring-variation" class="level3" data-number="6.2.1"><h3 data-number="6.2.1" class="anchored" data-anchor-id="quantifying-and-exploring-variation">
<span class="header-section-number">6.2.1</span> Quantifying and exploring variation</h3>
<!-- Variation is central to most data analysis, and certainly regression modelling: quantifying variation, exploring how it is structured and accounting for (or explaining) it using a combination of empirical data, prior theory and knowledge. -->
<p></p>
<p>In <a href="#fig-map-uniform" class="quarto-xref">Figure&nbsp;<span>6.1</span></a> is a map and bar chart of voting in the 2016 EU referendum, estimated at Parliamentary Constituency level <span class="citation" data-cites="hanretty_areal_2017">(see <a href="a2-references.html#ref-hanretty_areal_2017" role="doc-biblioref">Hanretty 2017</a>)</span>. The values themselves are the difference in estimated vote shares from an expectation that the Leave vote by constituency, <span class="math inline">y_{i}</span> our <em>outcome</em> of interest, is uniformly distributed across the country and so equivalent to the overall Great Britain (GB) vote share for Leave of c.&nbsp;52%. Although a slightly contrived formulation, we could express this as an intercept-only linear regression model, where the estimated <em>slope</em> (<span class="math inline">\beta_{1}</span>) is ‘turned off’ (takes the value <span class="math inline">0</span>) and the <em>intercept</em> (<span class="math inline">\beta_{0}</span>) is the GB average vote share for Leave (<span class="math inline">\bar{y}</span>):</p>
<p><span class="math display">\begin{align*}
       y_{i}= \beta_{0} + \beta_{1} + \varepsilon_{i}
\end{align*}</span></p>
<p>So we estimate the Leave vote in each constituency (<span class="math inline">y_{i}</span>) as a function of:</p>
<ul>
<li>
<span class="math inline">\beta_{0}</span>, the intercept, the GB average vote share (<span class="math inline">\bar{y}</span>) <span class="math inline">+</span>
</li>
<li>
<span class="math inline">\beta_{1}=0</span>, a negated slope, <span class="math inline">+</span>
</li>
<li>
<span class="math inline">\varepsilon_{i}</span>, a statistical error term capturing the difference between <span class="math inline">y_{i}</span>, the observed Leave vote in a constituency, and the unobservable ‘true population’ value of the Leave vote in each constituency</li>
</ul>
<p>How does this relate to the idea of characterising variation? The length and colour of each bar in <a href="#fig-map-uniform" class="quarto-xref">Figure&nbsp;<span>6.1</span></a> is scaled according to model <em>residuals</em>: the difference between <span class="math inline">y_{i}</span>, the observed value, and the expected value of the Leave vote under the uniform model. The sum of these bar lengths is therefore the total variance that we later try to account for by updating our regression model to generate new expected values using information on the demographic composition of constituencies.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-map-uniform" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-map-uniform-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/06/map_uniform.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-map-uniform-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.1: Residuals from uniform model comparing constituency Leave vote to GB average.
</figcaption></figure>
</div>
</div>
</div>
<p><a href="#fig-map-uniform" class="quarto-xref">Figure&nbsp;<span>6.1</span></a> is similar to the maps that were published widely in press reports in the aftermath of the vote, and demonstrates that there is indeed substantial variation in Leave voting between different parts of the country. The intercept-only model consistently underestimates the vote in Scotland and most of London. Outside of this, constituencies voting in smaller proportions than would be expected for Leave are distributed more sparsely in the country: the dark red dot with surrounding red area in the east of England is Cambridge and Cambridgeshire, constituencies in Bristol (south west), Manchester and Liverpool (north west) and Brighton (south) are also reasonably strong red.</p>
<p> When evaluating the effectiveness of modelled values, there are various checks that can be performed. A relevant check here is whether there is bias in the residuals – whether residuals have structure that suggests they are grouped in a way not captured by the model. Given the motivation behind our analysis, it is no surprise that there is a geographic pattern to the residuals in <a href="#fig-map-uniform" class="quarto-xref">Figure&nbsp;<span>6.1</span></a>, but also the non-symmetrical shape of the ‘signed’ bars in the left of the graphic. There are more constituencies with positive values than negative; the Leave vote is underestimated by the uniform model for 57% of constituencies, and some constituencies have quite large negative values. The strongest vote for Leave was Boston and Skegness with 76% for Leave, but the strongest for Remain was Hackney North and Stoke Newington with 80% for Remain.</p>
<p></p>
</section><section id="quantifying-and-exploring-co-variation" class="level3" data-number="6.2.2"><h3 data-number="6.2.2" class="anchored" data-anchor-id="quantifying-and-exploring-co-variation">
<span class="header-section-number">6.2.2</span> Quantifying and exploring co-variation</h3>
<p>More interesting still is whether the pattern of variation in <a href="#fig-map-uniform" class="quarto-xref">Figure&nbsp;<span>6.1</span></a> is correlated with compositional factors that we think explain this variation; and whether bias or structure in residuals exists even after accounting for these compositional factors.</p>
<p> In <span><a href="#tbl-variables" class="quarto-xref">Table&nbsp;<span>6.1</span></a></span> is a list of possible explanatory variables describing the demographic composition of constituencies. Each variable is expressed as a proportion of the constituency’s population. So the <em>degree-educated</em> variable describes the proportion of residents in the constituency educated at least to degree-level. Comparison across these variables is challenging due to the fact that their ranges differ: the <em>EU-born</em> variable ranges from 0.6% to 17%; the <em>white</em> variable from 14% to 98%. Common practice for addressing these sorts of range problem is to z-score transform the variables so that each is expressed in standard deviation units from its mean. </p>
<div class="cell">
<div id="tbl-variables" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-variables-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;6.1: Breakdown of variable types.
</figcaption><div aria-describedby="tbl-variables-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div>
<table class="do-not-create-environment cell table table-sm table-striped small" data-quarto-postprocess="true">
<thead><tr class="header">
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">Census variable</th>
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid;">Constituency %</th>
</tr></thead>
<tbody>
<tr class="odd" data-grouplength="4">
<td colspan="2" style="border-bottom: 0px solid">post-industrial / knowledge economy</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em; width: 60%;" data-indentlevel="1">degree-educated</td>
<td style="text-align: left;">with degrees +</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em; width: 60%;" data-indentlevel="1">professional occupations</td>
<td style="text-align: left;">ns-sec manager/professional</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em; width: 60%;" data-indentlevel="1">younger adults</td>
<td style="text-align: left;">adults aged &lt;44</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em; width: 60%;" data-indentlevel="1">heavy industry</td>
<td style="text-align: left;">manufacturing and transport</td>
</tr>
<tr class="even" data-grouplength="4">
<td colspan="2" style="border-bottom: 0px solid">diversity/values/outcomes</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em; width: 60%;" data-indentlevel="1">not good health</td>
<td style="text-align: left;">reported fair, bad, very bad</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em; width: 60%;" data-indentlevel="1">white</td>
<td style="text-align: left;">ethnicity white British/Irish</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em; width: 60%;" data-indentlevel="1">Christian</td>
<td style="text-align: left;">Christian</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em; width: 60%;" data-indentlevel="1">EU-born</td>
<td style="text-align: left;">EU-born (not UK)</td>
</tr>
<tr class="odd" data-grouplength="2">
<td colspan="2" style="border-bottom: 0px solid">metropolitan / 'big city'</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em; width: 60%;" data-indentlevel="1">own home</td>
<td style="text-align: left;">own home</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em; width: 60%;" data-indentlevel="1">no car</td>
<td style="text-align: left;">don't own a car</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</figure>
</div>
</div>
<div id="tbl-variables-tex" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-variables-tex-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;6.2: Breakdown of variable types.
</figcaption><div aria-describedby="tbl-variables-tex-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">

</div>
</figure>
</div>
<p> <a href="#fig-scatters" class="quarto-xref">Figure&nbsp;<span>6.2</span></a> presents scatterplots from which the extent of linear association between these demographics and Leave voting in each constituency can be inferred. Each dot is a constituency, arranged on the x-axis according to the value of the explanatory variable and the y-axis according to the share of Leave vote. The scatterplots are faceted by explanatory variable and ordered left-to-right and top-to-bottom according to correlation coefficient. The variable most heavily correlated with Leave voting is <em>degree-education</em>: as the share of a constituency’s population educated at least to <em>degree-level</em> increases, the share of Leave vote in that constituency decreases. An association in the same direction, but to a lesser extent, is observed for variables representing similar concepts: <em>professional occupations</em>, <em>younger adults</em>, <em>EU-born</em>, <em>no-car</em> and the reverse for <em>Christian</em>, <em>not-good health</em> and <em>heavy industry</em>.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-scatters" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-scatters-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/06/scatters.png" class="img-fluid figure-img" style="width:90.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-scatters-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.2: Scatterplots of constituency Leave vote against selected explanatory variables.
</figcaption></figure>
</div>
</div>
</div>
<p></p>
<p> It is of course likely that many of the compositional characteristics of constituencies vary with Leave voting in consistent ways. Parallel coordinate plots may help visually explore this multivariate space. Whereas in scatterplots observations are represented as points located in x- and y- axes that are orthogonal, in a parallel coordinate plot observations are laid out across many parallel axes and the values of each observation encoded via a line connecting the multiple parallel axes. In <a href="#fig-pcps" class="quarto-xref">Figure&nbsp;<span>6.3</span></a> each of the thin lines is a constituency coloured according to the recorded voting outcome – either majority Remain (red) or Leave (blue). The first variable encoded is the size of the Leave vote, and variables are then ordered on their linear association with Leave. Note that we have reversed the polarity of variables such as <em>degree-educated</em> and <em>professional</em> so that we expect more Leave (blue lines) towards the right locations of the parallel axes. That the blue and red lines are reasonably separated suggests that there is a consistent pattern of association across many of the demographics characteristics in constituencies voting differently on Leave and Remain.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-pcps" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-pcps-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/06/pcps.png" class="img-fluid figure-img" style="width:80.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-pcps-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.3: Parallel coordinate plot of constituency Leave vote and selected explanatory variables.
</figcaption></figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
On parallel coordinate plots
</div>
</div>
<div class="callout-body-container callout-body">
<p> Although parallel coordinate plots enable some aspects of association between multiple variables to be inferred, they have several deficiencies. Association can only be directly inferred by comparing variables that are immediately adjacent. The order of parallel variables can greatly affect their visual appearance. And the corollary is that visual patterns of the plot that are salient may be incidental to the statistical features being inferred.</p>
</div>
</div>
<!--
::: {.callout-note}

 You will remember from introductory stats courses that that the correlation coefficient can be used to summarise the strength of linear association between two variables. It is a quantity that ranges from perfect negative correlation, -1 -- as one value increases another decreases in the same proportion -- to perfect positive correlation, +1 -- as one value increases another increases in the same proportion. A value of 0 indicates no association -- the values increase and decrease independently of each other.





::: {.cell}
::: {.cell-output-display}
![Scatterplots of synthetic bivariate data with extent of correlation coefficient systematically varied](figs/06/cors.png){#fig-cors width=100%}
:::
:::





::: -->
<p></p>
</section><section id="modelling-for-co-variation" class="level3" data-number="6.2.3"><h3 data-number="6.2.3" class="anchored" data-anchor-id="modelling-for-co-variation">
<span class="header-section-number">6.2.3</span> Modelling for co-variation</h3>
<p></p>
<p>Linear regression provides a framework for systematically describing the associations implied by the scatterplots and parallel coordinate plot, and with respect to the constituency-level variation identified in <a href="#fig-map-uniform" class="quarto-xref">Figure&nbsp;<span>6.1</span></a>. Having seen these data, the demographic variables in <a href="#fig-scatters" class="quarto-xref">Figure&nbsp;<span>6.2</span></a>, we can derive new expected values of constituency-level Leave voting.</p>
<p>To express this in equation form, we update the uniform model such that Leave vote is a <em>function</em> of the selected explanatory variables. For single-variable linear regression, we might select the proportion of residents educated at least to <em>degree-level</em> (<span class="math inline">{d_{i1}}</span>):</p>
<p><span class="math display">\begin{align*}
       y_{i}&amp;= \beta_{0} + \beta_{1}{d_{i1}} + \varepsilon_{i}  \\
\end{align*}</span></p>
<p>So we now estimate the Leave vote in each constituency (<span class="math inline">y_{i}</span>) as a function of:</p>
<ul>
<li>
<span class="math inline">\beta_{0}</span>, the intercept, the GB average vote share (<span class="math inline">\bar{y}</span>) <span class="math inline">+</span>
</li>
<li>
<span class="math inline">\beta_{1}=\beta_{1}{d_{i1}}</span>, the slope, indicating in which direction and to what extent <em>degree-educated</em> is associated with Leave, <span class="math inline">+</span>
</li>
<li>
<span class="math inline">\varepsilon_{i}</span>, the difference between <span class="math inline">y_{i}</span> (the observed value) and the unobservable ‘true population’ value of the Leave vote in that constituency (statistical error)</li>
</ul>
<!-- There are different algorithms that can be used to estimate these parameters. Most obvious is ordinary least squares (OLS), which aims to minimise the sum of the (squared) residuals between the observed Leave vote in a constituency, $y_{i}$, and that expected given the association with the *degree-educated* explanatory variable $d_{i1}$.  --><!-- Eyeballing the scatterplots in @fig-scatters we can already infer many of the parameters estimated via OLS regression. *Degree-educated* is most consistently associated with Leave voting and, according to our linear regression model, explains 60% of the total variation (the sum of bars in @fig-map-uniform) in constituency-level Leave voting. Also from the scatterplots, especially those associating Leave with *degree-educated* and *professionals*, there is a grouping of constituencies where the Leave vote is lower than we might expect given that constituency's population characteristics -- and this is reflected when inspecting the 1D distribution of residuals in histograms (not included here). --><p>It is of course likely that some demographic variables account for different elements of variation in the Leave vote than others. You will be aware that the linear regression model can be extended to include many explanatory variables:</p>
<p><span class="math display">\begin{align*}
      y_{i}&amp;= \beta_{0} +\beta_{1}x_{i1} + ... + \beta_{k}x_{ik} + \varepsilon_{i}  \\
\end{align*}</span></p>
<p>So this results in <em>separate</em> <span class="math inline">\beta_{k}</span> coefficients for separate explanatory variables. These coefficients can be interpreted as the degree of association between the explanatory variable <span class="math inline">k</span> and the outcome variable, keeping all the other explanatory variables constant – or the distinct correlation between an explanatory variable <span class="math inline">k</span> and the outcome variable, net of the other variables included in the model.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-outputs" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-outputs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/06/outputs.png" class="img-fluid figure-img" style="width:85.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-outputs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.4: Outputs from multiple regression model of Leave vote by demographic composition of constituency.
</figcaption></figure>
</div>
</div>
</div>
<p>In <a href="#fig-outputs" class="quarto-xref">Figure&nbsp;<span>6.4</span></a> are regression coefficients (<span class="math inline">\beta_{k}</span>) from a multiple regression model with <em>degree-educated</em>, <em>no car</em>, <em>white</em>, <em>heavy industry</em>, <em>EU-born</em> and <em>not good health</em> selected as explanatory variables. Coefficients are reported as dots with estimates of uncertainty represented as lines encoding 95% confidence intervals. <!-- the range of values the true (*unobservable*) coefficient is likely to take --> Most variables’ coefficients are in the direction that would be expected given the associations in <a href="#fig-scatters" class="quarto-xref">Figure&nbsp;<span>6.2</span></a>. Net of variation in the other compositional factors, increased levels of <em>degree-education</em> in a constituency has the effect of reducing the Leave vote. The two exceptions are <em>EU-born</em> and <em>white</em>: after controlling for variation in the other demographic variables, increased proportions of <em>white</em> residents reduces the Leave vote, and increased proportions of residents that are <em>EU-born</em> increases the Leave vote. Since the confidence interval for <em>white</em> crosses zero, this coefficient is subject to much uncertainty. Further exploration may allow us to identify whether these counter-intuitive effects are genuine or the result of a poorly-specified model.</p>
<p></p>
</section><section id="evaluating-model-bias" class="level3" data-number="6.2.4"><h3 data-number="6.2.4" class="anchored" data-anchor-id="evaluating-model-bias">
<span class="header-section-number">6.2.4</span> Evaluating model bias</h3>
<p> </p>
<p>Our analysis becomes more interesting when we start to explore and characterise model <em>bias</em>: any underlying structure to the observations that is less well accounted for by the model.</p>
<p>For area-level regression models such as ours, it is usual for residuals to exhibit some spatial autocorrelation structure. For certain parts of a country a model will overestimate an outcome given the relationship implied between explanatory and outcome variables; for other parts the outcome will be underestimated. This might occur due to:</p>
<ul>
<li>
<em>Spatial dependence in variable values</em> over space. We know that the geography of GB is quite socially distinctive, so it is reasonable to expect, for example, the range in variables like <em>heavy industry</em> and <em>white</em> to be bounded to economic regions and metropolitan-versus-peripheral regional contexts.</li>
<li>
<em>Spatial nonstationarity in processes</em> over space. It is possible that associations between variables might be grouped over space – that the associations vary for different parts of the country. For example, high levels of <em>EU-born</em> migration might affect political attitudes, and thus area-level voting, differently in different parts of the country.</li>
</ul>
<p>We can test for and characterise spatial autocorrelation in residuals by performing a graphical inference test, a map line-up <span class="citation" data-cites="beecham_map_2017 wickham_graphical_2010">(<a href="a2-references.html#ref-beecham_map_2017" role="doc-biblioref">Beecham et al. 2017</a>; <a href="a2-references.html#ref-wickham_graphical_2010" role="doc-biblioref">Wickham et al. 2010</a>)</span> against a null hypothesis of <em>complete spatial randomness</em> (CSR). A plot of real data, the true map of residuals, is hidden amongst a set of decoys; in this case maps with the residual values randomly permuted around constituencies. If the real map can be correctly identified from the decoys, then this lends statistical credibility to the claim that the observed data are not consistent with the null of CSR. Graphical line-up tests have been used in various domains, also to test regression assumptions <span class="citation" data-cites="loy_model_2017">(<a href="a2-references.html#ref-loy_model_2017" role="doc-biblioref">Loy, Hofmann, and Cook 2017</a>)</span>. The map line-up in <a href="#fig-lineup" class="quarto-xref">Figure&nbsp;<span>6.5</span></a> demonstrates that there <em>is</em> very obviously spatial and <em>regional</em> autocorrelation in residuals, and therefore structure that our regression model misses.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-lineup" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-lineup-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/06/lineups_hex_annotate.png" class="img-fluid figure-img" style="width:85.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-lineup-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.5: Map line-up of residuals in which the ‘real’ dataset is presented alongside 8 decoy plots generated under assumption of CSR.
</figcaption></figure>
</div>
</div>
</div>
<p>There are different ways of updating our model according to this geographic context. We have talked about patterning in residuals as being <em>spatial</em>, with values varying smoothly and continuously depending on location. This might be the case, but given the phenomena we are studying, it also plausible that distinct contexts are linked to regions. The residuals in <a href="#fig-lineup" class="quarto-xref">Figure&nbsp;<span>6.5</span></a> – the real being plot 3 – do seem to be grouped by regional boundaries, particularly Scotland looks categorically different. This suggests that geographic context might be usefully represented as a <em>category</em> rather than a continuous variable (location in <em>x,y</em>). We will therefore update our model representing geographic context as a <em>regional</em> grouping and cover approaches both to modelling <em>spatial dependence</em> in <em>values</em> and <em>spatial nonstationarity</em> in <em>processes</em>. </p>
</section><section id="geographic-context-as-grouped-nuisance-term" class="level3" data-number="6.2.5"><h3 data-number="6.2.5" class="anchored" data-anchor-id="geographic-context-as-grouped-nuisance-term">
<span class="header-section-number">6.2.5</span> Geographic context as grouped nuisance term</h3>
<p>A common approach to treating geographic dependence in the values of variables is to model geographic context as a Fixed Effect (FE). A dummy variable is created for each group (region in our case), and every region receives a constant. Any group-level sources of variation in the outcome are collapsed into the FE variable, which means that regression coefficients are not complicated by this more messy variation – they now capture the association between demographics and Leave after adjusting for systematic differences in the Leave vote due to region. So, for example, we know that Scotland is politically different from the rest of GB and that this appears to drag down the observed Leave vote for its constituencies. The constant term on region adjusts for this and prevents the estimated regression coefficients (inferred associations between variables) from being affected. Also estimated via the constant is the ‘base level’ in the outcome for each element of the group – net of demographic composition, the expected Leave vote in each region.</p>
<p>The linear regression model, extended with the FE term (<span class="math inline">{\gamma_{j}}</span>), for a single variable model:</p>
<p><span class="math display">\begin{align*}
       y_{i}&amp;= {\gamma_{j}}  + \beta_{1}x_{i1} + \varepsilon_{i}  \\
\end{align*}</span></p>
<p>So we now estimate the Leave vote in each constituency (<span class="math inline">y_{i}</span>) as a function of:</p>
<ul>
<li>
<span class="math inline">{\gamma_{j}}</span>, a constant term similar to an intercept for region <span class="math inline">j</span>, <span class="math inline">+</span>
</li>
<li>
<span class="math inline">\beta_{1}=\beta_{1}x_{i1}</span>, the slope, indicating in which direction and to what extent some explanatory variable measured at constituency <span class="math inline">i</span> is associated with Leave, <span class="math inline">+</span>
</li>
<li>
<span class="math inline">\varepsilon_{i}</span>, the difference between <span class="math inline">y_{i}</span> (the observed value) at constituency <span class="math inline">i</span> and the <em>unobservable</em> true population value of the Leave vote in that constituency (statistical error)</li>
</ul>
<p>Presented in <a href="#fig-outputs-fe" class="quarto-xref">Figure&nbsp;<span>6.6</span></a> are updated regression coefficients for a multivariate model fit with a FE on region. In the left panel are the FE constants. Together these capture the variance in Leave vote between regions after accounting for demographic composition. London is of particular interest. When initially analysing variation in the vote, constituencies in Scotland and London were distinctive in voting in much smaller proportions than the rest of the country for Leave. Given the associations we observe with Leave voting and demographic composition, however, if we were to randomly sample two constituencies that contain the same demographic characteristics, one in London and one in another region (say North West), on average we would expect the Leave vote for the London constituency to be higher (~60%) than that sampled from North West (~51%). A separate and more anticipated pattern is that Scotland would have a lower Leave vote (~38%) – that is, net of demographics there is some additional context in Scotland that means Leave is lower than in other regions.</p>
<p>In the right panel are the regression coefficients net of this between-region variation. Previously the <em>white</em> variable had a slight negative association with Leave, counterintuitively. Now the <em>white</em> variable has a direction of effect that conforms to expectation – net of variation in other demographics, increased proportions of <em>white</em> residents is associated with increased Leave voting. For another variable, <em>EU born</em>, the coefficient still unexpectedly suggests a positive association with Leave.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-outputs-fe" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-outputs-fe-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/06/outputs_fe.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-outputs-fe-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.6: Output from a multiple regression model of Leave voting against the demographic composition of constituencies, with a Fixed Effect term on region.
</figcaption></figure>
</div>
</div>
</div>
</section><section id="geographic-context-as-grouped-effects" class="level3" data-number="6.2.6"><h3 data-number="6.2.6" class="anchored" data-anchor-id="geographic-context-as-grouped-effects">
<span class="header-section-number">6.2.6</span> Geographic context as grouped effects</h3>
<!-- The benefit of the FE adjustment is that it provides coefficient estimates that are not affected by between-region variation. The FE constants themselves also allow group differences to be quantified net of differences in demographics. However, they simply identify the fact that this variation exists -- they do not permit non-stationarity in *process*. It is conceivable that the strength and direction of association between Leave and the candidate demographic variables may vary between regions. For example, that increased levels of *EU-born* (non-UK) residents might affect area-level voting differently in certain regions than others. -->
<p>Rather than simply allowing a constant term to vary, we can update the linear regression model with an interaction term (<span class="math inline">{\beta_{1j}}{x_{i1}}</span>) that permits the coefficient estimates to vary depending on region. This means we get a separate constant term and coefficient estimate of the effect of each variable on Leave for every region.</p>
<p><span class="math display">\begin{align*}
       y_{i}&amp;= {\gamma_{j}} + {\beta_{1j}}x_{i1} + \varepsilon_{i}  \\
\end{align*}</span></p>
<ul>
<li>
<span class="math inline">{\gamma_{j}}</span>, a constant term similar to an intercept for region <span class="math inline">j</span>, <span class="math inline">+</span>
</li>
<li>
<span class="math inline">{\beta_{1j}}x_{i1}</span>, the region-specific slope, indicating in which direction and to what extent some demographic variable at constituency <span class="math inline">i</span> and in region <span class="math inline">j</span> is associated with Leave, <span class="math inline">+</span>
</li>
<li>
<span class="math inline">\varepsilon_{i}</span>, the difference between <span class="math inline">y_{i}</span> (the observed value) at constituency <span class="math inline">i</span> and the <em>unobservable</em> true ‘population’ value of the Leave vote in that constituency (statistical error)</li>
</ul>
<p>In <a href="#fig-outputs-interact" class="quarto-xref">Figure&nbsp;<span>6.7</span></a> are region-specific coefficients derived from a multivariate model fit with this interaction term. In each region, <em>degree-educated</em> has a negative coefficient and with reasonably tight uncertainty estimates, or at least CIs that do not cross 0. The other variables are subject to more uncertainty. The <em>no-car</em> variable is also negatively associated with Leave, a variable we thought may separate metropolitan versus peripheral contexts, but the strength of negative association, after controlling for variation in other demographic factors, does vary by region. The <em>heavy industry</em> variable, previously identified as being strongly associated with Leave, has a clear positive association only for London and to a much lesser extent for North West and Wales (small coefficients). The <em>EU-born</em> variable is again the least consistent as it flips between positive and negative association when analysed at the regional-level: after controlling for variation in other demographic characteristics, it is positively associated with Leave for North West, Scotland, South West, but negatively associated with Leave for the North East, though with coefficients that are subject to much variation.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-outputs-interact" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-outputs-interact-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/06/outputs_interact.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-outputs-interact-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.7: Output from multiple regression model of Leave vote by demographic composition of constituency with a Fixed Effect and interaction term on region.
</figcaption></figure>
</div>
</div>
</div>
<p> </p>
</section><section id="estimate-volatility-and-alternative-modelling-approaches" class="level3" data-number="6.2.7"><h3 data-number="6.2.7" class="anchored" data-anchor-id="estimate-volatility-and-alternative-modelling-approaches">
<span class="header-section-number">6.2.7</span> Estimate volatility and alternative modelling approaches</h3>
<p>Our treatment of regression frameworks has in this chapter been reasonably breezy; there are problems that we have not discussed. Introducing FE and interaction terms without adding data reduces statistical power as data are heavily partitioned. Given the fact that our data are hierarchically structured (constituencies sit within regions), hierarchical or multi-level modelling may be more appropriate to this sort of regional grouping. Multi-level modelling uses partial pooling, borrowing data to make estimated coefficients more conservative, less locally biased, where there are comparatively few observations in particular groupings <span class="citation" data-cites="gelman_data_2006">(see <a href="a2-references.html#ref-gelman_data_2006" role="doc-biblioref">Gelman and Hill 2006</a>)</span>. There are also many ways in which associations between values can be modelled <em>continuously</em> over space. For the case of geographically weighted regression (GWR) <span class="citation" data-cites="brunsdon_geographically_2002">(<a href="a2-references.html#ref-brunsdon_geographically_2002" role="doc-biblioref">Brunsdon, Fortheringham, and Charlton 2002</a>)</span>, local regression coefficients for each spatial unit. Geographically Weighted-statistics enable spatial non-stationarity in process to be flexibly explored and characterised – in this case study, interesting and explainable directions of effect between Leave voting and <em>EU-born</em> <span class="citation" data-cites="beecham_locally-varying_2018">(see <a href="a2-references.html#ref-beecham_locally-varying_2018" role="doc-biblioref">Beecham, Slingsby, and Brunsdon 2018</a>)</span>. Since GWR involves generating many hundreds of parameter estimates, visual approaches are as ever primarily used in their interpretation and analysis <span class="citation" data-cites="dykes_geographically_2007">(see <a href="a2-references.html#ref-dykes_geographically_2007" role="doc-biblioref">Dykes and Brunsdon 2007</a>)</span>.</p>
<p> </p>
</section></section><section id="techniques" class="level2" data-number="6.3"><h2 data-number="6.3" class="anchored" data-anchor-id="techniques">
<span class="header-section-number">6.3</span> Techniques</h2>
<p>The technical element to this chapter demonstrates how linear regression models can be specified in R, including approaches to extract model summaries and diagnostics, and of course how to represent and evaluate them using data graphics. Data recording estimated vote shares for Leave by Parliamentary Constituency, as well as constituency-level Census demographics, were originally collected from the <code>parlitools</code> package.</p>
<section id="import-transform-explore" class="level3" data-number="6.3.1"><h3 data-number="6.3.1" class="anchored" data-anchor-id="import-transform-explore">
<span class="header-section-number">6.3.1</span> Import, transform, explore</h3>
<ul>
<li>Download the <code>06-template.qmd</code><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> file for this chapter, and save it to your <code>vis4sds</code> project.</li>
<li>Open your <code>vis4sds</code> project in RStudio, and load the template file by clicking <code>File</code> &gt; <code>Open File ...</code> &gt; <code>06-template.qmd</code>.</li>
</ul>
<p>The template file lists the required packages: <code>tidyverse</code>, <code>sf</code> and <code>tidymodels</code> for extracting model outputs. The processed data with selected 2011 Census demographics can be loaded from the book’s accompanying data repository. In this folder is also a <code>.geojson</code> file containing a hexagon cartogram of UK parliamentary constituencies, derived from Open-Innovations’ <code>HexJSON</code> format.</p>
<p> Explanatory variables describing the demographic composition of constituencies are recorded as proportions. In order to support comparison in the multivariate models, they must be z-score transformed. The distance between observed values for each 2011 Census variable is expressed in standard deviation units from the mean across constituencies for that variable. Our approach is to perform this transformation on each explanatory variable before piping into the model specification. This is achieved with <code>across()</code>. The first argument is the set of columns to which you would like the same function to be applied, and the second is the function you would like to apply. Remembering that <code>mutate()</code> works over columns of a data frame, and that a single column of a data frame is a vector of values, the notation <code>.x</code> is used to access each element of the columns being worked across.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># z-score transform explanatory variables before model</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># specification.</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>cons_data <span class="sc">|&gt;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">.cols=</span><span class="fu">c</span>(younger<span class="sc">:</span>heavy_industry),</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">.fns=</span><span class="sc">~</span>(.x<span class="sc">-</span><span class="fu">mean</span>(.x))<span class="sc">/</span><span class="fu">sd</span>(.x)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="sc">&lt;</span>some<span class="sc">-</span>model<span class="sc">-</span>specification<span class="sc">-</span>code<span class="sc">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p></p>
<p>In <a href="#fig-scatters" class="quarto-xref">Figure&nbsp;<span>6.2</span></a> and <a href="#fig-pcps" class="quarto-xref">Figure&nbsp;<span>6.3</span></a> associations between candidate explanatory variables and Leave are explored using scatterplots and parallel coordinate plots respectively. To avoid cluttering this section, documented code for reproducing these plots is in the <code>06-template.qmd</code> file for this chapter and inserted below, but without detailed explanation.</p>
<div class="cell">
<details class="code-fold"><summary>Expose code for parallel coordinate plots</summary><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Data staging and ggplot2 code for PCPs --------------------------</span></span>
<span></span>
<span><span class="co"># Pull out and order variable names on their correlation with Leave.</span></span>
<span><span class="va">order_vars</span> <span class="op">&lt;-</span> <span class="va">cons_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">younger</span><span class="op">:</span><span class="va">heavy_industry</span><span class="op">)</span>, <span class="op">~</span><span class="op">(</span><span class="va">.x</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span></span>
<span>    cols<span class="op">=</span><span class="va">younger</span><span class="op">:</span><span class="va">heavy_industry</span>, names_to<span class="op">=</span><span class="st">"expl_var"</span>, values_to<span class="op">=</span><span class="st">"prop"</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">expl_var</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu">summarise</span><span class="op">(</span>cor<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span><span class="va">leave</span>,<span class="va">prop</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">arrange</span><span class="op">(</span><span class="va">cor</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu">pull</span><span class="op">(</span><span class="va">expl_var</span><span class="op">)</span></span>
<span><span class="co"># Create staged dataset for plotting.</span></span>
<span><span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="va">cons_data</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    majority<span class="op">=</span><span class="fu">if_else</span><span class="op">(</span><span class="va">leave</span><span class="op">&gt;</span><span class="fl">.5</span>, <span class="st">"Leave"</span>, <span class="st">"Remain"</span><span class="op">)</span>,</span>
<span>    <span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">leave</span>, <span class="va">younger</span><span class="op">:</span><span class="va">heavy_industry</span><span class="op">)</span>, <span class="op">~</span><span class="op">(</span><span class="va">.x</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    decile<span class="op">=</span><span class="fu">ntile</span><span class="op">(</span><span class="va">leave</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>    is_extreme <span class="op">=</span> <span class="va">decile</span> <span class="op">&gt;</span> <span class="fl">9</span> <span class="op">|</span> <span class="va">decile</span> <span class="op">&lt;</span> <span class="fl">2</span></span>
<span>  <span class="op">)</span>  <span class="op">|&gt;</span> </span>
<span>  <span class="co"># Select out variables needed for plot.</span></span>
<span>  <span class="fu">select</span><span class="op">(</span></span>
<span>    <span class="va">majority</span>, <span class="va">is_extreme</span>, <span class="va">constituency_name</span>, <span class="va">leave</span>, </span>
<span>    <span class="va">degree</span>, <span class="va">professional</span>, <span class="va">younger</span>, <span class="va">eu_born</span>, <span class="va">no_car</span>, <span class="va">white</span>, <span class="va">own_home</span>, </span>
<span>    <span class="va">christian</span>, <span class="va">not_good_health</span>, <span class="va">heavy_industry</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="co"># Change polarity in selected variables.</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    degree<span class="op">=</span><span class="op">-</span><span class="va">degree</span>, professional<span class="op">=</span><span class="op">-</span><span class="va">professional</span>, younger<span class="op">=</span><span class="op">-</span><span class="va">younger</span>, </span>
<span>    eu_born<span class="op">=</span><span class="op">-</span><span class="va">eu_born</span>, no_car<span class="op">=</span><span class="op">-</span><span class="va">no_car</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="co"># Gather explanatory variables for along rows.</span></span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span></span>
<span>    cols<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">leave</span><span class="op">:</span><span class="va">not_good_health</span><span class="op">)</span>, names_to<span class="op">=</span><span class="st">"var"</span>, values_to<span class="op">=</span><span class="st">"z_score"</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># Recode new explanatory variable as factor ordered according to </span></span>
<span>  <span class="co"># known assocs. Reverse order here as coord_flip() used in plot.</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    var<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">var</span>, levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"leave"</span>, <span class="va">order_vars</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    var<span class="op">=</span><span class="fu">fct_rev</span><span class="op">(</span><span class="va">var</span><span class="op">)</span></span>
<span>  <span class="op">)</span> </span>
<span><span class="co"># Plot PCP.</span></span>
<span><span class="va">plot_data</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span></span>
<span>    <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">var</span>, y<span class="op">=</span><span class="va">z_score</span>, group<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">constituency_name</span><span class="op">)</span>, </span>
<span>    colour<span class="op">=</span><span class="va">majority</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_path</span><span class="op">(</span> alpha<span class="op">=</span><span class="fl">0.15</span>, linewidth<span class="op">=</span><span class="fl">.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_colour_manual</span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#2166ac"</span>, <span class="st">"#b2182b"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_flip</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task
</div>
</div>
<div class="callout-body-container callout-body">
<div class="line-block">While the template provides code for reproducing the faceted scatterplots and parallel coordinate plots, there are some omissions. You will notice that in <a href="#fig-pcps" class="quarto-xref">Figure&nbsp;<span>6.3</span></a> two very high Leave and Remain constituencies are highlighted, using thicker red and blue lines and labelling.<br><br>
Can you update the ggplot2 spec to create a similar effect? There are different ways of doing this, but you may want to add a separate <code>geom_segment()</code> layer <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code>-ed on these selected boroughs. The text annotations may be generated manually using <code>annotate()</code>, or derived from data using <code>geom_text()</code>.</div>
</div>
</div>
<p></p>
</section><section id="model-tidily" class="level3" data-number="6.3.2"><h3 data-number="6.3.2" class="anchored" data-anchor-id="model-tidily">
<span class="header-section-number">6.3.2</span> Model tidily</h3>
<p></p>
<p>The most straightforward way of specifying a linear regression model is with the <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> function and <code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code> to extract regression coefficients.</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="va">cons_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    <span class="fu">across</span><span class="op">(</span></span>
<span>      .cols<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">younger</span><span class="op">:</span><span class="va">heavy_industry</span><span class="op">)</span>,</span>
<span>      .fns<span class="op">=</span><span class="op">~</span><span class="op">(</span><span class="va">.x</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">leave</span> <span class="op">~</span> <span class="va">degree</span>, data<span class="op">=</span><span class="va">.</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span><span class="co"># Call:</span></span>
<span><span class="co"># lm(formula = leave ~ degree, data = .)</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Residuals:</span></span>
<span><span class="co">#      Min       1Q   Median       3Q      Max</span></span>
<span><span class="co"># -0.25521 -0.02548  0.01957  0.05143  0.11237</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Coefficients:</span></span>
<span><span class="co">#             Estimate Std. Error t value Pr(&gt;|t|)</span></span>
<span><span class="co"># (Intercept)  0.520583   0.002896  179.78   &lt;2e-16 ***</span></span>
<span><span class="co"># degree      -0.088276   0.002898  -30.46   &lt;2e-16 ***</span></span>
<span><span class="co"># ---</span></span>
<span><span class="co"># Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Residual standard error: 0.07279 on 630 degrees of freedom</span></span>
<span><span class="co"># Multiple R-squared:  0.5956,  Adjusted R-squared:  0.595</span></span>
<span><span class="co"># F-statistic: 927.9 on 1 and 630 DF,  p-value: &lt; 2.2e-16</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With <code>tidymodels</code>, specifically the <code>broom</code> package, we can extract model outputs in a format that adheres to tidy data <span class="citation" data-cites="wickham_tidy_2014">(<a href="a2-references.html#ref-wickham_tidy_2014" role="doc-biblioref">Wickham 2014</a>)</span>.</p>
<ul>
<li>
<code>tidy()</code> returns estimated coefficients as a data frame.</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tidy</span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span><span class="co"># # A tibble: 2 × 5</span></span>
<span><span class="co"># term        estimate std.error statistic   p.value</span></span>
<span><span class="co"># &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co"># 1 (Intercept)   0.521    0.00290     180.  0</span></span>
<span><span class="co"># 2 degree       -0.0883   0.00290     -30.5 5.67e-126</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>
<code>glance()</code> returns a single row containing summaries of model fit.</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">glance</span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span><span class="co"># # A tibble: 1 × 12</span></span>
<span><span class="co"># r.sq adj.r.sq  sigma   stat p.value     df logLik   AIC   BIC</span></span>
<span><span class="co"># &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span><span class="co">#  1    0.596  0.595 0.0728   928.5.67e-126   1   760 -1514. -1501.</span></span>
<span><span class="co"># # ℹ 3 more variables: deviance &lt;dbl&gt;, df.residual &lt;int&gt;, nobs &lt;int&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>
<code>augment()</code> returns a data frame of residuals and predictions (fitted values) for the model realisation.</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">augment</span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span><span class="co"># # A tibble: 632 × 8</span></span>
<span><span class="co"># leave  degree .fitted   .resid    .hat .sigma   .cooksd .std.resid</span></span>
<span><span class="co"># &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;</span></span>
<span><span class="co"># 1 0.579 -0.211    0.539  0.0398  0.00165 0.0728 0.000247     0.547</span></span>
<span><span class="co"># 2 0.678 -0.748    0.587  0.0914  0.00247 0.0728 0.00195      1.26</span></span>
<span><span class="co"># 3 0.386  1.63     0.376  0.00957 0.00582 0.0729 0.0000509    0.132</span></span>
<span><span class="co"># 4 0.653 -0.964    0.606  0.0473  0.00306 0.0728 0.000648     0.650</span></span>
<span><span class="co"># ...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The advantage of generating model diagnostics and outputs that are tidy is that it eases the process of working with many model realisations. This is a common requirement for modern data analysis, where statistical inferences are made empirically from resampling. For example, we may wish to generate single-variable linear regression models separately for each selected explanatory variable. We could use these outputs to annotate the scatterplots in <a href="#fig-scatters" class="quarto-xref">Figure&nbsp;<span>6.2</span></a> by their regression line and colour observations according to their residual values, distance from the regression line. These models can be generated with reasonably little code by making use of the package <code>broom</code> and a style of functional programming in R, which is supported by the <code>purrr</code> package.</p>
<p>Example code:</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">single_model_fits</span> <span class="op">&lt;-</span> <span class="va">cons_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">younger</span><span class="op">:</span><span class="va">heavy_industry</span><span class="op">)</span>, <span class="op">~</span><span class="op">(</span><span class="va">.x</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span></span>
<span>    cols<span class="op">=</span><span class="va">younger</span><span class="op">:</span><span class="va">heavy_industry</span>,</span>
<span>    names_to<span class="op">=</span><span class="st">"expl_var"</span>, values_to<span class="op">=</span><span class="st">"z_score"</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Nest to generate list-column by expl_var.</span></span>
<span>  <span class="fu">nest</span><span class="op">(</span>data<span class="op">=</span><span class="op">-</span><span class="va">expl_var</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    <span class="co"># Use map() to iterate over the list of datasets.</span></span>
<span>    model <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">data</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">leave</span> <span class="op">~</span> <span class="va">z_score</span>, data <span class="op">=</span> <span class="va">.x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="co"># glance() for each model fit.</span></span>
<span>    fits <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">model</span>, <span class="va">glance</span><span class="op">)</span>,</span>
<span>    <span class="co"># tidy() for coefficients.</span></span>
<span>    coefs <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">model</span>, <span class="va">tidy</span><span class="op">)</span>,</span>
<span>    <span class="co"># augment() for predictions/residuals.</span></span>
<span>    values<span class="op">=</span><span class="fu">map</span><span class="op">(</span><span class="va">model</span>, <span class="va">augment</span><span class="op">)</span>,</span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">single_model_fits</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Unnest output from glance.</span></span>
<span>  <span class="fu">unnest</span><span class="op">(</span>cols <span class="op">=</span> <span class="va">fits</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Remove other list-columns.</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">model</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># # A tibble: 10 × 15</span></span>
<span><span class="co"># expl_var  r.squared adj.r.sq  sigma  stat   p.value  df logLik   AIC</span></span>
<span><span class="co"># &lt;chr&gt;         &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co"># 1 younger    0.289     0.288 0.0965  257. 1.05e- 48   1   582. -1158.</span></span>
<span><span class="co"># 2 own_home   0.185     0.184 0.103   143. 7.42e- 30   1   539. -1071.</span></span>
<span><span class="co"># 3 no_car     0.157     0.155 0.105   117. 3.81e- 25   1   528. -1050.</span></span>
<span><span class="co"># 4 white      0.169     0.168 0.104   128. 3.79e- 27   1   532. -1059.</span></span>
<span><span class="co"># 5 eu_born    0.233     0.232 0.100   191. 3.42e- 38   1   558. -1110.</span></span>
<span><span class="co"># 6 christian  0.238     0.236 0.100   196. 4.95e- 39   1   560. -1114.</span></span>
<span><span class="co"># 7 professi…  0.320     0.319 0.0944  296. 1.08e- 54   1   596. -1186.</span></span>
<span><span class="co"># 8 degree     0.596     0.595 0.0728  928. 5.67e-126   1   760. -1514.</span></span>
<span><span class="co"># 9 not_good…  0.316     0.315 0.0947  291. 5.93e- 54   1   594. -1182.</span></span>
<span><span class="co"># 10 heavy_in… 0.504     0.503 0.0806  640. 5.43e- 98   1   696. -1385.</span></span>
<span><span class="co"># # ℹ 6 more variables: BIC &lt;dbl&gt;, deviance &lt;dbl&gt;, df.residual &lt;int&gt;, </span></span>
<span><span class="co"># #    nobs &lt;int&gt;, coefs &lt;list&gt;, values &lt;list&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Code description:</p>
<ol type="1">
<li>
<em>Setup</em>: In order to generate separate models for separate explanatory variables, we need to generate nested data frames. These are data frames stored in a special type of column (a <code>list-column</code>) in which the values of the column is a list of data frames – one for each explanatory variable over which we would like to compute a model. You can think of parameterising <code>nest()</code> in a similar way to <code>group_by()</code>. We first <code>pivot_longer()</code> to generate a data frame where each observation contains the recorded Leave vote for a constituency and its corresponding <code>z_score</code> value for each explanatory variable. There are 10 explanatory variables and so <code>nest()</code> returns a data frame with the dimensions <code>10x2</code> – a variable identifying the explanatory variable on which the model is to be built (<code>expl_var</code>) and a <code>list-column</code>, each element containing a data frame with the dimensions <code>632x13</code>.</li>
<li>
<em>Build model</em>: In <code>mutate()</code>, <code>purrr</code>’s <code>map()</code> function is used to iterate over the list of datasets and fit a model to each nested dataset. The new column <code>model</code> is a <code>list-column</code> this time containing a list of model objects.</li>
<li>
<em>Generate outputs</em>: Next, the different cuts of model outputs can be made using <code>glance(), tidy(), augment()</code>, with <code>map()</code> to iterate over the list of model objects. The new columns are now <code>list-columns</code> of data frames containing model outputs.</li>
<li>
<em>Extract outputs</em>: Finally we want to extract the values from these nested data. This can be achieved using <code>unnest()</code> and supplying to the <code>cols</code> argument the names of the <code>list-columns</code> from which we want to extract values.</li>
</ol></section><section id="plot-models-tidily" class="level3" data-number="6.3.3"><h3 data-number="6.3.3" class="anchored" data-anchor-id="plot-models-tidily">
<span class="header-section-number">6.3.3</span> Plot models tidily</h3>
<p>In <a href="#fig-outputs" class="quarto-xref">Figure&nbsp;<span>6.4</span></a> estimated regression coefficients are plotted from a multivariate model, annotated with 95% Confidence Intervals. The ggplot2 specification is reasonably straightforward.</p>
<p>The code for <a href="#fig-outputs" class="quarto-xref">Figure&nbsp;<span>6.4</span></a>:</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="va">cons_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">younger</span><span class="op">:</span><span class="va">heavy_industry</span><span class="op">)</span>, <span class="op">~</span><span class="op">(</span><span class="va">.x</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">leave</span> <span class="op">~</span> <span class="va">degree</span> <span class="op">+</span> <span class="va">eu_born</span> <span class="op">+</span> <span class="va">white</span>  <span class="op">+</span> <span class="va">no_car</span> <span class="op">+</span> <span class="va">not_good_health</span> <span class="op">+</span> </span>
<span>    <span class="va">heavy_industry</span>, data<span class="op">=</span><span class="va">.</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tidy</span><span class="op">(</span><span class="va">model</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">!=</span> <span class="st">"(Intercept)"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span></span>
<span>    <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html">reorder</a></span><span class="op">(</span><span class="va">term</span>, <span class="op">-</span><span class="va">estimate</span><span class="op">)</span>,</span>
<span>        y<span class="op">=</span><span class="va">estimate</span>, ymin<span class="op">=</span><span class="va">estimate</span><span class="op">-</span><span class="fl">1.96</span><span class="op">*</span><span class="va">std.error</span>,</span>
<span>        ymax<span class="op">=</span><span class="va">estimate</span><span class="op">+</span><span class="fl">1.96</span><span class="op">*</span><span class="va">std.error</span><span class="op">)</span></span>
<span>        <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_pointrange</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_flip</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The plot specification:</p>
<ol type="1">
<li>
<em>Data</em>: A data frame of model coefficients extracted from the multivariate model object (<code>model</code>) using <code>tidy()</code>.</li>
<li>
<em>Encoding</em>: y-position varies according to the size of the coefficient <code>estimate</code> and the 95% confidence intervals, derived from <code>std.error</code> and encoded using <code>ymin</code> and <code>ymax</code> parameters.</li>
<li>
<em>Marks</em>: <code>geom_pointrange()</code>, which understands <code>ymin</code> and <code>ymax</code>, for the dots with confidence intervals.</li>
<li>
<em>Setting</em>: <code>coord_flip()</code> to make variable names easier to read.</li>
</ol></section><section id="extend-model-terms" class="level3" data-number="6.3.4"><h3 data-number="6.3.4" class="anchored" data-anchor-id="extend-model-terms">
<span class="header-section-number">6.3.4</span> Extend model terms</h3>
<p>To include a Fixed Effect (FE) term on region, the <code>region</code> variable is simply added as a variable to <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code>. However, we must convert it to a factor variable; this has the effect of creating dummies on each value of <code>region</code>. Default behaviour within <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> is to hold back a reference value of region with FE regression coefficients describing the effect on the outcome of a constituency located in a given region relative to that reference region. So the reference region (intercept) in the model below is East Midlands – the first in the factor to appear alphabetically. The signed coefficient estimates for regions identifies whether, after controlling for variation in demographics, the Leave vote for a particular region is expected to be higher or lower than this.</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cons_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    <span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">younger</span><span class="op">:</span><span class="va">heavy_industry</span><span class="op">)</span>, <span class="op">~</span><span class="op">(</span><span class="va">.x</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    region<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">leave</span> <span class="op">~</span> <span class="va">region</span> <span class="op">+</span> <span class="va">degree</span> <span class="op">+</span> <span class="va">eu_born</span> <span class="op">+</span> <span class="va">white</span>  <span class="op">+</span> <span class="va">no_car</span> <span class="op">+</span> </span>
<span>    <span class="va">not_good_health</span> <span class="op">+</span> <span class="va">heavy_industry</span>, data<span class="op">=</span><span class="va">.</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tidy</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># # A tibble: 17 × 5</span></span>
<span><span class="co"># term                      estimate std.error statistic  p.value</span></span>
<span><span class="co"># &lt;chr&gt;                        &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">#   1 (Intercept)                0.530     0.00581    91.3   0</span></span>
<span><span class="co"># 2 regionEast of England      0.00363   0.00787     0.462 6.45e- 1</span></span>
<span><span class="co"># 3 regionLondon               0.0654    0.00948     6.90  1.30e-11</span></span>
<span><span class="co"># 4 regionNorth East           0.00482   0.00945     0.510 6.10e- 1</span></span>
<span><span class="co"># 5 regionNorth West          -0.0200    0.00728    -2.75  6.12e- 3</span></span>
<span><span class="co"># 6 regionScotland            -0.145     0.00843   -17.2   1.28e-54</span></span>
<span><span class="co"># 7 regionSouth East           0.00377   0.00752     0.502 6.16e- 1</span></span>
<span><span class="co"># 8 regionSouth West          -0.0233    0.00789    -2.95  3.26e- 3</span></span>
<span><span class="co"># 9 regionWales               -0.0547    0.00860    -6.36  3.87e-10</span></span>
<span><span class="co"># 10 regionWest Midlands       0.0236    0.00745     3.17  1.59e- 3</span></span>
<span><span class="co"># 11 regionYorkshire           0.0112    0.00762     1.47  1.41e- 1</span></span>
<span><span class="co"># 12 degree                   -0.0772    0.00339   -22.8   1.30e-83</span></span>
<span><span class="co"># 13 eu_born                   0.0163    0.00308     5.29  1.72e- 7</span></span>
<span><span class="co"># 14 white                     0.0303    0.00314     9.66  1.18e-20</span></span>
<span><span class="co"># 15 no_car                   -0.0336    0.00292   -11.5   6.50e-28</span></span>
<span><span class="co"># 16 not_good_health           0.0102    0.00331     3.07  2.24e- 3</span></span>
<span><span class="co"># 17 heavy_industry            0.0132    0.00266     4.96  9.23e- 7</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We want our model to represent a dummy for every region, and so we add <code>-1</code> to the specification. Doing this removes the intercept or reference region, making <span class="math inline">R^2</span> no longer meaningful.</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cons_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    <span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">younger</span><span class="op">:</span><span class="va">heavy_industry</span><span class="op">)</span>, <span class="op">~</span><span class="op">(</span><span class="va">.x</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    region<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">leave</span> <span class="op">~</span> <span class="va">region</span> <span class="op">+</span> <span class="va">degree</span> <span class="op">+</span> <span class="va">eu_born</span> <span class="op">+</span> <span class="va">white</span>  <span class="op">+</span> <span class="va">no_car</span> <span class="op">+</span> </span>
<span>    <span class="va">not_good_health</span> <span class="op">+</span> <span class="va">heavy_industry</span> <span class="op">-</span><span class="fl">1</span>, data<span class="op">=</span><span class="va">.</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span> <span class="fu">glance</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># # A tibble: 1 × 12</span></span>
<span><span class="co"># r.squared adj.r.squared sigma statistic p.value df logLik AIC </span></span>
<span><span class="co"># &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#   1    0.995  0.995 0.0371  7625.   0     17  1193. -2351. </span></span>
<span><span class="co"># # ℹ 3 more variables: deviance &lt;dbl&gt;, df.residual &lt;int&gt;, nobs &lt;int&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To include an Interaction on region, we need to set a variable that will be used to represent these regional constants (<code>cons</code>), and the Interaction is added with the notation <code>:</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="va">cons_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    <span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">younger</span><span class="op">:</span><span class="va">heavy_industry</span><span class="op">)</span>, <span class="op">~</span><span class="op">(</span><span class="va">.x</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    region<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span>, cons<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">leave</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span></span>
<span>       <span class="op">(</span><span class="va">cons</span> <span class="op">+</span> <span class="va">degree</span>  <span class="op">+</span> <span class="va">eu_born</span> <span class="op">+</span> <span class="va">white</span>  <span class="op">+</span> <span class="va">no_car</span> <span class="op">+</span> <span class="va">not_good_health</span> <span class="op">+</span></span>
<span>       <span class="va">heavy_industry</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">region</span><span class="op">)</span>,</span>
<span>     data<span class="op">=</span><span class="va">.</span></span>
<span>     <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The model updated with the regional Interaction term results in many more coefficients that are, as discussed, somewhat unstable. To plot them, as in <a href="#fig-outputs-interact" class="quarto-xref">Figure&nbsp;<span>6.7</span></a>, we minimally update the code used to generate the previous model outputs.</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tidy</span><span class="op">(</span><span class="va">model</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">separate</span><span class="op">(</span><span class="va">term</span>, into<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"term"</span>, <span class="st">"region"</span><span class="op">)</span>, sep<span class="op">=</span><span class="st">":"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>region<span class="op">=</span><span class="fu">str_remove</span><span class="op">(</span><span class="va">region</span>,<span class="st">"region"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">term</span><span class="op">!=</span><span class="st">"cons"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_col</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html">reorder</a></span><span class="op">(</span><span class="va">term</span>, <span class="op">-</span><span class="va">estimate</span><span class="op">)</span>, y<span class="op">=</span><span class="va">estimate</span><span class="op">)</span>, alpha<span class="op">=</span><span class="fl">.3</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_pointrange</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span></span>
<span>    x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html">reorder</a></span><span class="op">(</span><span class="va">term</span>, <span class="op">-</span><span class="va">estimate</span><span class="op">)</span>,y<span class="op">=</span><span class="va">estimate</span>,</span>
<span>    ymin<span class="op">=</span><span class="va">estimate</span><span class="op">-</span><span class="fl">1.96</span><span class="op">*</span><span class="va">std.error</span>, ymax<span class="op">=</span><span class="va">estimate</span><span class="op">+</span><span class="fl">1.96</span><span class="op">*</span><span class="va">std.error</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, size<span class="op">=</span><span class="fl">.2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">region</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_flip</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The plot specification:</p>
<ol type="1">
<li>
<em>Data</em>: A data frame of model coefficients extracted from the multivariate model object using <code>tidy()</code>. To make clean plot labels we need to remove unnecessary text in the <code>term</code> variable (e.g.&nbsp;“cons:regionEast Midlands”). <code>separate()</code> allows us to split this column on <code>:</code> and then <code>str_remove()</code> is quite obvious. We do not wish to plot the FE constants and so <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code> them out.</li>
<li>
<em>Encoding</em>: y-position varies according to the size of the coefficient estimate and the 95% confidence intervals, in exactly the same way as for <a href="#fig-outputs" class="quarto-xref">Figure&nbsp;<span>6.4</span></a>.</li>
<li>
<em>Marks</em>: <code>geom_pointrange()</code>, encoded as in <a href="#fig-outputs" class="quarto-xref">Figure&nbsp;<span>6.4</span></a>. The only addition is light bars in the background (<code>geom_col()</code>). This seems to aid interpretation of the direction and size of the coefficients.</li>
<li>
<em>Facets</em>: <code>facet_wrap()</code> on <code>region</code> in order to display coefficients estimated separately for each region.</li>
</ol>
<p></p>
</section><section id="evaluate-models-with-lineups" class="level3" data-number="6.3.5"><h3 data-number="6.3.5" class="anchored" data-anchor-id="evaluate-models-with-lineups">
<span class="header-section-number">6.3.5</span> Evaluate models with lineups</h3>
<p> In <a href="#fig-lineup-fe" class="quarto-xref">Figure&nbsp;<span>6.8</span></a> is a map line-up of the residuals from FE-updated model – our expectation is that these residuals should <em>no longer</em> be spatially autocorrelated, since we collapse regional varation into our FE term.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-lineup-fe" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-lineup-fe-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/06/lineups_fe.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-lineup-fe-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.8: Map line-up of residuals from model with Fixed Effect on region. The ‘real’ dataset is presented alongside 8 decoy plots generated by randomly permuting the observed residuals around constituencies. Adding the FE term has addressed some of the systematic over- and under-estimation of the vote between regions (compare for example <a href="#fig-lineup" class="quarto-xref">Figure&nbsp;<span>6.5</span></a>). There is nevertheless obvious spatial autocorrelation, plot 2 being the real data. Further analysis, for example of the constituencies for which Leave is particularly over- and under-represented, may be instructive.
</figcaption></figure>
</div>
</div>
</div>
<p>Using functional-style programming, and index{packages!} <code>tidymodels</code>, plot lineups can be generated with surprisingly paired-back code. First generate a model object and extract residuals from it, again making use of <code>nest()</code>, <code>map()</code> and <code>augment()</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="va">cons_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">population</span>, <span class="va">population_density</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    <span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">younger</span><span class="op">:</span><span class="va">heavy_industry</span><span class="op">)</span>, <span class="op">~</span><span class="op">(</span><span class="va">.x</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    type<span class="op">=</span><span class="st">"full_dataset"</span>, region<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">nest</span><span class="op">(</span>data<span class="op">=</span><span class="op">-</span><span class="va">type</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    <span class="co"># Include `-1` to eliminate the constant term and include </span></span>
<span>    <span class="co"># a dummy for every area.</span></span>
<span>    model<span class="op">=</span><span class="fu">map</span><span class="op">(</span><span class="va">data</span>,</span>
<span>      <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">leave</span> <span class="op">~</span> <span class="va">region</span> <span class="op">+</span>  <span class="va">degree</span>  <span class="op">+</span> <span class="va">eu_born</span> <span class="op">+</span> <span class="va">white</span>  <span class="op">+</span> <span class="va">no_car</span> <span class="op">+</span> </span>
<span>      <span class="va">not_good_health</span> <span class="op">+</span> <span class="va">heavy_industry</span> <span class="op">-</span><span class="fl">1</span>, data<span class="op">=</span><span class="va">.x</span><span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>    <span class="co"># augment() for predictions / residuals.</span></span>
<span>    values<span class="op">=</span><span class="fu">map</span><span class="op">(</span><span class="va">model</span>, <span class="va">augment</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, generate permuted data by randomly shuffling residual values around constituencies. To do this requires some knowledge of the <code>rsample</code> package and its functions. We extract residuals from the <code>list-column</code> named <code>values</code>, remove redundant <code>list-columns</code> (with <code>select()</code>) and then <code>unnest()</code> on the original data and the new <code>resids</code> field to return to a dataset where each row is a constituency, but now containing residual values for the multivariate model. From here, we use the <code>permutations()</code> function from <code>rsample</code> to shuffle the constituency ID column (<code>pcon19cd</code>) randomly around, generating eight permuted datasets and appending the real data (<code>apparent=TRUE</code>). This results in a new data frame where each row contains a permuted dataset, stored in a <code>list-column</code> named <code>splits</code> and labelled via an <code>id</code> column. We need to <code>map()</code> over <code>splits</code> to convert each split object into a data frame, using <code>rsample</code>’s <code>analysis()</code> function. From here, we <code>unnest()</code> to generate a dataset where each row is a constituency and its corresponding residual value (real or shuffled) for a given permutation <code>id</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">permuted_data</span> <span class="op">&lt;-</span> <span class="va">model</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    resids<span class="op">=</span><span class="fu">map</span><span class="op">(</span><span class="va">values</span>, <span class="op">~</span><span class="va">.x</span> <span class="op">|&gt;</span>  <span class="fu">select</span><span class="op">(</span><span class="va">.resid</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">values</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">unnest</span><span class="op">(</span>cols<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">data</span>,<span class="va">resids</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">pcon19cd</span>, <span class="va">.resid</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">permutations</span><span class="op">(</span>permute<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">pcon19cd</span><span class="op">)</span>, times<span class="op">=</span><span class="fl">8</span>, apparent<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>data<span class="op">=</span><span class="fu">map</span><span class="op">(</span><span class="va">splits</span>, <span class="op">~</span><span class="fu">rsample</span><span class="fu">::</span><span class="fu">analysis</span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">id</span>, <span class="va">data</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">unnest</span><span class="op">(</span>cols<span class="op">=</span><span class="va">data</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that we have the permuted dataset, the lineup can be generated straightforwardly with standard ggplot2 code:</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Store max value of residuals for setting limits in map colour scheme.</span></span>
<span><span class="va">max_resid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">permuted_data</span><span class="op">$</span><span class="va">.resid</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Store vector of permutation IDs for shuffling facets in the plots.</span></span>
<span><span class="va">ids</span> <span class="op">&lt;-</span> <span class="va">permuted_data</span> <span class="op">|&gt;</span> <span class="fu">pull</span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cons_hex</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">cons_code</span>, <span class="va">region</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">inner_join</span><span class="op">(</span><span class="va">permuted_data</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cons_code"</span><span class="op">=</span><span class="st">"pcon19cd"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>id<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">id</span>, levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">ids</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill<span class="op">=</span><span class="va">.resid</span><span class="op">)</span>, colour<span class="op">=</span><span class="st">"#636363"</span>, linewidth<span class="op">=</span><span class="fl">0.05</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span></span>
<span>    data<span class="op">=</span><span class="va">.</span> <span class="op">%&gt;%</span> <span class="fu">group_by</span><span class="op">(</span><span class="va">region</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">summarise</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    colour<span class="op">=</span><span class="st">"#636363"</span>, linewidth<span class="op">=</span><span class="fl">0.2</span>, fill<span class="op">=</span><span class="st">"transparent"</span></span>
<span>    <span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">id</span>, ncol<span class="op">=</span><span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_distiller</span><span class="op">(</span>palette<span class="op">=</span><span class="st">"RdBu"</span>, direction<span class="op">=</span><span class="fl">1</span>,</span>
<span>                       limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="va">max_resid</span>, <span class="va">max_resid</span><span class="op">)</span>, guide<span class="op">=</span><span class="st">"none"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The plot specification:</p>
<ol type="1">
<li>
<em>Data</em>: <code>inner_join</code> the permuted data on the simple features file containing the hexagon cartogram boundaries (<code>cons_hex</code>). To generate the lineup we <code>facet_wrap()</code> on the permutation <code>id</code>. By default ggplot2 will draw facets in a particular order – determined either by the numeric or alphabetical order of the facet variable’s values, or by an order determined by a factor variable. Each time we plot the lineups, we want the order in which the real and decoy plots are drawn to vary. Therefore we convert <code>id</code> to a factor variable and shuffle the levels (the ordering) around, using the <code><a href="https://rdrr.io/r/base/sample.html">sample()</a></code> function on a vector of permutation IDs (<code>ids</code>) before piping to <code>ggplot()</code>. Note that we also record the maximum absolute value of the residuals to ensure that they are coloured symmetrically on <span class="math inline">0</span> (<code>max_resid</code>). Finally, you may notice there are two <code>geom_sf()</code> calls in the plot specification. The second draws regional boundary outlines across each plot. This is achieved by collapsing the hexagon data on region (using <code>group_by()</code> and <code>summarise()</code>).</li>
<li>
<em>Encoding</em>: hexagons are filled according to the residual values (<code>fill=.resid</code>).</li>
<li>
<em>Marks</em>: <code>geom_sf()</code> for drawing the hexagon outlines. The first <code>geom_sf</code> colours each constituency on its residual value. The second does not encode any data values – notice there is no <code>aes()</code> – and is simply used to draw the region outlines.</li>
<li>
<em>Facets</em>: <code>facet_wrap()</code> on <code>region</code> in order to display coefficients estimated separately for each region.</li>
<li>
<em>Scale</em>: <code>scale_fill_distiller()</code> for ColorBrewer <span class="citation" data-cites="harrower_colorbrewerorg_2003">(<a href="a2-references.html#ref-harrower_colorbrewerorg_2003" role="doc-biblioref">Harrower and Brewer 2003</a>)</span> scheme, using the RdBu palette and with <code>limits</code> set to <code>max_resid</code>.</li>
<li>
<em>Setting</em>: The <code>linewidth</code> parameter of the hexagon outlines is varied so that the regional outlines in the second call to <code>geom_sf()</code> appear more salient. Also here, a transparent <code>fill</code> to ensure that the regional outlines do not occlude the encoded residuals.</li>
</ol>
<p> </p>
</section></section><section id="conclusion" class="level2" data-number="6.4"><h2 data-number="6.4" class="anchored" data-anchor-id="conclusion">
<span class="header-section-number">6.4</span> Conclusion</h2>
<p>This chapter demonstrated how visual and computational approaches can be used together in a somewhat more ‘traditional’ area-level regression analysis. Associations between constituency-level Leave voting in the UK’s 2016 EU Referendum and selected variables describing the demographic and socio-economic composition of constituencies were explored, with data graphics used to characterise bias in the generated models – to identify geographic and regional groupings that our early models ignore. Two classes of model update for addressing this geographic grouping were covered: those that treat geographic dependence in the values of variables as a nuisance term that is to be quantified and controlled away, and those that explicitly try to model for geographic grouping in processes. We introduced some initial techniques for dealing with both, treating geography as a categorical variable: a Fixed Effect term to assess regional dependence and Interaction term to assess regional non-stationarity. Importantly, the chapter reused some of the <code>dplyr</code> and functional programming code templates instrumental for working over models. There was a step-up in code complexity. Hopefully you will see in the next chapter that this sort of functional programming style <span class="citation" data-cites="wickham_r_2023">(<a href="a2-references.html#ref-wickham_r_2023" role="doc-biblioref">Wickham, Çetinkaya-Rundel, and Grolemund 2023</a>)</span> greatly aids the process of performing and working with resampled datasets, a key feature of modern computational data analysis.</p>
<p> </p>
</section><section id="further-reading" class="level2" data-number="6.5"><h2 data-number="6.5" class="anchored" data-anchor-id="further-reading">
<span class="header-section-number">6.5</span> Further Reading</h2>
<p>An area-level analysis of the Brexit vote:</p>
<ul>
<li>Beecham, R., Williams, N. and Comber, L. 2020. “Regionally-structured explanations behind area-level populism: An update to recent ecological analyses.” <em>PLOS One</em>, 15(3): e0229974. doi: 10.1371/journal.pone.0229974.</li>
</ul>
<p>On modelling for geographic dependence and non-stationarity:</p>
<ul>
<li><p>Comber, A., Brunsdon, C., Charlton, M. et al.&nbsp;2023. “A route map for successful applications of Geographically Weighted Regression.” <em>Geographical Analysis</em>, 55 (1): 155–178. doi: 10.1111/gean.12316.</p></li>
<li><p>Wolf, L. J. et al., 2023. “On Spatial and Platial Dependence: Examining Shrinkage in Spatially Dependent Multilevel Models.” <em>Annals of the American Association of Geographers</em>, 55(1): 1–13. doi: 10.1080/24694452.2020.1841602.</p></li>
</ul>
<p>The original graphical inference paper:</p>
<ul>
<li>Buja, A., Cook, D., Hofmann, H., Lawrence, M., Lee, E.K., Swayne, D. F. and Wickham, H. 2010. “Statistical Inference for Exploratory Data Analysis and Model Diagnostics.” <em>Royal Society Philosophical Transactions A</em>, 367:4361– 83. doi: 10.1098/rsta.2009.0120.</li>
</ul>
<p>A guide to model building in the <code>tidyverse</code>:</p>
<ul>
<li><p>Ismay, C. and Kim, A. 2020. “Statistical Inference via Data Science: A ModernDive into r and the Tidyverse”, New York, NY: <em>CRC Press</em>. doi: 10.1201/9780367409913.</p></li>
<li><p>Kuhn, M. and Silge, J. 2023. “Tidy Modelling with R.”, Sebastopol, CA: <em>O’Reilly</em>.</p></li>
</ul>
<p>A quick guide to functional programming in R and <code>tidyverse</code>:</p>
<ul>
<li>Wickham, H., Çetinkaya-Rundel, M., Grolemund, G. 2023, “R for Data Science, 2nd Edition”, Sebastopol, CA: <em>O’Reilly</em>.
<ul>
<li>Chapter 25, 26.</li>
</ul>
</li>
</ul>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-bbc_visual_2019" class="csl-entry" role="listitem">
BBC Visual and Data Journalism Team. 2019. <span>“BBC Visual and Data Journalism Cookbook for <span>R</span> Graphics.”</span> <a href="https://github.com/bbc/rcookbook" class="uri">https://github.com/bbc/rcookbook</a>.
</div>
<div id="ref-beecham_map_2017" class="csl-entry" role="listitem">
Beecham, R., J. Dykes, W. Meulemans, A. Slingsby, C. Turkay, and J. Wood. 2017. <span>“Map Line-Ups: Effects of Spatial Structure on Graphical Inference.”</span> <em>IEEE Transactions on Visualization &amp; Computer Graphics</em> 23 (1): 391–400. <a href="https://doi.org/10.1109/TVCG.2016.2598862">https://doi.org/10.1109/TVCG.2016.2598862</a>.
</div>
<div id="ref-beecham_locally-varying_2018" class="csl-entry" role="listitem">
Beecham, R., A. Slingsby, and C. Brunsdon. 2018. <span>“Locally-Varying Explanations Behind the <span>United</span> <span>Kingdom</span>’s Vote to Leave the <span>European</span> <span>Union</span>.”</span> <em>Journal of Spatial Information Science</em> 16: 117–36. <a href="https://doi.org/10.5311/josis.2018.16.377">https://doi.org/10.5311/josis.2018.16.377</a>.
</div>
<div id="ref-beecham_regionally-structured_2020" class="csl-entry" role="listitem">
Beecham, R., N. Williams, and L. Comber. 2020. <span>“Regionally-Structured Explanations Behind Area-Level Populism: <span>An</span> Update to Recent Ecological Analyses.”</span> <em>PLOS One</em> 15 (3): e0229974. <a href="https://doi.org/10.1371/journal.pone.0229974">https://doi.org/10.1371/journal.pone.0229974</a>.
</div>
<div id="ref-brunsdon_geographically_2002" class="csl-entry" role="listitem">
Brunsdon, C., M. Fortheringham, and M. Charlton. 2002. <span>“Geographically Weighted Summary Statistics: A Framework for Localised Exploratory Data Analysis.”</span> <em>Computers, Environment and Urban Systems</em> 26: 501–24. <a href="https://doi.org/10.1016/S0198-9715(01)00009-6">https://doi.org/10.1016/S0198-9715(01)00009-6</a>.
</div>
<div id="ref-buja_statistical_2009" class="csl-entry" role="listitem">
Buja, A., D. Cook, H. Hofmann, M. Lawrence, E-K Lee, D. Swayne, and H. Wickham. 2009. <span>“Statistical Inference for Exploratory Data Analysis and Model Diagnostics.”</span> <em>Philosophical Transactions of the Royal Society A: Mathematical, Physical and Engineering Sciences</em> 367 (1906): 4361–83. <a href="https://doi.org/10.1098/rsta.2009.0120">https://doi.org/10.1098/rsta.2009.0120</a>.
</div>
<div id="ref-burnmurdoch_making_2023" class="csl-entry" role="listitem">
Burn-Murdoch, J. 2023. <span>“Making Charts That Make an Impact.”</span> Invited talk, Data Visualization Society’s Outlier Conference. <a href="https://www.youtube.com/watch?v=tIbaQUo6H9g&amp;ab_channel=DataVisualizationSociety">https://www.youtube.com/watch?v=tIbaQUo6H9g&amp;ab_channel=DataVisualizationSociety</a>.
</div>
<div id="ref-comber_route_2023" class="csl-entry" role="listitem">
Comber, A., C. Brunsdon, M. Charlton, G. Dong, R. Harris, B. Lu, Y. Lü, et al. 2023. <span>“A Route Map for Successful Applications of Geographically Weighted Regression.”</span> <em>Geographical Analysis</em> 55 (1): 155–78. <a href="https://doi.org/10.1111/gean.12316">https://doi.org/10.1111/gean.12316</a>.
</div>
<div id="ref-dykes_geographically_2007" class="csl-entry" role="listitem">
Dykes, J., and C. Brunsdon. 2007. <span>“Geographically Weighted Visualization: <span>Interactive</span> Graphics for Scale-Varying Exploratory Analysis.”</span> <em>IEEE Transactions on Visualization and Computer Graphics</em> 13 (6): 1161–68. <a href="https://doi.org/10.1109/tvcg.2007.70558">https://doi.org/10.1109/tvcg.2007.70558</a>.
</div>
<div id="ref-franconeri_psychological_2022" class="csl-entry" role="listitem">
Franconeri, S. L., L. M. Padilla, P. Shah, J. M. Zacks, and J. Hullman. 2021. <span>“The Science of Visual Data Communication: What Works.”</span> <em>Psychological Science in the Public Interest</em> 22 (3): 110–61. <a href="https://doi.org/10.1177/15291006211051956%20">https://doi.org/10.1177/15291006211051956 </a>.
</div>
<div id="ref-gelman_data_2006" class="csl-entry" role="listitem">
Gelman, A., and J. Hill. 2006. <em>Data Analysis Using Regression and Multilevel/Hierarchical Models</em>. Cambridge, UK: Cambridge University Press. <a href="https://doi.org/10.1017/CBO9780511790942">https://doi.org/10.1017/CBO9780511790942</a>.
</div>
<div id="ref-gelman_regression_2020" class="csl-entry" role="listitem">
Gelman, A., J. Hill, and A. Vehtari. 2020. <em>Regression and Other Stories</em>. Analytical Methods for Social Research. Cambridge University Press. <a href="https://doi.org/10.1017/9781139161879">https://doi.org/10.1017/9781139161879</a>.
</div>
<div id="ref-hanretty_areal_2017" class="csl-entry" role="listitem">
Hanretty, C. 2017. <span>“Areal Interpolation and the <span>UK</span>’s Referendum on <span>EU</span> Membership.”</span> <em>Journal of Elections, Public Opinion and Parties</em> 37 (4): 466–83. <a href="https://doi.org/10.1080/17457289.2017.1287081">https://doi.org/10.1080/17457289.2017.1287081</a>.
</div>
<div id="ref-harrower_colorbrewerorg_2003" class="csl-entry" role="listitem">
Harrower, M., and C. A. Brewer. 2003. <span>“ColorBrewer.org: An Online Tool for Selecting Colour Schemes for Maps.”</span> <em>The Cartographic Journal</em> 40 (1): 27–37. <a href="https://doi.org/10.1179/000870403235002042">https://doi.org/10.1179/000870403235002042</a>.
</div>
<div id="ref-healy_data_2018" class="csl-entry" role="listitem">
Healy, K. 2019. <em>Data Visualization: A Practical Introduction</em>. Princeton, NJ: Princeton University Press. <a href="https://socviz.co">https://socviz.co</a>.
</div>
<div id="ref-hullman_designing_2021" class="csl-entry" role="listitem">
Hullman, J., and A. Gelman. 2021. <span>“Designing for Interactive Exploratory Data Analysis Requires Theories of Graphical Inference.”</span> <em>Harvard Data Science Review</em> 3 (3).
</div>
<div id="ref-ismay_moderndive_2020" class="csl-entry" role="listitem">
Ismay, C., and A. Kim. 2020. <em>Statistical Inference via Data Science: A <span>ModernDive</span> into <span>R</span> and the Tidyverse</em>. New York, NY: CRC Press. <a href="https://doi.org/10.1201/9780367409913">https://doi.org/10.1201/9780367409913</a>.
</div>
<div id="ref-kale_hypothetical_2019" class="csl-entry" role="listitem">
Kale, A., F. Nguyen, M. Kay, and J. Hullman. 2019. <span>“Hypothetical Outcome Plots Help Untrained Observers Judge Trends in Ambiguous Data.”</span> <em>IEEE Transactions on Visualization and Computer Graphics</em> 25 (1): 892–902. <a href="https://doi.org/10.1109/TVCG.2018.2864909">https://doi.org/10.1109/TVCG.2018.2864909</a>.
</div>
<div id="ref-kay_uncertainty_2021" class="csl-entry" role="listitem">
Kay, M. 2021. <span>“Uncertainty Visualization as a Moral Imperative.”</span> Invited talk, BostonCHI meeting. <a href="https://www.youtube.com/watch?v=mfQ3QVyw4N0&amp;ab_channel=BostonCHI">https://www.youtube.com/watch?v=mfQ3QVyw4N0&amp;ab_channel=BostonCHI</a>.
</div>
<div id="ref-kosara_lesson_2023" class="csl-entry" role="listitem">
Kosara, R. 2023. <span>“Lesson 4: Presentation, Uncertainty, ISOTYPE.”</span> ObservableHQ Notebook; ObservableHQ. <a href="https://observablehq.com/@observablehq/lesson-4-presentation-uncertainty-isotype?collection=@observablehq/advanced-data-vis-course">https://observablehq.com/@observablehq/lesson-4-presentation-uncertainty-isotype?collection=@observablehq/advanced-data-vis-course</a>.
</div>
<div id="ref-loy_model_2017" class="csl-entry" role="listitem">
Loy, A., H. Hofmann, and D. Cook. 2017. <span>“Model <span>Choice</span> and <span>Diagnostics</span> for <span>Linear</span> <span>Mixed</span>-<span>Effects</span> <span>Models</span> <span>Using</span> <span>Statistics</span> on <span>Street</span> <span>Corners</span>.”</span> <em>Journal of Computational and Graphical Statistics</em> 26 (3): 478–92. <a href="https://doi.org/10.1080/10618600.2017.1330207">https://doi.org/10.1080/10618600.2017.1330207</a>.
</div>
<div id="ref-scherer_designing_2023" class="csl-entry" role="listitem">
Scherer, C. 2023. <span>“Designing Data Visualizations to Successfully Tell a Story.”</span> Workshop at Posit::conf(2023), Chicago, IL. <a href="https://posit-conf-2023.github.io/dataviz-storytelling/">https://posit-conf-2023.github.io/dataviz-storytelling/</a>.
</div>
<div id="ref-turing_the_2025" class="csl-entry" role="listitem">
The Turing Way Community. 2025. <span>“The Turing Way: A Handbook for Reproducible, Ethical and Collaborative Research.”</span> Zenodo. <a href="https://doi.org/10.5281/zenodo.15213042">https://doi.org/10.5281/zenodo.15213042</a>.
</div>
<div id="ref-wickham_tidy_2014" class="csl-entry" role="listitem">
Wickham, H. 2014. <span>“Tidy <span>Data</span>.”</span> <em>Journal of Statistical Software</em> 59 (10): 1–23. <a href="https://doi.org/10.18637/jss.v059.i10">https://doi.org/10.18637/jss.v059.i10</a>.
</div>
<div id="ref-wickham_r_2023" class="csl-entry" role="listitem">
Wickham, H., M. Çetinkaya-Rundel, and G. Grolemund. 2023. <em>R for <span>Data</span> <span>Science</span>: <span>Import</span>, <span>Tidy</span>, <span>Transform</span>, <span>Visualize</span>, and <span>Model</span> <span>Data</span></em>. Second. Sebastopol, CA: O’Reilly Media.
</div>
<div id="ref-wickham_graphical_2010" class="csl-entry" role="listitem">
Wickham, H., D. Cook, H. Hofmann, and A. Buja. 2010. <span>“Graphical Inference for Infovis.”</span> <em>IEEE Transactions on Visualization and Computer Graphics</em> 16 (6): 973–79. <a href="https://doi.org/10.1109/TVCG.2010.161">https://doi.org/10.1109/TVCG.2010.161</a>.
</div>
<div id="ref-wolf_spatial_2021" class="csl-entry" role="listitem">
Wolf, L. J., L. Anselin, D. Arribas-Bel, and L. Rivers Mobley. 2021. <span>“On Spatial and Platial Dependence: Examining Shrinkage in Spatially Dependent Multilevel Models.”</span> <em>Annals of the American Association of Geographers</em> 111 (6): 1679–91. <a href="https://doi.org/10.1080/24694452.2020.1841602">https://doi.org/10.1080/24694452.2020.1841602</a>.
</div>
<div id="ref-yang_swaying_2024" class="csl-entry" role="listitem">
Yang, F., M. Cau, C. Mortenson, H. Fakhari, A. D. Lokmanoglu, J. Hullman, S. Franconeri, N. Diakopoulos, E. C. Nisbet, and M. Kay. 2024. <span>“Swaying the Public? Impacts of Election Forecast Visualizations on Emotion, Trust, and Intention in the 2022 <span>U.S.</span> Midterms.”</span> <em>IEEE Transactions on Visualization and Computer Graphics</em> 30 (1): 23–33. <a href="https://doi.org/10.1109/TVCG.2023.3327356">https://doi.org/10.1109/TVCG.2023.3327356</a>.
</div>
</div>
</section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p><code>https://vis4sds.github.io/vis4sds/files/06-template.qmd</code><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/vis4sds\/vis4sds");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./05-network.html" class="pagination-link" aria-label="Geographic Networks">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Geographic Networks</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./07-uncertainty.html" class="pagination-link" aria-label="Uncertainty">
        <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Uncertainty</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>